<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/uploads/images/gt.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/images/gt-32.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/images/gt-16.jpg">
  <link rel="mask-icon" href="/blog/uploads/images/logo.png" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>



<link rel="canonical" href="https://github.com/maxzhao-it/blog/page/15/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/15/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>maxzhao</title>
  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<link rel="alternate" href="/blog/atom.xml" title="maxzhao" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">maxzhao</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不要害怕Exception和Error</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-schedule"><a href="/blog/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="赵联胜"
      src="/blog/uploads/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">赵联胜</p>
  <div class="site-description" itemprop="description">小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">407</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">182</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">229</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://gitee.com/zhaoliansheng" title="GitHub → https:&#x2F;&#x2F;gitee.com&#x2F;zhaoliansheng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/blog/1441439636@qq.com" title="E-Mail → 1441439636@qq.com"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.jianshu.com/u/e8c426a6007e" title="https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;e8c426a6007e" rel="noopener" target="_blank">我的简书</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/ebede6de/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/ebede6de/" class="post-title-link" itemprop="url">安装etcd集群(含CA)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-23 17:16:30" itemprop="dateModified" datetime="2022-12-23T17:16:30+08:00">2022-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/K8S/" itemprop="url" rel="index"><span itemprop="name">K8S</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>etcd 是一个开源的分布式键值存储，用于分布式系统最关键的数据。<br>它通过将数据复制到多台机器来分布，因此对于单点故障具有很高的可用性。<br>使用 Raft 共识算法，etcd 优雅地处理网络分区和机器故障，甚至是领导者故障。<br>etcd 被广泛应用于生产环境：CoreOS、Kubernetes、YouTube Doorman 等。</p>
<p>我这里有</p>
<ul>
<li><code>192.168.2.158 etcd-158</code></li>
<li><code>192.168.2.159 etcd-159</code></li>
<li><code>192.168.2.160 etcd-160</code></li>
</ul>
<h1 id="etcd-集群指南"><a href="#etcd-集群指南" class="headerlink" title="etcd 集群指南"></a><code>etcd</code> 集群指南</h1><h2 id="CA"><a href="#CA" class="headerlink" title="CA"></a><code>CA</code></h2><p><a href="./ebede6dg">生成<code>CA</code></a></p>
<h2 id="配置时间"><a href="#配置时间" class="headerlink" title="配置时间"></a>配置时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install  ntpdate -y </span><br><span class="line">ntpdate time1.aliyun.com</span><br></pre></td></tr></table></figure>


<blockquote>
<p><a href="https://github.com/etcd-io/etcd/blob/release-3.4/Documentation/op-guide/clustering.md#static"><code>etcd GitHub</code>地址</a></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -f ~/etcd-v3.5.4-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">rm</span> -rf /opt/etcd  &amp;&amp; <span class="built_in">mkdir</span> -p /opt/etcd</span><br><span class="line">curl -L https://github.com/etcd-io/etcd/releases/download/v3.5.4/etcd-v3.5.4-linux-amd64.tar.gz  -o ~/etcd-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">tar xzvf ~/etcd-v3.5.4-linux-amd64.tar.gz -C /opt/etcd --strip-components=1</span><br><span class="line"><span class="comment"># rm -f ~/etcd-v3.5.4-linux-amd64.tar.gz</span></span><br><span class="line">/opt/etcd/etcd --version</span><br><span class="line">/opt/etcd/etcdctl version</span><br><span class="line">/opt/etcd/etcdutl version</span><br><span class="line"><span class="comment"># 将 etcd 二进制文件传到 3个master 节点</span></span><br><span class="line">scp /opt/etcd/etcd root@192.168.2.158:/usr/local/bin/</span><br><span class="line">scp /usr/local/bin/etcd root@192.168.2.159:/usr/local/bin/</span><br><span class="line">scp /usr/local/bin/etcd root@192.168.2.160:/usr/local/bin/</span><br><span class="line">scp /usr/local/bin/etcd root@192.168.2.161:/usr/local/bin/</span><br><span class="line">scp /opt/etcd/etcdctl root@192.168.2.158:/usr/local/bin/</span><br><span class="line">scp /usr/local/bin/etcdctl root@192.168.2.159:/usr/local/bin/</span><br><span class="line">scp /usr/local/bin/etcdctl root@192.168.2.160:/usr/local/bin/</span><br><span class="line">scp /usr/local/bin/etcdctl root@192.168.2.161:/usr/local/bin/</span><br><span class="line"><span class="comment"># start a local etcd server</span></span><br><span class="line"><span class="comment">#/opt/etcd/etcd</span></span><br><span class="line"><span class="comment"># write,read to etcd</span></span><br><span class="line"><span class="comment">#/opt/etcd/etcdctl --endpoints=localhost:2379 put foo bar</span></span><br><span class="line"><span class="comment">#/opt/etcd/etcdctl --endpoints=localhost:2379 get foo</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="http://play.etcd.io/install"><code>etcd example</code> 配置页面</a></p>
</blockquote>
<h2 id="cfssl-生成自签名-TLS-证书的方法"><a href="#cfssl-生成自签名-TLS-证书的方法" class="headerlink" title="cfssl 生成自签名 TLS 证书的方法"></a>cfssl 生成自签名 TLS 证书的方法</h2><p>在 <code>host158</code>上执行</p>
<h3 id="生成自签名-root-CA-证书"><a href="#生成自签名-root-CA-证书" class="headerlink" title="生成自签名 root CA 证书"></a>生成自签名 <code>root CA</code> 证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rm -f /opt/cfssl* </span></span><br><span class="line"><span class="built_in">rm</span> -rf /opt/certs </span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/certs </span><br><span class="line"><span class="built_in">cd</span>  /opt/certs </span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64  -o /usr/local/bin/cfssl</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/cfssl</span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64 -o /usr/local/bin/cfssljson</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/cfssljson</span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl-certinfo_1.5.0_linux_amd64 -o /usr/local/bin/cfssl-certinfo</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/cfssl-certinfo</span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">/usr/local/bin/cfssl version</span><br><span class="line">/usr/local/bin/cfssljson -h</span><br></pre></td></tr></table></figure>

<p>生成</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建根证书签名请求文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /opt/certs/ca-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;maxzhao-ca&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;etcd Security&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;NanJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;Jiang Su&quot;,</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;maxzhao&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># CN：Common Name：kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)，</span></span><br><span class="line"><span class="comment"># O：Organization：kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</span></span><br><span class="line"><span class="comment"># kube-apiserver 将提取的 User、Group 作为 RBAC 授权的用户标识； </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 证书配置文件</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /opt/certs/ca-config.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;signing&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">          &quot;signing&quot;,</span></span><br><span class="line"><span class="string">          &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">          &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">          &quot;client auth&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;expiry&quot;: &quot;175200h&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;profiles&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;kubernetes&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">          &quot;signing&quot;,</span></span><br><span class="line"><span class="string">          &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">          &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">          &quot;client auth&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;expiry&quot;: &quot;175200h&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;etcd&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">          &quot;signing&quot;,</span></span><br><span class="line"><span class="string">          &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">          &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">          &quot;client auth&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;expiry&quot;: &quot;175200h&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># signing：表示该证书可用于签名其它证书（生成的 ca.pem 证书中 CA=TRUE）；</span></span><br><span class="line"><span class="comment"># server auth：表示 client 可以用该该证书对 server 提供的证书进行验证；</span></span><br><span class="line"><span class="comment"># client auth：表示 server 可以用该该证书对 client 提供的证书进行验证；</span></span><br><span class="line"><span class="comment"># &quot;expiry&quot;: &quot;175200h&quot; 有效期20年</span></span><br></pre></td></tr></table></figure>

<p>生成<code>ca</code> 证书和私钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成</span></span><br><span class="line">cfssl gencert --initca /opt/certs/ca-csr.json | cfssljson --bare /opt/certs/ca</span><br><span class="line"></span><br><span class="line"><span class="comment"># verify</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> /opt/certs/ca.pem -text -noout</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CSR configuration</span></span><br><span class="line">/opt/certs/ca-csr.json</span><br><span class="line"><span class="comment"># CSR 双向认证</span></span><br><span class="line">/opt/certs/ca.csr</span><br><span class="line"><span class="comment"># self-signed root CA public key  其它文档里会叫 ca.crt</span></span><br><span class="line">/opt/certs/ca.pem</span><br><span class="line"><span class="comment"># self-signed root CA private key</span></span><br><span class="line">/opt/certs/ca-key.pem</span><br><span class="line"><span class="comment">#  证书配置文件 for other TLS assets</span></span><br><span class="line">/opt/certs/ca-config.json</span><br></pre></td></tr></table></figure>

<h3 id="使用私钥生成本地颁发的证书"><a href="#使用私钥生成本地颁发的证书" class="headerlink" title="使用私钥生成本地颁发的证书"></a>使用私钥生成本地颁发的证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># peer </span></span><br><span class="line"><span class="built_in">cat</span> &gt; /opt/certs/etcd-158-ca-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;maxzhao-ca&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;etcd Security&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;NanJing&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;Jiang Su&quot;,</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;etcd-158&quot;,</span></span><br><span class="line"><span class="string">  &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">    &quot;127.0.0.1&quot;,</span></span><br><span class="line"><span class="string">    &quot;192.168.2.158&quot;,</span></span><br><span class="line"><span class="string">    &quot;192.168.2.159&quot;,</span></span><br><span class="line"><span class="string">    &quot;192.168.2.160&quot;,</span></span><br><span class="line"><span class="string">    &quot;192.168.2.161&quot;,</span></span><br><span class="line"><span class="string">    &quot;kubernetes&quot;,</span></span><br><span class="line"><span class="string">    &quot;kubernetes.default&quot;,</span></span><br><span class="line"><span class="string">    &quot;kubernetes.default.svc&quot;,</span></span><br><span class="line"><span class="string">    &quot;kubernetes.default.svc.cluster&quot;,</span></span><br><span class="line"><span class="string">    &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 生成etcd用的证书文件 peer</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">  --ca /opt/certs/ca.pem \</span><br><span class="line">  --ca-key /opt/certs/ca-key.pem \</span><br><span class="line">  --config /opt/certs/ca-config.json \</span><br><span class="line">  -profile=etcd \</span><br><span class="line">  /opt/certs/etcd-158-ca-csr.json | cfssljson --bare /opt/certs/etcd-158</span><br><span class="line"><span class="comment">#   --profile=k8s-server-client  表示客户端与服务端要双向通讯</span></span><br><span class="line"><span class="comment"># verify</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> /opt/certs/etcd-158.pem -text -noout</span><br></pre></td></tr></table></figure>

<h3 id="生成之后"><a href="#生成之后" class="headerlink" title="生成之后"></a>生成之后</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 传输到每一个节点</span></span><br><span class="line"><span class="built_in">rm</span> -rf /etc/certs/etcd</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/certs/etcd</span><br><span class="line">\<span class="built_in">cp</span> /opt/certs/ca.pem /etc/certs/etcd/ca.pem</span><br><span class="line">\<span class="built_in">cp</span> /opt/certs/etcd-158-key.pem /etc/certs/etcd/etcd-158-key.pem</span><br><span class="line">\<span class="built_in">cp</span> /opt/certs/etcd-158.pem /etc/certs/etcd/etcd-158.pem</span><br><span class="line"><span class="comment"># 拷贝 ca.pem, etcd-158.pem, etcd-158-key.pem</span></span><br><span class="line">ssh root@192.168.2.159 <span class="string">&quot;mkdir -p /etc/certs/etcd&quot;</span></span><br><span class="line">ssh root@192.168.2.160 <span class="string">&quot;mkdir -p /etc/certs/etcd&quot;</span></span><br><span class="line">ssh root@192.168.2.161 <span class="string">&quot;mkdir -p /etc/certs/etcd&quot;</span></span><br><span class="line">scp -r /etc/certs/etcd/* root@192.168.2.159:/etc/certs/etcd/</span><br><span class="line">scp -r /etc/certs/etcd/* root@192.168.2.160:/etc/certs/etcd/</span><br><span class="line">scp -r /etc/certs/etcd/* root@192.168.2.161:/etc/certs/etcd/</span><br></pre></td></tr></table></figure>

<h2 id="创建用户和组"><a href="#创建用户和组" class="headerlink" title="创建用户和组"></a>创建用户和组</h2><p>在 <code>host158</code>上执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd etcd &amp;&amp; useradd -g etcd etcd &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;1&#x27;</span> | passwd --stdin etcd</span><br><span class="line">ssh root@192.168.2.159 <span class="string">&quot;groupadd etcd &amp;&amp; useradd -g etcd etcd &amp;&amp; echo &#x27;1&#x27; | passwd --stdin etcd&quot;</span></span><br><span class="line">ssh root@192.168.2.160 <span class="string">&quot;groupadd etcd &amp;&amp; useradd -g etcd etcd &amp;&amp; echo &#x27;1&#x27; | passwd --stdin etcd&quot;</span>  </span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><h3 id="host158"><a href="#host158" class="headerlink" title="host158"></a><code>host158</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /opt/etcd/etcd-158</span><br><span class="line"><span class="built_in">mkdir</span> /opt/etcd/etcd-158</span><br><span class="line">/usr/local/bin/etcd --name etcd-158 \</span><br><span class="line">  --data-dir /opt/etcd/etcd_data-158 \</span><br><span class="line">  <span class="comment"># 对外提供服务的地址，通常为本机节点。使用域名无效</span></span><br><span class="line">  --listen-client-urls https://192.168.2.158:2379 \</span><br><span class="line">  <span class="comment"># 节点成员客户端url列表，对外公告此节点客户端监听地址，可以使用域名</span></span><br><span class="line">  --advertise-client-urls https://192.168.2.158:2379 \</span><br><span class="line">  <span class="comment"># 和其它成员节点间通信地址，每个节点不同，必须使用IP，使用域名无效</span></span><br><span class="line">  --listen-peer-urls https://192.168.2.158:2380 \</span><br><span class="line">  <span class="comment"># 节点监听地址，并会通告集群其它节点</span></span><br><span class="line">  --initial-advertise-peer-urls https://192.168.2.158:2380 \</span><br><span class="line">  <span class="comment"># 集群中所有节点信息，格式为：节点名称+监听的本地端口</span></span><br><span class="line">  --initial-cluster etcd-158=https://192.168.2.158:2380,etcd-159=https://192.168.2.159:2380,etcd-160=https://192.168.2.160:2380 \</span><br><span class="line">  --initial-cluster-token etcd-k8s-158 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file /etc/certs/etcd/ca.pem \</span><br><span class="line">  --cert-file /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --key-file /etc/certs/etcd/etcd-158-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file /etc/certs/etcd/ca.pem \</span><br><span class="line">  --peer-cert-file /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --peer-key-file /etc/certs/etcd/etcd-158-key.pem</span><br></pre></td></tr></table></figure>

<h3 id="host159"><a href="#host159" class="headerlink" title="host159"></a><code>host159</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /opt/etcd/etcd-159</span><br><span class="line"><span class="built_in">mkdir</span> /opt/etcd/etcd-159</span><br><span class="line">/opt/etcd/etcd --name etcd-159 \</span><br><span class="line">  --data-dir /opt/etcd/etcd_data-159 \</span><br><span class="line">  --listen-client-urls https://192.168.2.159:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.2.159:2379 \</span><br><span class="line">  --listen-peer-urls https://192.168.2.159:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://192.168.2.159:2380 \</span><br><span class="line">  --initial-cluster etcd-158=https://192.168.2.158:2380,etcd-159=https://192.168.2.159:2380,etcd-160=https://192.168.2.160:2380 \</span><br><span class="line">  --initial-cluster-token etcd-k8s-158 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file /etc/certs/etcd/ca.pem \</span><br><span class="line">  --cert-file /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --key-file /etc/certs/etcd/etcd-158-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file /etc/certs/etcd/ca.pem \</span><br><span class="line">  --peer-cert-file /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --peer-key-file /etc/certs/etcd/etcd-158-key.pem</span><br></pre></td></tr></table></figure>

<h3 id="host160"><a href="#host160" class="headerlink" title="host160"></a><code>host160</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /opt/etcd/etcd-160</span><br><span class="line"><span class="built_in">mkdir</span> /opt/etcd/etcd-160</span><br><span class="line">/opt/etcd/etcd --name etcd-160 \</span><br><span class="line">  --data-dir /opt/etcd/etcd_data-160 \</span><br><span class="line">  --listen-client-urls https://192.168.2.160:2379 \</span><br><span class="line">  --advertise-client-urls https://192.168.2.160:2379 \</span><br><span class="line">  --listen-peer-urls https://192.168.2.160:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://192.168.2.160:2380 \</span><br><span class="line">  --initial-cluster etcd-158=https://192.168.2.158:2380,etcd-159=https://192.168.2.159:2380,etcd-160=https://192.168.2.160:2380 \</span><br><span class="line">  --initial-cluster-token etcd-k8s-158 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file /etc/certs/etcd/ca.pem \</span><br><span class="line">  --cert-file /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --key-file /etc/certs/etcd/etcd-158-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file /etc/certs/etcd/ca.pem \</span><br><span class="line">  --peer-cert-file /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --peer-key-file /etc/certs/etcd/etcd-158-key.pem</span><br></pre></td></tr></table></figure>

<h3 id="校验运行状态"><a href="#校验运行状态" class="headerlink" title="校验运行状态"></a>校验运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 /opt/etcd/etcdctl \</span><br><span class="line">  --endpoints 192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379 \</span><br><span class="line">  --cacert /etc/certs/etcd/ca.pem \</span><br><span class="line">  --cert /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --key /etc/certs/etcd/etcd-158-key.pem \</span><br><span class="line">  endpoint health</span><br></pre></td></tr></table></figure>

<h2 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h2><blockquote>
<p>注意：三个节点配置结束后，服务才会启动成功</p>
</blockquote>
<h3 id="host158-1"><a href="#host158-1" class="headerlink" title="host158"></a><code>host158</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /opt/etcd/etcd</span><br><span class="line"><span class="built_in">mkdir</span> /opt/etcd/etcd</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/etcd.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=etcd</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">Conflicts=etcd.service</span></span><br><span class="line"><span class="string">Conflicts=etcd2.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=5s</span></span><br><span class="line"><span class="string">LimitNOFILE=40000</span></span><br><span class="line"><span class="string">TimeoutStartSec=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd --name etcd-158 \</span></span><br><span class="line"><span class="string">  --data-dir /opt/etcd/etcd_data \</span></span><br><span class="line"><span class="string">  --listen-client-urls https://192.168.2.158:2379 \</span></span><br><span class="line"><span class="string">  --advertise-client-urls https://192.168.2.158:2379 \</span></span><br><span class="line"><span class="string">  --listen-peer-urls https://192.168.2.158:2380 \</span></span><br><span class="line"><span class="string">  --initial-advertise-peer-urls https://192.168.2.158:2380 \</span></span><br><span class="line"><span class="string">  --initial-cluster etcd-158=https://192.168.2.158:2380,etcd-159=https://192.168.2.159:2380,etcd-160=https://192.168.2.160:2380 \</span></span><br><span class="line"><span class="string">  --initial-cluster-token etcd-k8s-158 \</span></span><br><span class="line"><span class="string">  --initial-cluster-state new \</span></span><br><span class="line"><span class="string">  --client-cert-auth \</span></span><br><span class="line"><span class="string">  --trusted-ca-file /etc/certs/etcd/ca.pem \</span></span><br><span class="line"><span class="string">  --cert-file /etc/certs/etcd/etcd-158.pem \</span></span><br><span class="line"><span class="string">  --key-file /etc/certs/etcd/etcd-158-key.pem \</span></span><br><span class="line"><span class="string">  --peer-client-cert-auth \</span></span><br><span class="line"><span class="string">  --peer-trusted-ca-file /etc/certs/etcd/ca.pem \</span></span><br><span class="line"><span class="string">  --peer-cert-file /etc/certs/etcd/etcd-158.pem \</span></span><br><span class="line"><span class="string">  --peer-key-file /etc/certs/etcd/etcd-158-key.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># to start service</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line"><span class="comment">#sudo systemctl cat etcd.service</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> etcd.service</span><br><span class="line">sudo systemctl start etcd.service</span><br><span class="line">sudo systemctl status etcd.service</span><br></pre></td></tr></table></figure>

<h3 id="host159-1"><a href="#host159-1" class="headerlink" title="host159"></a><code>host159</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /opt/etcd/etcd</span><br><span class="line"><span class="built_in">mkdir</span> /opt/etcd/etcd</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/etcd.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=etcd</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">Conflicts=etcd.service</span></span><br><span class="line"><span class="string">Conflicts=etcd2.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=5s</span></span><br><span class="line"><span class="string">LimitNOFILE=40000</span></span><br><span class="line"><span class="string">TimeoutStartSec=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd --name etcd-159 \</span></span><br><span class="line"><span class="string">  --data-dir /opt/etcd/etcd_data \</span></span><br><span class="line"><span class="string">  --listen-client-urls https://192.168.2.159:2379 \</span></span><br><span class="line"><span class="string">  --advertise-client-urls https://192.168.2.159:2379 \</span></span><br><span class="line"><span class="string">  --listen-peer-urls https://192.168.2.159:2380 \</span></span><br><span class="line"><span class="string">  --initial-advertise-peer-urls https://192.168.2.159:2380 \</span></span><br><span class="line"><span class="string">  --initial-cluster etcd-158=https://192.168.2.158:2380,etcd-159=https://192.168.2.159:2380,etcd-160=https://192.168.2.160:2380 \</span></span><br><span class="line"><span class="string">  --initial-cluster-token etcd-k8s-158 \</span></span><br><span class="line"><span class="string">  --initial-cluster-state new \</span></span><br><span class="line"><span class="string">  --client-cert-auth \</span></span><br><span class="line"><span class="string">  --trusted-ca-file /etc/certs/etcd/ca.pem \</span></span><br><span class="line"><span class="string">  --cert-file /etc/certs/etcd/etcd-158.pem \</span></span><br><span class="line"><span class="string">  --key-file /etc/certs/etcd/etcd-158-key.pem \</span></span><br><span class="line"><span class="string">  --peer-client-cert-auth \</span></span><br><span class="line"><span class="string">  --peer-trusted-ca-file /etc/certs/etcd/ca.pem \</span></span><br><span class="line"><span class="string">  --peer-cert-file /etc/certs/etcd/etcd-158.pem \</span></span><br><span class="line"><span class="string">  --peer-key-file /etc/certs/etcd/etcd-158-key.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># to start service</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line"><span class="comment">#sudo systemctl cat etcd.service</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> etcd.service</span><br><span class="line">sudo systemctl start etcd.service</span><br><span class="line">sudo systemctl status etcd.service</span><br></pre></td></tr></table></figure>



<h3 id="host160-1"><a href="#host160-1" class="headerlink" title="host160"></a><code>host160</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /opt/etcd/etcd</span><br><span class="line"><span class="built_in">mkdir</span> /opt/etcd/etcd</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/etcd.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=etcd</span></span><br><span class="line"><span class="string">Documentation=https://github.com/coreos/etcd</span></span><br><span class="line"><span class="string">Conflicts=etcd.service</span></span><br><span class="line"><span class="string">Conflicts=etcd2.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=5s</span></span><br><span class="line"><span class="string">LimitNOFILE=40000</span></span><br><span class="line"><span class="string">TimeoutStartSec=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd --name etcd-160 \</span></span><br><span class="line"><span class="string">  --data-dir /opt/etcd/etcd_data \</span></span><br><span class="line"><span class="string">  --listen-client-urls https://192.168.2.160:2379 \</span></span><br><span class="line"><span class="string">  --advertise-client-urls https://192.168.2.160:2379 \</span></span><br><span class="line"><span class="string">  --listen-peer-urls https://192.168.2.160:2380 \</span></span><br><span class="line"><span class="string">  --initial-advertise-peer-urls https://192.168.2.160:2380 \</span></span><br><span class="line"><span class="string">  --initial-cluster etcd-158=https://192.168.2.158:2380,etcd-159=https://192.168.2.159:2380,etcd-160=https://192.168.2.160:2380 \</span></span><br><span class="line"><span class="string">  --initial-cluster-token etcd-k8s-158 \</span></span><br><span class="line"><span class="string">  --initial-cluster-state new \</span></span><br><span class="line"><span class="string">  --client-cert-auth \</span></span><br><span class="line"><span class="string">  --trusted-ca-file /etc/certs/etcd/ca.pem \</span></span><br><span class="line"><span class="string">  --cert-file /etc/certs/etcd/etcd-158.pem \</span></span><br><span class="line"><span class="string">  --key-file /etc/certs/etcd/etcd-158-key.pem \</span></span><br><span class="line"><span class="string">  --peer-client-cert-auth \</span></span><br><span class="line"><span class="string">  --peer-trusted-ca-file /etc/certs/etcd/ca.pem \</span></span><br><span class="line"><span class="string">  --peer-cert-file /etc/certs/etcd/etcd-158.pem \</span></span><br><span class="line"><span class="string">  --peer-key-file /etc/certs/etcd/etcd-158-key.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># to start service</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line"><span class="comment">#sudo systemctl cat etcd.service</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> etcd.service</span><br><span class="line">sudo systemctl start etcd.service</span><br><span class="line">sudo systemctl status etcd.service</span><br></pre></td></tr></table></figure>

<h3 id="校验运行状态-1"><a href="#校验运行状态-1" class="headerlink" title="校验运行状态"></a>校验运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># to get logs from service</span></span><br><span class="line">sudo systemctl status etcd.service -l --no-pager</span><br><span class="line">sudo journalctl -u etcd.service -l --no-pager|less</span><br><span class="line">sudo journalctl -f -u etcd.service</span><br><span class="line">sudo journalctl -xe  -u etcd.service</span><br><span class="line"><span class="comment"># to stop service</span></span><br><span class="line">sudo systemctl stop etcd.service</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> etcd.service</span><br><span class="line"></span><br><span class="line">ETCDCTL_API=3 /opt/etcd/etcdctl \</span><br><span class="line">  --endpoints 192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379 \</span><br><span class="line">  --cacert /etc/certs/etcd/ca.pem \</span><br><span class="line">  --cert /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --key /etc/certs/etcd/etcd-158-key.pem \</span><br><span class="line">  endpoint health</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220529234008606.png" alt="image-20220529234008606"></p>
<h3 id="查看成员"><a href="#查看成员" class="headerlink" title="查看成员"></a>查看成员</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ENDPOINTS=192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379</span><br><span class="line">ETCD_AUTH=<span class="string">&#x27;--cacert /etc/certs/etcd/ca.pem --cert /etc/certs/etcd/etcd-158.pem --key /etc/certs/etcd/etcd-158-key.pem &#x27;</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> member list </span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> member list</span><br></pre></td></tr></table></figure>



<h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">ENDPOINTS=192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379</span><br><span class="line">ETCD_AUTH=<span class="string">&#x27;--cacert /etc/certs/etcd/ca.pem --cert /etc/certs/etcd/etcd-158.pem --key /etc/certs/etcd/etcd-158-key.pem &#x27;</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> role add root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> role get root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> user add root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> user grant-role root root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> user get root</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> auth <span class="built_in">enable</span></span><br><span class="line"><span class="comment"># 错误的</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> user list</span><br><span class="line"><span class="comment"># 正确的</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 user list</span><br><span class="line"></span><br><span class="line"><span class="comment"># now all client requests go through auth</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 put foo bar</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 get foo</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 --write-out=<span class="string">&quot;json&quot;</span> get foo</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 put foo1 bar</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 put foo2 bar</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 get fo --prefix</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 del foo1 --prefix</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 get foo</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 get foo1</span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 auth <span class="built_in">disable</span></span><br></pre></td></tr></table></figure>

<h2 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h2><blockquote>
<p>注意：需要添加 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">ENDPOINTS=192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379</span><br><span class="line">  --endpoints <span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span></span><br><span class="line">  --cacert /etc/certs/etcd/ca.pem \</span><br><span class="line">  --cert /etc/certs/etcd/etcd-158.pem \</span><br><span class="line">  --key /etc/certs/etcd/etcd-158-key.pem \</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="添加-key-value"><a href="#添加-key-value" class="headerlink" title="添加 key-value"></a>添加 <code>key-value</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">ENDPOINTS=192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> put foo <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> get foo</span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --write-out=<span class="string">&quot;json&quot;</span> get foo</span><br></pre></td></tr></table></figure>

<h3 id="通过前缀获取密钥"><a href="#通过前缀获取密钥" class="headerlink" title="通过前缀获取密钥"></a>通过前缀获取密钥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put web1 value1</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put web2 value2</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put web3 value3</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; get web --prefix</span><br></pre></td></tr></table></figure>

<h3 id="事务中多次写入"><a href="#事务中多次写入" class="headerlink" title="事务中多次写入"></a>事务中多次写入</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put user1 bad</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; txn --interactive</span><br><span class="line"></span><br><span class="line">compares:</span><br><span class="line">value(&quot;user1&quot;) = &quot;bad&quot;</span><br><span class="line"></span><br><span class="line">success requests (get, put, delete):</span><br><span class="line">del user1</span><br><span class="line"></span><br><span class="line">failure requests (get, put, delete):</span><br><span class="line">put user1 good</span><br></pre></td></tr></table></figure>

<h3 id="查看-keys"><a href="#查看-keys" class="headerlink" title="查看 keys"></a>查看 <code>keys</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; watch stock1</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put stock1 1000</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; watch stock --prefix</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put stock1 10</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put stock2 20</span><br></pre></td></tr></table></figure>

<h3 id="创建-lease"><a href="#创建-lease" class="headerlink" title="创建 lease"></a>创建 <code>lease</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; lease grant 300</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lease 2be7547fbc6a5afa granted with TTL(300s)</span></span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; put sample value --lease=2be7547fbc6a5afa</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; get sample</span><br><span class="line"></span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; lease keep-alive 2be7547fbc6a5afa</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; lease revoke 2be7547fbc6a5afa</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or after 300 seconds</span></span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; get sample</span><br></pre></td></tr></table></figure>

<h3 id="创建-locks"><a href="#创建-locks" class="headerlink" title="创建 locks"></a>创建 <code>locks</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; lock mutex1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">another client with the same name blocks</span></span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; lock mutex1</span><br></pre></td></tr></table></figure>

<h3 id="etcd集群中如何进行leader选举"><a href="#etcd集群中如何进行leader选举" class="headerlink" title="etcd集群中如何进行leader选举"></a><code>etcd</code>集群中如何进行<code>leader</code>选举</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; elect one p1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">another client with the same name blocks</span></span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; elect one p2</span><br></pre></td></tr></table></figure>

<h3 id="校验运行状态-2"><a href="#校验运行状态-2" class="headerlink" title="校验运行状态"></a>校验运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> endpoint health</span><br><span class="line">etcdctl --write-out=table --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> endpoint status</span><br></pre></td></tr></table></figure>

<h3 id="保存数据库"><a href="#保存数据库" class="headerlink" title="保存数据库"></a>保存数据库</h3><p>Snapshot can only be requested from one etcd node, so <code>--endpoints</code> flag should contain only one endpoint.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ENDPOINTS=192.168.2.158:2379</span><br><span class="line">etcdctl --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; snapshot save my.db</span><br><span class="line"></span><br><span class="line">Snapshot saved at my.db</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --write-out=table --endpoints=$&#123;ENDPOINTS&#125; $&#123;ETCD_AUTH&#125; snapshot status my.db</span><br><span class="line"></span><br><span class="line">+---------+----------+------------+------------+</span><br><span class="line">|  HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |</span><br><span class="line">+---------+----------+------------+------------+</span><br><span class="line">| c55e8b8 |        9 |         13 | 25 kB      |</span><br><span class="line">+---------+----------+------------+------------+</span><br></pre></td></tr></table></figure>

<h3 id="添加和删除节点"><a href="#添加和删除节点" class="headerlink" title="添加和删除节点"></a>添加和删除节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">ENDPOINTS=192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379</span><br><span class="line"><span class="comment"># get member ID</span></span><br><span class="line">etcdctl --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> member list</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove the member</span></span><br><span class="line">MEMBER_ID=278c654c9a6dfd3b</span><br><span class="line">etcdctl --endpoints=--endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> \</span><br><span class="line">	member remove <span class="variable">$&#123;MEMBER_ID&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add a new member (node 4)</span></span><br><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line"><span class="comment"># new member</span></span><br><span class="line">etcdctl --endpoints=192.168.2.158:2379,192.168.2.159:2379  \</span><br><span class="line">	member add etcd-161 \</span><br><span class="line">	--peer-urls=http://192.168.2.161:2380</span><br></pre></td></tr></table></figure>

<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><h2 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h2><p>对于 ETCD 集群，建议在集群中提供奇数个节点，下表显示了不同的节点数量时 ETCD 集群可以容忍的错误节点数量：</p>
<table>
<thead>
<tr>
<th>集群节点数</th>
<th>Majority</th>
<th>最大容错数</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>6</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td>4</td>
<td>3</td>
</tr>
<tr>
<td>8</td>
<td>4</td>
<td>3</td>
</tr>
<tr>
<td>9</td>
<td>5</td>
<td>4</td>
</tr>
</tbody></table>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/ebede6de/">https://github.com/maxzhao-it/blog/post/ebede6de/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/ac3f2297/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/ac3f2297/" class="post-title-link" itemprop="url">夜莺</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-01-09 17:43:17" itemprop="dateModified" datetime="2023-01-09T17:43:17+08:00">2023-01-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%9C%E8%8E%BA/" itemprop="url" rel="index"><span itemprop="name">夜莺</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd yy</span><br></pre></td></tr></table></figure>



<h2 id="prometheus-安装："><a href="#prometheus-安装：" class="headerlink" title="prometheus  安装："></a><code>prometheus</code>  安装：</h2><blockquote>
<p><a href="https://github.com/prometheus/prometheus/releases/download/v2.36.2/prometheus-2.36.2.windows-amd64.zip">prometheus-2.36.2.windows-amd64.zip</a><br><a href="https://github.com/prometheus/prometheus/releases/download/v2.36.2/prometheus-2.36.2.linux-amd64.tar.gz">prometheus-2.36.2.linux-amd64.tar.gz</a><br><a href="https://github.com/prometheus/prometheus/releases/download/v2.36.2/prometheus-web-ui-2.36.2.tar.gz">prometheus-web-ui-2.36.2.tar.gz</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/tools </span><br><span class="line">cd ~/tools</span><br><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.36.2/prometheus-2.36.2.linux-amd64.tar.gz</span><br><span class="line">tar xfz ~/tools/prometheus-2.36.2.linux-amd64.tar.gz -C ~/</span><br><span class="line">cd ~/</span><br><span class="line">mv prometheus-2.36.2.linux-amd64 prometheus</span><br><span class="line">cd prometheus</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>不用修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> ~/prometheus/prometheus.yml ~/prometheus/prometheus.yml-bak</span><br><span class="line"><span class="built_in">cat</span> ~/prometheus/prometheus.yml</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">n9e_home=/home/yy/prometheus</span><br><span class="line"><span class="built_in">nohup</span> <span class="variable">$&#123;n9e_home&#125;</span>/prometheus  --config.file=<span class="variable">$&#123;n9e_home&#125;</span>/prometheus.yml --storage.tsdb.path=<span class="variable">$&#123;n9e_home&#125;</span>/data --web.enable-lifecycle --enable-feature=remote-write-receiver --query.lookback-delta=2m &amp;</span><br></pre></td></tr></table></figure>

<h2 id="夜莺"><a href="#夜莺" class="headerlink" title="夜莺"></a>夜莺</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/tools </span><br><span class="line"><span class="built_in">cd</span> ~/tools</span><br><span class="line">wget https://github.com/ccfos/nightingale/releases/download/v5.12.0/n9e-v5.12.0-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">mkdir</span> ~/n9e</span><br><span class="line">tar zxf ~/tools/n9e-v5.12.0-linux-amd64.tar.gz -C ~/n9e/</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/n9e/fe-v5/releases/download/v5.6.0/n9e-fe-5.6.0.tar.gz">n9e-fe-5.6.0.tar.gz</a><br><a href="https://github.com/ccfos/nightingale/releases/download/v5.12.0/n9e-v5.12.0-linux-amd64.tar.gz">n9e-v5.12.0-linux-amd64.tar.gz</a></p>
</blockquote>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 需要配置其中的 Redis 与 DB</span><br><span class="line">~/n9e/etc/server.conf</span><br><span class="line">~/n9e/etc/webapi.conf</span><br></pre></td></tr></table></figure>

<h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<p>最后加入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*       soft    nproc   65535</span><br><span class="line">*       hard    nproc   65535</span><br><span class="line">*       soft    nofile  65535</span><br><span class="line">*       hard    nofile  65535</span><br></pre></td></tr></table></figure>

<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/yy/n9e</span><br><span class="line"><span class="built_in">nohup</span> /home/yy/n9e/n9e server &amp;&gt; server.log &amp;</span><br><span class="line"><span class="built_in">nohup</span> /home/yy/n9e/n9e webapi &amp;&gt; webapi.log &amp;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://127.0.0.1:18000/">http://127.0.0.1:18000</a></p>
<p><code>root/root.2020</code></p>
<h2 id="采集器：Telegraf"><a href="#采集器：Telegraf" class="headerlink" title="采集器：Telegraf"></a>采集器：<code>Telegraf</code></h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><a target="_blank" rel="noopener" href="https://portal.influxdata.com/downloads/">官网</a>：<a href="https://github.com/influxdata/telegraf/releases">下载地址</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/tools &amp;&amp; <span class="built_in">cd</span> ~/tools</span><br><span class="line">version=1.24.1</span><br><span class="line">tarball=telegraf-<span class="variable">$&#123;version&#125;</span>_linux_amd64.tar.gz</span><br><span class="line">wget https://dl.influxdata.com/telegraf/releases/<span class="variable">$&#123;tarball&#125;</span></span><br><span class="line">tar xzvf <span class="variable">$tarball</span> </span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$tarball</span> ~/ &amp;&amp; <span class="built_in">cd</span> ~/</span><br><span class="line"><span class="built_in">mv</span> telegraf-<span class="variable">$&#123;version&#125;</span> telegraf</span><br></pre></td></tr></table></figure>

<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><p><a href="https://github.com/influxdata/telegraf/blob/master/etc/telegraf.conf">全部配置参考</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> ~/telegraf/etc/telegraf/telegraf.conf  ~/telegraf/etc/telegraf/telegraf.conf-bak</span><br></pre></td></tr></table></figure>

<p>修改配置项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;~/telegraf/etc/telegraf/telegraf.conf</span><br><span class="line">[global_tags]</span><br><span class="line">  # user = &quot;$USER&quot;</span><br><span class="line">[agent]</span><br><span class="line">  interval = &quot;10s&quot;</span><br><span class="line">  round_interval = true</span><br><span class="line">  metric_batch_size = 1000</span><br><span class="line">  metric_buffer_limit = 10000</span><br><span class="line">  collection_jitter = &quot;0s&quot;</span><br><span class="line">  flush_interval = &quot;10s&quot; </span><br><span class="line">  flush_jitter = &quot;0s&quot;  </span><br><span class="line">  precision = &quot;0s&quot;</span><br><span class="line">  #当前节点IP</span><br><span class="line">  hostname = &quot;192.168.14.122&quot;</span><br><span class="line">  omit_hostname = false</span><br><span class="line">#                            OUTPUT PLUGINS                                   #</span><br><span class="line">[[outputs.opentsdb]]</span><br><span class="line"># 监控服务IP</span><br><span class="line">  host = &quot;http://192.168.14.122&quot;</span><br><span class="line">  #监控服务端口</span><br><span class="line">  port = 19000</span><br><span class="line">  http_batch_size = 50</span><br><span class="line">  http_path = &quot;/opentsdb/put&quot;</span><br><span class="line">  debug = false</span><br><span class="line">  separator = &quot;_&quot;</span><br><span class="line">#                            INPUT PLUGINS                                    #</span><br><span class="line">[[inputs.cpu]]</span><br><span class="line">  percpu = true</span><br><span class="line">  totalcpu = true</span><br><span class="line">  collect_cpu_time = false</span><br><span class="line">  report_active = true</span><br><span class="line">  core_tags = false</span><br><span class="line">[[inputs.disk]]</span><br><span class="line">  ignore_fs = [&quot;tmpfs&quot;, &quot;devtmpfs&quot;, &quot;devfs&quot;, &quot;iso9660&quot;, &quot;overlay&quot;, &quot;aufs&quot;, &quot;squashfs&quot;]</span><br><span class="line">[[inputs.diskio]]</span><br><span class="line">[[inputs.kernel]]</span><br><span class="line">[[inputs.mem]]</span><br><span class="line">[[inputs.processes]]</span><br><span class="line">[[inputs.swap]]</span><br><span class="line">[[inputs.system]]</span><br><span class="line">  fielddrop = [&quot;uptime_format&quot;]</span><br><span class="line">[[inputs.net]]</span><br><span class="line">  ignore_protocol_stats = true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ~/telegraf/usr/bin/telegraf --config ~/telegraf/etc/telegraf/telegraf.conf &amp;&gt; telegraf.log &amp;</span><br></pre></td></tr></table></figure>

<h2 id="采集器：Cetegraf"><a href="#采集器：Cetegraf" class="headerlink" title="采集器：Cetegraf"></a>采集器：Cetegraf</h2><p><a href="https://github.com/flashcatcloud/categraf/blob/main/README.md">文档</a></p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p><a href="https://github.com/flashcatcloud/categraf">categraf-v0.2.13-linux-amd64.tar.gz</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/</span><br><span class="line"><span class="built_in">mkdir</span> package</span><br><span class="line"><span class="built_in">cd</span> package </span><br><span class="line">wget https://github.com/flashcatcloud/categraf/releases/download/v0.2.13/categraf-v0.2.13-linux-amd64.tar.gz</span><br><span class="line">tar -zxf categraf-v0.2.13-linux-amd64.tar.gz -C ../</span><br><span class="line"><span class="built_in">cd</span> ~/</span><br><span class="line"><span class="built_in">mv</span> categraf-v0.2.13-linux-amd64 categraf</span><br></pre></td></tr></table></figure>

<h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/categraf/conf/config.toml</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[writer_opt]</span><br><span class="line"># default: 2000</span><br><span class="line">batch = 2000</span><br><span class="line"># channel(as queue) size</span><br><span class="line">chan_size = 10000</span><br><span class="line"></span><br><span class="line">[[writers]]</span><br><span class="line">url = &quot;http://192.168.14.122:19000/prometheus/v1/write&quot;</span><br><span class="line"># Basic auth username</span><br><span class="line">basic_auth_user = &quot;&quot;</span><br><span class="line"># Basic auth password</span><br><span class="line">basic_auth_pass = &quot;&quot;</span><br><span class="line"># timeout settings, unit: ms</span><br><span class="line">timeout = 5000</span><br><span class="line">dial_timeout = 2500</span><br><span class="line">max_idle_conns_per_host = 100</span><br></pre></td></tr></table></figure>

<h4 id="MySQL采集"><a href="#MySQL采集" class="headerlink" title="MySQL采集"></a>MySQL采集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/categraf/conf/input.mysql/mysql.toml</span><br></pre></td></tr></table></figure>

<h4 id="MySQL-TCP-连通性"><a href="#MySQL-TCP-连通性" class="headerlink" title="MySQL TCP 连通性"></a>MySQL TCP 连通性</h4><h5 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a>配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;~/categraf/conf/input.net_response/net_response.toml</span><br><span class="line">interval = 15</span><br><span class="line">[[instances]]</span><br><span class="line">targets = [</span><br><span class="line">     &quot;192.168.0.137:3306&quot;,</span><br><span class="line">     &quot;192.168.14.122:56379&quot;</span><br><span class="line">]</span><br><span class="line">labels = &#123; region=&quot;MySQL-137&quot;, product=&quot;skytech&quot; &#125;</span><br><span class="line"># # interval = global.interval * interval_times</span><br><span class="line"># interval_times = 1</span><br><span class="line">## tcp/udp</span><br><span class="line">protocol = &quot;tcp&quot;</span><br><span class="line">timeout = &quot;5s&quot;</span><br><span class="line">## UDP 选项：</span><br><span class="line"># send = &quot;ssh&quot;</span><br><span class="line"># expect = &quot;ssh&quot;</span><br><span class="line"># read_timeout = &quot;1s&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h5 id="大盘JSON"><a href="#大盘JSON" class="headerlink" title="大盘JSON"></a>大盘JSON</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TCP探测&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;chart_groups&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Default chart group&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;refId\&quot;:\&quot;A\&quot;,\&quot;expr\&quot;:\&quot;max(net_response_result_code) by (target)\&quot;,\&quot;legend\&quot;:\&quot;UP?\&quot;&#125;,&#123;\&quot;expr\&quot;:\&quot;max(net_response_response_time) by (target)\&quot;,\&quot;refId\&quot;:\&quot;C\&quot;,\&quot;legend\&quot;:\&quot;latency(s)\&quot;&#125;],\&quot;name\&quot;:\&quot;Targets\&quot;,\&quot;custom\&quot;:&#123;\&quot;showHeader\&quot;:true,\&quot;calc\&quot;:\&quot;lastNotNull\&quot;,\&quot;displayMode\&quot;:\&quot;labelValuesToRows\&quot;,\&quot;aggrDimension\&quot;:\&quot;target\&quot;&#125;,\&quot;options\&quot;:&#123;\&quot;valueMappings\&quot;:[],\&quot;standardOptions\&quot;:&#123;&#125;&#125;,\&quot;overrides\&quot;:[&#123;\&quot;properties\&quot;:&#123;\&quot;valueMappings\&quot;:[&#123;\&quot;type\&quot;:\&quot;special\&quot;,\&quot;match\&quot;:&#123;\&quot;special\&quot;:0&#125;,\&quot;result\&quot;:&#123;\&quot;text\&quot;:\&quot;UP\&quot;,\&quot;color\&quot;:\&quot;#417505\&quot;&#125;&#125;,&#123;\&quot;type\&quot;:\&quot;range\&quot;,\&quot;match\&quot;:&#123;\&quot;special\&quot;:1,\&quot;from\&quot;:1&#125;,\&quot;result\&quot;:&#123;\&quot;text\&quot;:\&quot;DOWN\&quot;,\&quot;color\&quot;:\&quot;#e90f0f\&quot;&#125;&#125;],\&quot;standardOptions\&quot;:&#123;&#125;&#125;,\&quot;matcher\&quot;:&#123;\&quot;value\&quot;:\&quot;A\&quot;&#125;&#125;],\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;table\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:4,\&quot;w\&quot;:24,\&quot;x\&quot;:0,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;0\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h4 id="Redis采集"><a href="#Redis采集" class="headerlink" title="Redis采集"></a>Redis采集</h4><h5 id="配置-5"><a href="#配置-5" class="headerlink" title="配置"></a>配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;~/categraf/conf/input.redis/redis.toml</span><br><span class="line">interval = 15</span><br><span class="line">[[instances]]</span><br><span class="line">address = &quot;192.168.14.122:56379&quot;</span><br><span class="line"># username = &quot;&quot;</span><br><span class="line">password = &quot;maxzhao&quot;</span><br><span class="line"># pool_size = 2</span><br><span class="line"># # Optional. Specify redis commands to retrieve values</span><br><span class="line"># commands = [</span><br><span class="line">#     &#123;command = [&quot;get&quot;, &quot;sample-key1&quot;], metric = &quot;custom_metric_name1&quot;&#125;,</span><br><span class="line">#     &#123;command = [&quot;get&quot;, &quot;sample-key2&quot;], metric = &quot;custom_metric_name2&quot;&#125;</span><br><span class="line"># ]</span><br><span class="line"># interval_times = 1</span><br><span class="line"># important! use global unique string to specify instance</span><br><span class="line">labels = &#123; instance=&quot;redis-192.168.14.122:56379&quot; &#125;</span><br><span class="line">## Optional TLS Config</span><br><span class="line"># use_tls = false</span><br><span class="line"># tls_min_version = &quot;1.2&quot;</span><br><span class="line"># tls_ca = &quot;/etc/categraf/ca.pem&quot;</span><br><span class="line"># tls_cert = &quot;/etc/categraf/cert.pem&quot;</span><br><span class="line"># tls_key = &quot;/etc/categraf/key.pem&quot;</span><br><span class="line">## Use TLS but skip chain &amp; host verification</span><br><span class="line"># insecure_skip_verify = true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h5 id="大盘JSON-1"><a href="#大盘JSON-1" class="headerlink" title="大盘JSON"></a>大盘JSON</h5><p>其中，Redis地址需要修改</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Redis Overview - 模板&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Redis Prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;var\&quot;:[&#123;\&quot;name\&quot;:\&quot;instance\&quot;,\&quot;definition\&quot;:\&quot;label_values(redis_uptime_in_seconds,instance)\&quot;,\&quot;selected\&quot;:\&quot;192.168.14.122:56379\&quot;&#125;]&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;chart_groups&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Basic Info&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;min(redis_uptime_in_seconds&#123;instance=~\\\&quot;$instance\\\&quot;&#125;)\&quot;&#125;],\&quot;name\&quot;:\&quot;Redis Uptime\&quot;,\&quot;custom\&quot;:&#123;\&quot;textMode\&quot;:\&quot;value\&quot;,\&quot;colorMode\&quot;:\&quot;value\&quot;,\&quot;calc\&quot;:\&quot;lastNotNull\&quot;,\&quot;colSpan\&quot;:1,\&quot;textSize\&quot;:&#123;&#125;&#125;,\&quot;options\&quot;:&#123;\&quot;standardOptions\&quot;:&#123;\&quot;util\&quot;:\&quot;humantimeSeconds\&quot;&#125;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;stat\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:1,\&quot;w\&quot;:6,\&quot;x\&quot;:0,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;0\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;sum(redis_connected_clients&#123;instance=~\\\&quot;$instance\\\&quot;&#125;)\&quot;&#125;],\&quot;name\&quot;:\&quot;Connected Clients\&quot;,\&quot;custom\&quot;:&#123;\&quot;textMode\&quot;:\&quot;value\&quot;,\&quot;colorMode\&quot;:\&quot;value\&quot;,\&quot;calc\&quot;:\&quot;lastNotNull\&quot;,\&quot;colSpan\&quot;:1,\&quot;textSize\&quot;:&#123;&#125;&#125;,\&quot;options\&quot;:&#123;\&quot;standardOptions\&quot;:&#123;&#125;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;stat\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:1,\&quot;w\&quot;:6,\&quot;x\&quot;:6,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;1\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;redis_used_memory&#123;instance=~\\\&quot;$instance\\\&quot;&#125;\&quot;&#125;],\&quot;name\&quot;:\&quot;Memory Used\&quot;,\&quot;custom\&quot;:&#123;\&quot;textMode\&quot;:\&quot;value\&quot;,\&quot;colorMode\&quot;:\&quot;value\&quot;,\&quot;calc\&quot;:\&quot;lastNotNull\&quot;,\&quot;colSpan\&quot;:1,\&quot;textSize\&quot;:&#123;&#125;&#125;,\&quot;options\&quot;:&#123;\&quot;valueMappings\&quot;:[&#123;\&quot;type\&quot;:\&quot;range\&quot;,\&quot;match\&quot;:&#123;\&quot;to\&quot;:128000000&#125;,\&quot;result\&quot;:&#123;\&quot;color\&quot;:\&quot;#079e05\&quot;&#125;&#125;,&#123;\&quot;type\&quot;:\&quot;range\&quot;,\&quot;match\&quot;:&#123;\&quot;from\&quot;:128000000&#125;,\&quot;result\&quot;:&#123;\&quot;color\&quot;:\&quot;#f10909\&quot;&#125;&#125;],\&quot;standardOptions\&quot;:&#123;\&quot;util\&quot;:\&quot;bytesIEC\&quot;,\&quot;decimals\&quot;:0&#125;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;stat\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:1,\&quot;w\&quot;:6,\&quot;x\&quot;:12,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;2\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;redis_maxmemory&#123;instance=~\\\&quot;$instance\\\&quot;&#125;\&quot;&#125;],\&quot;name\&quot;:\&quot;Max Memory Limit\&quot;,\&quot;custom\&quot;:&#123;\&quot;textMode\&quot;:\&quot;value\&quot;,\&quot;colorMode\&quot;:\&quot;value\&quot;,\&quot;calc\&quot;:\&quot;lastNotNull\&quot;,\&quot;colSpan\&quot;:1,\&quot;textSize\&quot;:&#123;&#125;&#125;,\&quot;options\&quot;:&#123;\&quot;standardOptions\&quot;:&#123;\&quot;util\&quot;:\&quot;bytesIEC\&quot;&#125;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;stat\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:1,\&quot;w\&quot;:6,\&quot;x\&quot;:18,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;3\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Commands&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;rate(redis_total_commands_processed&#123;instance=~\\\&quot;$instance\\\&quot;&#125;[5m])\&quot;&#125;],\&quot;name\&quot;:\&quot;Commands Executed / sec\&quot;,\&quot;options\&quot;:&#123;\&quot;tooltip\&quot;:&#123;\&quot;mode\&quot;:\&quot;all\&quot;,\&quot;sort\&quot;:\&quot;none\&quot;&#125;,\&quot;legend\&quot;:&#123;\&quot;displayMode\&quot;:\&quot;hidden\&quot;&#125;,\&quot;standardOptions\&quot;:&#123;&#125;,\&quot;thresholds\&quot;:&#123;&#125;&#125;,\&quot;custom\&quot;:&#123;\&quot;drawStyle\&quot;:\&quot;lines\&quot;,\&quot;lineInterpolation\&quot;:\&quot;smooth\&quot;,\&quot;fillOpacity\&quot;:0.5,\&quot;stack\&quot;:\&quot;off\&quot;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;timeseries\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:2,\&quot;w\&quot;:8,\&quot;x\&quot;:0,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;0\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;irate(redis_keyspace_hits&#123;instance=~\\\&quot;$instance\\\&quot;&#125;[5m])\&quot;,\&quot;legend\&quot;:\&quot;hits\&quot;&#125;,&#123;\&quot;expr\&quot;:\&quot;irate(redis_keyspace_misses&#123;instance=~\\\&quot;$instance\\\&quot;&#125;[5m])\&quot;,\&quot;legend\&quot;:\&quot;misses\&quot;&#125;],\&quot;name\&quot;:\&quot;Hits / Misses per Sec\&quot;,\&quot;options\&quot;:&#123;\&quot;tooltip\&quot;:&#123;\&quot;mode\&quot;:\&quot;all\&quot;,\&quot;sort\&quot;:\&quot;none\&quot;&#125;,\&quot;legend\&quot;:&#123;\&quot;displayMode\&quot;:\&quot;hidden\&quot;&#125;,\&quot;standardOptions\&quot;:&#123;&#125;,\&quot;thresholds\&quot;:&#123;&#125;&#125;,\&quot;custom\&quot;:&#123;\&quot;drawStyle\&quot;:\&quot;lines\&quot;,\&quot;lineInterpolation\&quot;:\&quot;smooth\&quot;,\&quot;fillOpacity\&quot;:0.5,\&quot;stack\&quot;:\&quot;noraml\&quot;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;timeseries\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:2,\&quot;w\&quot;:8,\&quot;x\&quot;:8,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;1\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;topk(5, irate(redis_cmdstat_calls&#123;instance=~\\\&quot;$instance\\\&quot;&#125; [1m]))\&quot;,\&quot;legend\&quot;:\&quot;&#123;&#123;command&#125;&#125;\&quot;&#125;],\&quot;name\&quot;:\&quot;Top Commands\&quot;,\&quot;options\&quot;:&#123;\&quot;tooltip\&quot;:&#123;\&quot;mode\&quot;:\&quot;all\&quot;,\&quot;sort\&quot;:\&quot;desc\&quot;&#125;,\&quot;legend\&quot;:&#123;\&quot;displayMode\&quot;:\&quot;hidden\&quot;&#125;,\&quot;standardOptions\&quot;:&#123;&#125;,\&quot;thresholds\&quot;:&#123;&#125;&#125;,\&quot;custom\&quot;:&#123;\&quot;drawStyle\&quot;:\&quot;lines\&quot;,\&quot;lineInterpolation\&quot;:\&quot;smooth\&quot;,\&quot;fillOpacity\&quot;:0.5,\&quot;stack\&quot;:\&quot;off\&quot;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;timeseries\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:2,\&quot;w\&quot;:8,\&quot;x\&quot;:16,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;2\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Keys&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;sum (redis_keyspace_keys&#123;instance=~\\\&quot;$instance\\\&quot;&#125;) by (db)\&quot;,\&quot;legend\&quot;:\&quot;&#123;&#123;db&#125;&#125;\&quot;&#125;],\&quot;name\&quot;:\&quot;Total Items per DB\&quot;,\&quot;options\&quot;:&#123;\&quot;tooltip\&quot;:&#123;\&quot;mode\&quot;:\&quot;all\&quot;,\&quot;sort\&quot;:\&quot;desc\&quot;&#125;,\&quot;legend\&quot;:&#123;\&quot;displayMode\&quot;:\&quot;hidden\&quot;&#125;,\&quot;standardOptions\&quot;:&#123;&#125;,\&quot;thresholds\&quot;:&#123;&#125;&#125;,\&quot;custom\&quot;:&#123;\&quot;drawStyle\&quot;:\&quot;lines\&quot;,\&quot;lineInterpolation\&quot;:\&quot;smooth\&quot;,\&quot;fillOpacity\&quot;:0.5,\&quot;stack\&quot;:\&quot;off\&quot;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;timeseries\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:2,\&quot;w\&quot;:8,\&quot;x\&quot;:0,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;0\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;sum(rate(redis_expired_keys&#123;instance=~\\\&quot;$instance\\\&quot;&#125;[5m])) by (instance)\&quot;,\&quot;legend\&quot;:\&quot;expired\&quot;&#125;,&#123;\&quot;expr\&quot;:\&quot;sum(rate(redis_evicted_keys&#123;instance=~\\\&quot;$instance\\\&quot;&#125;[5m])) by (instance)\&quot;,\&quot;legend\&quot;:\&quot;evicted\&quot;&#125;],\&quot;name\&quot;:\&quot;Expired / Evicted\&quot;,\&quot;options\&quot;:&#123;\&quot;tooltip\&quot;:&#123;\&quot;mode\&quot;:\&quot;all\&quot;,\&quot;sort\&quot;:\&quot;desc\&quot;&#125;,\&quot;legend\&quot;:&#123;\&quot;displayMode\&quot;:\&quot;hidden\&quot;&#125;,\&quot;standardOptions\&quot;:&#123;&#125;,\&quot;thresholds\&quot;:&#123;&#125;&#125;,\&quot;custom\&quot;:&#123;\&quot;drawStyle\&quot;:\&quot;lines\&quot;,\&quot;lineInterpolation\&quot;:\&quot;smooth\&quot;,\&quot;fillOpacity\&quot;:0.5,\&quot;stack\&quot;:\&quot;off\&quot;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;timeseries\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:2,\&quot;w\&quot;:8,\&quot;x\&quot;:8,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;1\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;sum(redis_keyspace_keys&#123;instance=~\\\&quot;$instance\\\&quot;&#125;) - sum(redis_keyspace_expires&#123;instance=~\\\&quot;$instance\\\&quot;&#125;) \&quot;,\&quot;legend\&quot;:\&quot;not expiring\&quot;&#125;,&#123;\&quot;expr\&quot;:\&quot;sum(redis_keyspace_expires&#123;instance=~\\\&quot;$instance\\\&quot;&#125;) \&quot;,\&quot;legend\&quot;:\&quot;expiring\&quot;&#125;],\&quot;name\&quot;:\&quot;Expiring vs Not-Expiring Keys\&quot;,\&quot;options\&quot;:&#123;\&quot;tooltip\&quot;:&#123;\&quot;mode\&quot;:\&quot;all\&quot;,\&quot;sort\&quot;:\&quot;none\&quot;&#125;,\&quot;legend\&quot;:&#123;\&quot;displayMode\&quot;:\&quot;hidden\&quot;&#125;,\&quot;standardOptions\&quot;:&#123;&#125;,\&quot;thresholds\&quot;:&#123;&#125;&#125;,\&quot;custom\&quot;:&#123;\&quot;drawStyle\&quot;:\&quot;lines\&quot;,\&quot;lineInterpolation\&quot;:\&quot;smooth\&quot;,\&quot;fillOpacity\&quot;:0.5,\&quot;stack\&quot;:\&quot;noraml\&quot;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;timeseries\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:2,\&quot;w\&quot;:8,\&quot;x\&quot;:16,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;2\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Network&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;\&quot;targets\&quot;:[&#123;\&quot;expr\&quot;:\&quot;sum(rate(redis_total_net_input_bytes&#123;instance=~\\\&quot;$instance\\\&quot;&#125;[5m]))\&quot;,\&quot;legend\&quot;:\&quot;input\&quot;&#125;,&#123;\&quot;expr\&quot;:\&quot;sum(rate(redis_total_net_output_bytes&#123;instance=~\\\&quot;$instance\\\&quot;&#125;[5m]))\&quot;,\&quot;legend\&quot;:\&quot;output\&quot;&#125;],\&quot;name\&quot;:\&quot;Network I/O\&quot;,\&quot;options\&quot;:&#123;\&quot;tooltip\&quot;:&#123;\&quot;mode\&quot;:\&quot;all\&quot;,\&quot;sort\&quot;:\&quot;desc\&quot;&#125;,\&quot;legend\&quot;:&#123;\&quot;displayMode\&quot;:\&quot;hidden\&quot;&#125;,\&quot;standardOptions\&quot;:&#123;\&quot;util\&quot;:\&quot;bytesIEC\&quot;,\&quot;decimals\&quot;:2&#125;,\&quot;thresholds\&quot;:&#123;&#125;&#125;,\&quot;custom\&quot;:&#123;\&quot;drawStyle\&quot;:\&quot;lines\&quot;,\&quot;lineInterpolation\&quot;:\&quot;smooth\&quot;,\&quot;fillOpacity\&quot;:0.5,\&quot;stack\&quot;:\&quot;off\&quot;&#125;,\&quot;version\&quot;:\&quot;2.0.0\&quot;,\&quot;type\&quot;:\&quot;timeseries\&quot;,\&quot;layout\&quot;:&#123;\&quot;h\&quot;:2,\&quot;w\&quot;:24,\&quot;x\&quot;:0,\&quot;y\&quot;:0,\&quot;i\&quot;:\&quot;0\&quot;&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;weight&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br></pre></td></tr></table></figure>



<h3 id="启动-3"><a href="#启动-3" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ~/categraf/categraf -configs ~/categraf/conf/ &amp;&gt; categraf.log &amp;</span><br></pre></td></tr></table></figure>

<h3 id="重启加脚本"><a href="#重启加脚本" class="headerlink" title="重启加脚本"></a>重启加脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">t=$(ps -ef|grep <span class="string">&quot;/home/yy/categraf/categraf&quot;</span> |grep -v grep |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$t</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;categraf stop&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">kill</span> -9 <span class="variable">$t</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;categraf shutdown&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">nohup</span> <span class="built_in">nohup</span> ~/categraf/categraf -configs ~/categraf/conf/ &amp;&gt; categraf.log &amp; &amp;&gt; categraf.log &amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;categraf start&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="应用系统监测"><a href="#应用系统监测" class="headerlink" title="应用系统监测"></a>应用系统监测</h2><h3 id="telegraf采集"><a href="#telegraf采集" class="headerlink" title="telegraf采集"></a><code>telegraf</code>采集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/telegraf/etc/telegraf/telegraf.conf</span><br></pre></td></tr></table></figure>

<h4 id="Http-应用超时采集"><a href="#Http-应用超时采集" class="headerlink" title="Http 应用超时采集"></a>Http 应用超时采集</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[[inputs.http_response]]</span><br><span class="line">  address = &quot;http://127.0.0.1:30001/seed-auth/index.html&quot;</span><br><span class="line">  interval = &quot;60s&quot;</span><br><span class="line">  response_timeout = &quot;5s&quot;</span><br><span class="line">  method = &quot;GET&quot;</span><br><span class="line">  [inputs.http_response.tags]</span><br><span class="line">    app = &quot;统一认证平台服务端-122&quot;</span><br><span class="line">    group = &quot;统一认证平台&quot;</span><br></pre></td></tr></table></figure>

<h4 id="Tcp-应用超时"><a href="#Tcp-应用超时" class="headerlink" title="Tcp 应用超时"></a>Tcp 应用超时</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[[inputs.net_response]]</span><br><span class="line">  protocol = &quot;tcp&quot;</span><br><span class="line">  #应用系统ip:port</span><br><span class="line">  address = &quot;192.168.0.137:1521&quot;</span><br><span class="line">  timeout = &quot;60s&quot;</span><br><span class="line">  tagexclude = [&quot;result&quot;]</span><br><span class="line">  [inputs.net_response.tags]</span><br><span class="line">    #应用系统名称</span><br><span class="line">    app = &quot;Oracle&quot;</span><br><span class="line">    #如果需要对应用系统进行分组，可以添加分组的标签，分组后便于夜莺告警规则中根据组名分别制定不同规则。</span><br><span class="line">    group = &quot;skytech&quot;</span><br><span class="line">    </span><br><span class="line">[[inputs.net_response]]</span><br><span class="line">  protocol = &quot;tcp&quot;</span><br><span class="line">  address = &quot;192.168.0.137:3306&quot;</span><br><span class="line">  timeout = &quot;60s&quot;</span><br><span class="line">  tagexclude = [&quot;result&quot;]</span><br><span class="line">  [inputs.net_response.tags]</span><br><span class="line">    app = &quot;MySQL&quot;</span><br><span class="line">    group = &quot;skytech&quot;   </span><br></pre></td></tr></table></figure>

<h4 id="MySQL采集-1"><a href="#MySQL采集-1" class="headerlink" title="MySQL采集"></a>MySQL采集</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[[inputs.mysql]]</span><br><span class="line">  interval = &quot;30&quot;</span><br><span class="line">  servers = [&quot;seed_demo_auth_server:Seed@tcp(192.168.0.137:3306)/?tls=false&quot;]</span><br><span class="line">  perf_events_statements_digest_text_limit  = 120</span><br><span class="line">  perf_events_statements_limit              = 250</span><br><span class="line">  perf_events_statements_time_limit         = 86400</span><br><span class="line">  table_schema_databases                    = [&quot;&quot;]</span><br><span class="line">  gather_table_schema                       = false</span><br><span class="line">  gather_process_list                       = true</span><br><span class="line">  gather_info_schema_auto_inc               = true</span><br><span class="line">  gather_slave_status                       = true</span><br><span class="line">  gather_binary_logs                        = false</span><br><span class="line">  gather_table_io_waits                     = false</span><br><span class="line">  gather_table_lock_waits                   = false</span><br><span class="line">  gather_index_io_waits                     = false</span><br><span class="line">  gather_event_waits                        = false</span><br><span class="line">  gather_file_events_stats                  = false</span><br><span class="line">  interval_slow                             = &quot;30m&quot;</span><br></pre></td></tr></table></figure>

<h4 id="Redis-采集"><a href="#Redis-采集" class="headerlink" title="Redis 采集"></a>Redis 采集</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[inputs.redis]]</span><br><span class="line">  ##  [protocol://][:password]@address[:port]</span><br><span class="line">  servers = [&#x27;tcp://:maxzhao@192.168.14.122:56379&#x27;]</span><br></pre></td></tr></table></figure>

<h3 id="夜莺展示系统"><a href="#夜莺展示系统" class="headerlink" title="夜莺展示系统"></a>夜莺展示系统</h3><h4 id="服务器资源监控大盘"><a href="#服务器资源监控大盘" class="headerlink" title="服务器资源监控大盘"></a>服务器资源监控大盘</h4><p><strong>监控看图</strong>-<strong>监控大盘</strong>-<strong>更多操作</strong>中选择<strong>导入监控大盘</strong>-<strong>导入内置大盘模块</strong>，导入 <code>linux_by_telegraf</code></p>
<h4 id="TCP-监控大盘"><a href="#TCP-监控大盘" class="headerlink" title="TCP 监控大盘"></a>TCP 监控大盘</h4><p><strong>更多操作</strong>中选择<strong>导入监控大盘</strong>-<strong>导入大盘JSON</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TCP监测&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;var&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net_response_result_code&#123;group=&#x27;tcpDemo&#x27;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;app&#125;&#125;【&#123;&#123;server&#125;&#125;:&#123;&#123;port&#125;&#125;】&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TCP连接&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;custom&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;showHeader&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;calc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lastNotNull&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;displayMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;seriesToRows&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sortColumn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sortOrder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;descend&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;standardOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;table&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;layout&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;i&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8c2e31ab-6c82-486d-814a-c1b20ca30bb8&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;isResizable&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8c2e31ab-6c82-486d-814a-c1b20ca30bb8&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Http-监控大盘"><a href="#Http-监控大盘" class="headerlink" title="Http 监控大盘"></a>Http 监控大盘</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HTTP监测&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;var&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http_response_http_response_code&#123;group=&#x27;httpDemo&#x27;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;app&#125;&#125;【&#123;&#123;server&#125;&#125; 】&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;WEB应用响应值&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;custom&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;showHeader&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;calc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lastNotNull&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;displayMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;seriesToRows&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sortColumn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;sortOrder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;descend&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;standardOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;table&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;layout&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;i&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a61b2107-efff-4ef0-b4d6-2555e3d13978&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;isResizable&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a61b2107-efff-4ef0-b4d6-2555e3d13978&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><h2 id="Redis大盘参数"><a href="#Redis大盘参数" class="headerlink" title="Redis大盘参数"></a>Redis大盘参数</h2><p><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http://www.redis.cn/commands/info.html">redis官网相关文档</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">redis_active_defrag_running:活动碎片整理是否运行[lw]</span><br><span class="line"></span><br><span class="line">redis_allocator_active_bytes:分配器活动字节[lw]</span><br><span class="line">redis_active_allocated_bytes:活动分配的字节[lw]</span><br><span class="line">redis_assocator_frag_bytes:关联碎片字节[lw]</span><br><span class="line">redis_allocator_frag_ratio:分配器碎片比率[lw]</span><br><span class="line">redis_allocator_resident_bytes:分配器常驻字节[lw]</span><br><span class="line">redis_allocator_rss_bytes:分配器RSS字节[lw]</span><br><span class="line">redis_allocator_rss_ratio:分配器RSS比率[lw]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">redis_aof_current_rewrite_duration_sec:aof当前重写持续时间sec[lw]</span><br><span class="line">redis_aof_enabled:是否启用aof[lw]</span><br><span class="line">redis_aof_last_bgrewrite_status:最近一次AOF重写操作是否执行成功[lw]</span><br><span class="line">redis_aof_last_cow_size_bytes:在执行AOF重写期间，分配给COW的大小[lw]</span><br><span class="line">redis_aof_last_rewrite_duration_sec:最近一次AOF重写操作消耗的时间[lw]</span><br><span class="line">redis_aof_last_write_status:aof上次写入状态[lw]</span><br><span class="line">redis_aof_rewrite_in_progress:是否在进行AOF的重写操作[lw]</span><br><span class="line">redis_aof_rewrite_scheduled:是否有AOF操作等待执行[lw]</span><br><span class="line"></span><br><span class="line">redis_blocked_clients:被阻止的客户[lw]</span><br><span class="line"></span><br><span class="line">redis_client_recent_max_input_buffer_bytes:客户端最近最大输入缓冲区字节[lw]</span><br><span class="line">redis_client_recent_max_output_buffer_bytes:客户端最近最大输出缓冲区字节[lw]</span><br><span class="line">redis_cluster_enabled:是否启用集群[lw]</span><br><span class="line"></span><br><span class="line">redis_commands_duration_seconds_total:命令持续时间总秒数[lw]</span><br><span class="line">redis_commands_processed_total:命令处理总数[lw]</span><br><span class="line">redis_commands_total:命令总数[lw]</span><br><span class="line"></span><br><span class="line">redis_config_maxclients:配置最大客户端[lw]</span><br><span class="line">redis_config_maxmemory:配置最大内存[lw]</span><br><span class="line"></span><br><span class="line">redis_connected_clients:连接的客户[lw]</span><br><span class="line">redis_connected_slave_lag_seconds:连接的从节点延迟秒[lw]</span><br><span class="line">redis_connected_slave_offset_bytes:连接的从节点偏移字节[lw]</span><br><span class="line">redis_connected_slaves:连接的从节点[lw]</span><br><span class="line">redis_connections_received_total:收到的连接总数[lw]</span><br><span class="line"></span><br><span class="line">redis_cpu_sys_children_seconds_total:由后台进程消耗的系统CPU[lw]</span><br><span class="line">redis_cpu_sys_seconds_total:由Redis服务器消耗的用户CPU[lw]</span><br><span class="line">redis_cpu_user_children_seconds_total:由后台进程消耗的用户CPU[lw]</span><br><span class="line">redis_cpu_user_seconds_total:由Redis服务消耗的用户CPU[lw]</span><br><span class="line"></span><br><span class="line">redis_db_avg_ttl_seconds:db平均ttl秒[lw]</span><br><span class="line">redis_db_keys:数据库key的数量[lw]</span><br><span class="line">redis_db_keys_expiring:即将过期的key[lw]</span><br><span class="line"></span><br><span class="line">redis_defrag_hits:碎片整理命中[lw]</span><br><span class="line">redis_defrag_key_hits:碎片整理命中key[lw]</span><br><span class="line">redis_defrag_key_misses:碎片整理未命中key[lw]</span><br><span class="line">redis_evicted_keys_total:被驱逐的key总数[lw]</span><br><span class="line"></span><br><span class="line">redis_expired_keys_total:过期key总数[lw]</span><br><span class="line">redis_expired_stale_percentage:过期陈旧key占百分比[lw]</span><br><span class="line">redis_expired_time_cap_reached_total:已达到总时间上限[lw]</span><br><span class="line"></span><br><span class="line">redis_exporter_build_infor:redis_exporter信息[lw]</span><br><span class="line">redis_exporter_last_scrape_connect_time_seconds:redis_exporter最后一次采集时间[lw]</span><br><span class="line">redis_exporter_last_scrape_duration_seconds:redis_exporter次抓取持续时间秒[lw]</span><br><span class="line">redis_exporter_last_scrape_error:redis_exporter次抓取错误[lw]</span><br><span class="line">redis_exporter_scrape_duration_seconds_count:redis_exporter采集续时间秒数[lw]</span><br><span class="line">redis_exporter_scrape_duration_seconds_sum:redis_exporter持续时间秒总和[lw]</span><br><span class="line">redis_exporter_scrapes_total:redis_exporter抓取总数[lw]</span><br><span class="line"></span><br><span class="line">redis_instance_info:实例信息[lw]</span><br><span class="line">redis_keyspace_hits_total:键空间命中总数[lw]</span><br><span class="line">redis_keyspace_misses_total:键空间未命中总数[lw]</span><br><span class="line"></span><br><span class="line">redis_last_key_groups_scrape_duration_milliseconds:最后一个键组抓取持续时间毫秒[lw]</span><br><span class="line">redis_last_slow_execution_duration_seconds:最后一个慢执行持续时间秒[lw]</span><br><span class="line">redis_latest_fork_seconds:最新fork时间[lw]</span><br><span class="line">redis_lazyfree_pending_objects:惰性删除或延迟释放的对象[lw]</span><br><span class="line">redis_loading_dump_file:加载转储文件[lw]</span><br><span class="line"></span><br><span class="line">redis_master_last_io_seconds_ago:master最后io过去时间[lw]</span><br><span class="line">redis_master_repl_offset:主节点累加偏移量（判断主从是否同步）[lw]</span><br><span class="line">redis_master_sync_in_progress:正在进行主同步[lw]</span><br><span class="line"></span><br><span class="line">redis_mem_clients_normal:[lw]</span><br><span class="line">redis_mem_clients_slaves:[lw]</span><br><span class="line">redis_mem_fragmentation_bytes:内存碎片字节[lw]</span><br><span class="line">redis_mem_fragmentation_ratio:内存碎片率[lw]</span><br><span class="line">redis_mem_not_counted_for_eviction_bytes:内存不计入驱逐的字节数[lw]</span><br><span class="line">redis_memory_max_bytes:内存最大字节[lw]</span><br><span class="line">redis_memory_used_lua_bytes:lua脚本使用内存字节数[lw]</span><br><span class="line">redis_memory_used_overhead_bytes:维护数据集的内部机制所需的内存开销[lw]</span><br><span class="line">redis_memory_used_peak_bytes:内存使用峰值[lw]</span><br><span class="line">redis_memory_used_rss_bytes:rss占用内存的字节数[lw]</span><br><span class="line">redis_memory_used_scripts_bytes:脚本占用内存的字节数[lw]</span><br><span class="line">redis_memory_used_startup_bytes:启动占用内存的字节数[lw]</span><br><span class="line">redis_migrate_cached_sockets_total:[lw]</span><br><span class="line">redis_net_input_bytes_total:网络input总数[lw]</span><br><span class="line">redis_net_output_bytes_total:网络output总数[lw]</span><br><span class="line">reids_process_id:进程号[lw]</span><br><span class="line">redis_pubsub_channels:发布订阅频道[lw]</span><br><span class="line">redis_pubsub_patterns:发布订阅模式[lw]</span><br><span class="line"></span><br><span class="line">redis_rdb_bgsave_in_progress:[lw]</span><br><span class="line">redis_rdb_changes_since_last_save:自上次保存以来的rdb更改[lw]</span><br><span class="line">redis_rdb_current_bgsave_duration_sec:rdb当前bgsave持续时间[lw]</span><br><span class="line">redis_rdb_last_bgsave_duration_sec:rdb上次bgsave持续时间[lw]</span><br><span class="line">redis_rdb_last_bgsave_status:rdb上次bgsave状态[lw]</span><br><span class="line">redis_rdb_last_cow_size_bytes:rdb上次cow的大小[lw]</span><br><span class="line">redis_rdb_last_save_timestamp_seconds:rdb最后保存时间戳[lw]</span><br><span class="line"></span><br><span class="line">redis_rejected_connections_total:拒绝的连接总数[lw]</span><br><span class="line">redis_repl_backlog_first_byte_offset:复制起始偏移量[lw]</span><br><span class="line">redis_repl_backlog_history_bytes:repl_backlog历史数据大小[lw]</span><br><span class="line">redis_repl_backlog_is_active:repl_backlog是否开启[lw]</span><br><span class="line">redis_replica_partial_resync_accepted:[lw]</span><br><span class="line">redis_replica_partial_resync_denied:[lw]</span><br><span class="line">redis_replica_resyncs_full:[lw]</span><br><span class="line">redis_replication_backlog_bytes:[lw]</span><br><span class="line">redis_second_repl_offset:[lw]</span><br><span class="line">redis_slave_expires_tracked_keys:[lw]</span><br><span class="line">redis_slave_info:从节点信息[lw]</span><br><span class="line">redis_slave_priority:从节点优先级[lw]</span><br><span class="line">redis_slave_repl_offset:从节点累加偏移量（判断主从是否同步）[lw]</span><br><span class="line">redis_slowlog_last_id:慢查询日志最后一个的id[lw]</span><br><span class="line">redis_slowlog_length:慢查询日志长度[lw]</span><br><span class="line">redis_start_time_seconds:开始时间秒[lw]</span><br><span class="line">redis_target_scrape_request_errors_total:[lw]</span><br><span class="line">redis_up:运行时间[lw]</span><br><span class="line">redis_uptime_in_seconds:正常运行时间[lw]</span><br></pre></td></tr></table></figure>

<h2 id="Redis大盘JSON"><a href="#Redis大盘JSON" class="headerlink" title="Redis大盘JSON"></a>Redis大盘JSON</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/ac3f2297/">https://github.com/maxzhao-it/blog/post/ac3f2297/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/cdb1e23a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/cdb1e23a/" class="post-title-link" itemprop="url">Kubeadm安装K8S-Containerd</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-28 17:26:51" itemprop="dateModified" datetime="2022-07-28T17:26:51+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/K8S/" itemprop="url" rel="index"><span itemprop="name">K8S</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这里使用 <code>kubebetes + containerd.io</code></p>
<p><code>dashborad</code> 没有成功</p>
<p>我这里有</p>
<ul>
<li><code>192.168.2.158 master-158</code></li>
<li><code>192.168.2.159 master-159</code></li>
<li><code>192.168.2.160 master-160</code></li>
<li><code>192.168.2.161 node-161</code></li>
<li><code>192.168.2.240 nfs</code></li>
</ul>
<blockquote>
<p>可能需要：</p>
<p><a href="./ebede6de">安装<code>etcd</code>集群</a></p>
<p><a href="./21945">安装<code>docker</code></a> 或 <code>containerd</code>(下文有)</p>
</blockquote>
<h1 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h1><h3 id="检查端口"><a href="#检查端口" class="headerlink" title="检查端口"></a>检查端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su root</span><br><span class="line">sudo yum install -y netcat </span><br><span class="line">nc 127.0.0.1 6443</span><br></pre></td></tr></table></figure>

<blockquote>
<p>虚拟机需要挂载<code>ISO</code>镜像</p>
</blockquote>
<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop firewalld</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"><span class="comment"># 关闭selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 永久</span></span><br><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  </span><br><span class="line"><span class="comment"># 关闭swap（k8s禁止虚拟内存以提高性能）</span></span><br><span class="line">swapoff -a </span><br><span class="line"><span class="comment">#永久</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab </span><br><span class="line"><span class="comment"># 所有节点添加 host</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.2.158 host158</span></span><br><span class="line"><span class="string">192.168.2.159 host159</span></span><br><span class="line"><span class="string">192.168.2.160 host160</span></span><br><span class="line"><span class="string">192.168.2.161 host161</span></span><br><span class="line"><span class="string">192.168.2.240 host240</span></span><br><span class="line"><span class="string">192.168.2.240 host241</span></span><br><span class="line"><span class="string">192.168.2.158 master-158</span></span><br><span class="line"><span class="string">192.168.2.159 master-159</span></span><br><span class="line"><span class="string">192.168.2.160 master-160</span></span><br><span class="line"><span class="string">192.168.2.161 node-161</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">cat</span> /etc/hosts</span><br></pre></td></tr></table></figure>

<h3 id="Docker-镜像"><a href="#Docker-镜像" class="headerlink" title="Docker 镜像"></a><code>Docker</code> 镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要挂载 ISO 镜像</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /mnt/cdrom</span><br><span class="line">sudo mount /dev/cdrom /mnt/cdrom/</span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 或者 阿里云</span></span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 或者 清华大学源</span></span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h3 id="配置-k8s-镜像"><a href="#配置-k8s-镜像" class="headerlink" title="配置 k8s 镜像"></a>配置 <code>k8s</code> 镜像</h3><p>配置：<code>/etc/yum.repos.d/kubernetes.repo</code></p>
<p>使用阿里云镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>刷新</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于官网未开放同步方式, 可能会有索引gpg检查失败的情况</span></span><br><span class="line"><span class="comment"># sudo yum clean all &amp;&amp; sudo yum makecache</span></span><br></pre></td></tr></table></figure>

<p>或者使用华为云镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://repo.huaweicloud.com/kubernetes/yum/repos/kubernetes-el7-$basearch</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://repo.huaweicloud.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class="line"><span class="string">https://repo.huaweicloud.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h1 id="Kubeadm-安装"><a href="#Kubeadm-安装" class="headerlink" title="Kubeadm 安装"></a><code>Kubeadm</code> 安装</h1><p>万事不决，重启解决，解决不了，删掉重搞</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl restart containerd</span><br><span class="line"><span class="comment"># 更新配置文件 </span></span><br><span class="line">kubeadm init phase upload-config all --config=/root/kubeadm-config-init.yaml --v=5</span><br><span class="line"><span class="comment"># 更新配置文件  kubeconfig</span></span><br><span class="line">kubeadm init phase kubeconfig all --config=/root/kubeadm-config-init.yaml --v=5</span><br><span class="line"><span class="comment"># 更新 kube-proxy</span></span><br><span class="line">kubeadm init phase addon kube-proxy --config=/root/kubeadm-config-init.yaml --v=5</span><br></pre></td></tr></table></figure>

<h2 id="一、安装依赖"><a href="#一、安装依赖" class="headerlink" title="一、安装依赖"></a>一、安装依赖</h2><h3 id="k8s-依赖"><a href="#k8s-依赖" class="headerlink" title="k8s 依赖"></a><code>k8s</code> 依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载 docker</span></span><br><span class="line">sudo yum remove -y docker-ce docker-ce-cli docker-compose-plugin</span><br><span class="line">sudo yum remove -y kubelet kubeadm kubectl</span><br><span class="line"><span class="comment">#  SELinux 设置为 permissive 模式（将其禁用）</span></span><br><span class="line">sudo setenforce 0</span><br><span class="line"><span class="comment"># 永久</span></span><br><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  </span><br><span class="line"><span class="comment"># 所有 kubernetes 安装</span></span><br><span class="line">sudo yum install -y kubelet kubeadm kubectl</span><br><span class="line"><span class="comment"># 安装可能会签名失败（ signature could not be verified for kubernetes ），用下面不校验 gpg</span></span><br><span class="line"><span class="comment"># sudo yum install -y --nogpgcheck kubelet kubeadm kubectl</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> kubelet </span><br><span class="line">sudo systemctl <span class="built_in">enable</span> kubelet </span><br><span class="line">sudo systemctl start kubelet</span><br><span class="line"><span class="comment"># 这里会因为缺失/var/lib/kubelet/config.yaml 而停止服务，但一直会尝试重启</span></span><br><span class="line">sudo systemctl status kubelet -l</span><br><span class="line"><span class="comment"># 查看安装后的版本</span></span><br><span class="line">kubectl version --client</span><br><span class="line">kubectl version --client --output=yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubelet</code>  节点通信</li>
<li><code>kubeadm</code>  自动化部署工具</li>
<li><code>kubectl</code>  集群管理工具</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/tools/install-kubectl-linux/">Linux 官方推荐方式 </a></p>
</blockquote>
<h3 id="ipvs-依赖"><a href="#ipvs-依赖" class="headerlink" title="ipvs 依赖"></a><code>ipvs</code> 依赖</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo yum install -y ipset ipvsadm</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">lsmod|grep ip_vs</span><br><span class="line"><span class="comment"># 加载</span></span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line">modprobe nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>

<h3 id="安装-kubectl-命令补全工具（可选）"><a href="#安装-kubectl-命令补全工具（可选）" class="headerlink" title="安装 kubectl 命令补全工具（可选）"></a>安装 <code>kubectl</code> 命令补全工具（可选）</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y bash-completion</span><br><span class="line"><span class="built_in">cat</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="comment"># 重新加载 shell 后查看（可以 exit 后ssh 重连）</span></span><br><span class="line"><span class="built_in">type</span> _init_completion</span><br><span class="line"><span class="comment"># 如果重新加载后没有成功，请将下面加入 ~/.bashrc 中</span></span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="comment"># 启动 kubectl 自动补全</span></span><br><span class="line">sudo kubectl completion bash | sudo <span class="built_in">tee</span> /etc/bash_completion.d/kubectl &gt; /dev/null</span><br><span class="line"><span class="comment"># 添加 kubectl 别名</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;alias k=kubectl&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;complete -F __start_kubectl k&#x27;</span> &gt;&gt;~/.bashrc</span><br></pre></td></tr></table></figure>

<h2 id="二、安装kubeadm"><a href="#二、安装kubeadm" class="headerlink" title="二、安装kubeadm"></a>二、安装<code>kubeadm</code></h2><p>全部节点</p>
<h4 id="允许-iptables-检查桥接流量"><a href="#允许-iptables-检查桥接流量" class="headerlink" title="允许 iptables 检查桥接流量"></a>允许 <code>iptables</code> 检查桥接流量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保 br_netfilter 模块被加载</span></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line"><span class="comment"># 显式加载该模块</span></span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"><span class="comment">#为了让你的 Linux 节点上的 iptables 能够正确地查看桥接流量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>

<h4 id="确保MAC地址和product-uuid的唯一"><a href="#确保MAC地址和product-uuid的唯一" class="headerlink" title="确保MAC地址和product_uuid的唯一"></a>确保<code>MAC</code>地址和<code>product_uuid</code>的唯一</h4><ul>
<li>你可以使用命令 <code>ip link</code> 或 <code>ifconfig -a</code> 来获取网络接口的 MAC 地址</li>
<li>可以使用 <code>sudo cat /sys/class/dmi/id/product_uuid</code> 命令对 <code>product_uuid</code> 校验</li>
</ul>
<h2 id="三、容器运行时"><a href="#三、容器运行时" class="headerlink" title="三、容器运行时"></a>三、容器运行时</h2><p>全部节点</p>
<h3 id="安装containerd"><a href="#安装containerd" class="headerlink" title="安装containerd"></a>安装<code>containerd</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关闭swap</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment">#永久</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/containerd.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"><span class="comment">#验证 br_netfilter 模块是否已加载</span></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line"><span class="comment"># 设置必需的 sysctl 参数，这些参数在重新启动后仍然存在。</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 sysctl 参数而无需重新启动</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>

<p>安装 <code>Containerd.io</code></p>
<p><a href="#docker-repo">配置Docker 镜像</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点安装 containerd</span></span><br><span class="line">sudo yum install -y containerd.io</span><br><span class="line"><span class="comment"># 配置 containerd：</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default | sudo <span class="built_in">tee</span> /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># 使用 `systemd cgroup` 驱动程序</span></span><br><span class="line">sed -i <span class="string">&#x27;s/SystemdCgroup = false/SystemdCgroup = true/g&#x27;</span> /etc/containerd/config.toml</span><br><span class="line">sudo <span class="built_in">cat</span> /etc/containerd/config.toml |grep SystemdCgroup</span><br><span class="line">sudo systemctl restart containerd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd</span><br><span class="line">sudo systemctl status containerd</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md"><code>github</code></a></p>
</blockquote>
<p>结果：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc]</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]</span><br><span class="line">    SystemdCgroup = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当使用 <code>kubeadm</code><br>时，请手动配置 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#configure-cgroup-driver-used-by-kubelet-on-control-plane-node"><code>kubelet</code> 的 <code>cgroup</code> 驱动</a><br>.</p>
</blockquote>
<h2 id="四、创建集群"><a href="#四、创建集群" class="headerlink" title="四、创建集群"></a>四、创建集群</h2><h3 id="CA证书（可以跳过）"><a href="#CA证书（可以跳过）" class="headerlink" title="CA证书（可以跳过）"></a><code>CA</code>证书（可以跳过）</h3><p><a href="./ebede6dg">生成<code>CA</code>证书</a></p>
<table>
<thead>
<tr>
<th>路径</th>
<th>默认 CN</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ca.crt,key</td>
<td>kubernetes-ca</td>
<td>Kubernetes 通用 CA</td>
</tr>
<tr>
<td>etcd&#x2F;ca.crt,key</td>
<td>etcd-ca</td>
<td>与 etcd 相关的所有功能</td>
</tr>
<tr>
<td>front-proxy-ca.crt,key</td>
<td>kubernetes-front-proxy-ca</td>
<td>用于 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/extend-kubernetes/configure-aggregation-layer/">前端代理</a></td>
</tr>
</tbody></table>
<p>上面的 CA 之外，还需要获取用于服务账户管理的密钥对，也就是 <code>sa.key</code> 和 <code>sa.pub</code>。</p>
<p>下面的例子说明了上表中所示的 CA 密钥和证书文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/kubernetes/pki/ca.crt</span><br><span class="line">/etc/kubernetes/pki/ca.key</span><br><span class="line">/etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">/etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class="line">/etc/kubernetes/pki/front-proxy-ca.key</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/best-practices/certificates/#how-certificates-are-used-by-your-cluster"><code>PKI</code>证书和要求</a></p>
</blockquote>
<h3 id="etcd集群-含CA"><a href="#etcd集群-含CA" class="headerlink" title="etcd集群(含CA)"></a><code>etcd</code>集群(含<code>CA</code>)</h3><p><a href="./ebede6de">安装<code>etcd</code>集群(含CA)</a></p>
<h3 id="列出镜像版本"><a href="#列出镜像版本" class="headerlink" title="列出镜像版本"></a>列出镜像版本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list</span><br><span class="line">kubeadm config images pull</span><br></pre></td></tr></table></figure>

<h3 id="配置文件创建master-节点（强建议）"><a href="#配置文件创建master-节点（强建议）" class="headerlink" title="配置文件创建master 节点（强建议）"></a>配置文件创建<code>master</code> 节点（强建议）</h3><blockquote>
<p><a href="./cdb1e23h">通过配置文件创建集群节点</a></p>
</blockquote>
<p>写入配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入配置</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ~/kubeadm-config-init.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="string">kind: InitConfiguration</span></span><br><span class="line"><span class="string">bootstrapTokens:</span></span><br><span class="line"><span class="string">- groups:</span></span><br><span class="line"><span class="string">  - system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="string">  token: fk3wpg.gs0mcv4twx3tz2mc</span></span><br><span class="line"><span class="string">  ttl: 240h0m0s</span></span><br><span class="line"><span class="string">  usages:</span></span><br><span class="line"><span class="string">  - signing</span></span><br><span class="line"><span class="string">  - authentication</span></span><br><span class="line"><span class="string">  description: &quot;描述设置了一个人性化的消息，为什么这个令牌存在以及它的用途&quot; </span></span><br><span class="line"><span class="string"># NodeRegistration 包含与将新控制平面节点注册到集群相关的字段</span></span><br><span class="line"><span class="string">nodeRegistration:</span></span><br><span class="line"><span class="string">  name: master-158</span></span><br><span class="line"><span class="string">  criSocket: unix:///var/run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">  ignorePreflightErrors:</span></span><br><span class="line"><span class="string">    - IsPrivilegedUser</span></span><br><span class="line"><span class="string"># LocalAPIEndpoint表示部署在这个控制平面节点上的API服务器实例的端点。</span></span><br><span class="line"><span class="string">localAPIEndpoint:</span></span><br><span class="line"><span class="string">  advertiseAddress: 192.168.2.158</span></span><br><span class="line"><span class="string">  bindPort: 6443</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">clusterName: k8s-cluster</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  external:</span></span><br><span class="line"><span class="string">    endpoints:</span></span><br><span class="line"><span class="string">      - &quot;https://192.168.2.158:2379&quot;</span></span><br><span class="line"><span class="string">      - &quot;https://192.168.2.159:2379&quot;</span></span><br><span class="line"><span class="string">      - &quot;https://192.168.2.160:2379&quot;</span></span><br><span class="line"><span class="string">    caFile: &quot;/etc/certs/etcd/ca.pem&quot;</span></span><br><span class="line"><span class="string">    certFile: &quot;/etc/certs/etcd/etcd-158.pem&quot;</span></span><br><span class="line"><span class="string">    keyFile: &quot;/etc/certs/etcd/etcd-158-key.pem&quot;</span></span><br><span class="line"><span class="string"># 网络持有集群的网络拓扑结构的配置</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  dnsDomain: cluster.158</span></span><br><span class="line"><span class="string">  serviceSubnet: 10.96.0.0/16</span></span><br><span class="line"><span class="string">  podSubnet: &quot;10.244.0.0/16&quot;</span></span><br><span class="line"><span class="string">kubernetesVersion: 1.24.1</span></span><br><span class="line"><span class="string">controlPlaneEndpoint: &quot;192.168.2.158:6443&quot;</span></span><br><span class="line"><span class="string"># APIServer 包含 API 服务器控制平面组件的额外设置</span></span><br><span class="line"><span class="string">apiServer:</span></span><br><span class="line"><span class="string">  extraArgs:</span></span><br><span class="line"><span class="string">    bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">    authorization-mode: &quot;Node,RBAC&quot;</span></span><br><span class="line"><span class="string">    #service-cluster-ip-range: 10.96.0.0/16</span></span><br><span class="line"><span class="string">    #service-node-port-range: 30000-32767</span></span><br><span class="line"><span class="string">  timeoutForControlPlane: 4m0s</span></span><br><span class="line"><span class="string">  certSANs:</span></span><br><span class="line"><span class="string">  - &quot;localhost&quot;</span></span><br><span class="line"><span class="string">  - &quot;cluster.158&quot;</span></span><br><span class="line"><span class="string">  - &quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="string">  - &quot;master-158&quot;</span></span><br><span class="line"><span class="string">  - &quot;master-159&quot;</span></span><br><span class="line"><span class="string">  - &quot;master-160&quot;</span></span><br><span class="line"><span class="string">  - &quot;node-161&quot;</span></span><br><span class="line"><span class="string">  - &quot;10.96.0.1&quot;</span></span><br><span class="line"><span class="string">  - &quot;10.244.0.1&quot;</span></span><br><span class="line"><span class="string">  - &quot;192.168.2.158&quot;</span></span><br><span class="line"><span class="string">  - &quot;192.168.2.159&quot;</span></span><br><span class="line"><span class="string">  - &quot;192.168.2.160&quot;</span></span><br><span class="line"><span class="string">  - &quot;192.168.2.161&quot;</span></span><br><span class="line"><span class="string">  - &quot;host158&quot;</span></span><br><span class="line"><span class="string">  - &quot;host159&quot;</span></span><br><span class="line"><span class="string">  - &quot;host160&quot;</span></span><br><span class="line"><span class="string">  - &quot;host161&quot;</span></span><br><span class="line"><span class="string">#  包含控制器管理器控制平面组件的额外设置</span></span><br><span class="line"><span class="string">controllerManager:</span></span><br><span class="line"><span class="string">  extraArgs:</span></span><br><span class="line"><span class="string">    bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">    #&quot;node-cidr-mask-size&quot;: &quot;20&quot;</span></span><br><span class="line"><span class="string">    # 这里与 KubeProxyConfiguration.clusterCIDR 一致</span></span><br><span class="line"><span class="string">    #cluster-cidr: 10.244.0.0/16</span></span><br><span class="line"><span class="string">    #service-cluster-ip-range: 10.96.0.0/16</span></span><br><span class="line"><span class="string">    #config: /etc/kubernetes/scheduler-config.yaml </span></span><br><span class="line"><span class="string">  #extraVolumes:</span></span><br><span class="line"><span class="string">  #  - name: schedulerconfig</span></span><br><span class="line"><span class="string">  #    hostPath: /home/johndoe/schedconfig.yaml</span></span><br><span class="line"><span class="string">  #    mountPath: /etc/kubernetes/scheduler-config.yaml</span></span><br><span class="line"><span class="string">  #    readOnly: true</span></span><br><span class="line"><span class="string">  #    pathType: &quot;File&quot;</span></span><br><span class="line"><span class="string">  #    调度程序包含调度程序控制平面组件的额外设置</span></span><br><span class="line"><span class="string">scheduler:</span></span><br><span class="line"><span class="string">  extraArgs:</span></span><br><span class="line"><span class="string">    bind-address: 0.0.0.0</span></span><br><span class="line"><span class="string">    #config: /etc/kubernetes/kubescheduler-config.yaml</span></span><br><span class="line"><span class="string">  #extraVolumes:</span></span><br><span class="line"><span class="string">  #  - hostPath: /etc/kubernetes/kubescheduler-config.yaml</span></span><br><span class="line"><span class="string">  #    mountPath: /etc/kubernetes/kubescheduler-config.yaml</span></span><br><span class="line"><span class="string">  #    name: kubescheduler-config</span></span><br><span class="line"><span class="string">  #    readOnly: true</span></span><br><span class="line"><span class="string">#      DNS 定义集群中安装的 DNS 插件的选项。</span></span><br><span class="line"><span class="string">dns: &#123;&#125;</span></span><br><span class="line"><span class="string">certificatesDir: /etc/kubernetes/pki</span></span><br><span class="line"><span class="string">#imageRepository: k8s.gcr.io</span></span><br><span class="line"><span class="string">imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="string">#用户启用的 FeatureGates。</span></span><br><span class="line"><span class="string">#featureGates:</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">bindAddress: 0.0.0.0</span></span><br><span class="line"><span class="string">bindAddressHardFail: false</span></span><br><span class="line"><span class="string">clientConnection:</span></span><br><span class="line"><span class="string">  acceptContentTypes: &quot;&quot;</span></span><br><span class="line"><span class="string">  burst: 0</span></span><br><span class="line"><span class="string">  contentType: &quot;&quot;</span></span><br><span class="line"><span class="string">  kubeconfig: /var/lib/kube-proxy/kubeconfig.conf</span></span><br><span class="line"><span class="string">  qps: 0</span></span><br><span class="line"><span class="string">clusterCIDR: 10.244.0.0/16</span></span><br><span class="line"><span class="string">configSyncPeriod: 2s </span></span><br><span class="line"><span class="string">conntrack: </span></span><br><span class="line"><span class="string">  maxPerCore: null </span></span><br><span class="line"><span class="string">  min: null </span></span><br><span class="line"><span class="string">  tcpCloseWaitTimeout: 60s </span></span><br><span class="line"><span class="string">  tcpEstablishedTimeout: 2s</span></span><br><span class="line"><span class="string">  # 默认 LocalModeClusterCIDR</span></span><br><span class="line"><span class="string">detectLocalMode: &quot;&quot;</span></span><br><span class="line"><span class="string">detectLocal:</span></span><br><span class="line"><span class="string">  bridgeInterface: &quot;&quot;</span></span><br><span class="line"><span class="string">  interfaceNamePrefix: &quot;&quot; </span></span><br><span class="line"><span class="string">enableProfiling: false</span></span><br><span class="line"><span class="string">healthzBindAddress: &quot;0.0.0.0:10256&quot;</span></span><br><span class="line"><span class="string">hostnameOverride: &quot;kube-proxy-158&quot;</span></span><br><span class="line"><span class="string">ipvs:</span></span><br><span class="line"><span class="string">  excludeCIDRs: null</span></span><br><span class="line"><span class="string">  minSyncPeriod: 1m</span></span><br><span class="line"><span class="string">  scheduler: &quot;&quot;</span></span><br><span class="line"><span class="string">  strictARP: true</span></span><br><span class="line"><span class="string">  syncPeriod: 1m</span></span><br><span class="line"><span class="string">  tcpFinTimeout: 0s</span></span><br><span class="line"><span class="string">  tcpTimeout: 0s</span></span><br><span class="line"><span class="string">  udpTimeout: 0s</span></span><br><span class="line"><span class="string">metricsBindAddress: &quot;127.0.0.1:10249&quot;</span></span><br><span class="line"><span class="string">mode: &quot;ipvs&quot;</span></span><br><span class="line"><span class="string">nodePortAddresses: null</span></span><br><span class="line"><span class="string">oomScoreAdj: null</span></span><br><span class="line"><span class="string">portRange: &quot;&quot;</span></span><br><span class="line"><span class="string">showHiddenMetricsForVersion: &quot;&quot;</span></span><br><span class="line"><span class="string">udpIdleTimeout: 0s</span></span><br><span class="line"><span class="string">winkernel:</span></span><br><span class="line"><span class="string">  enableDSR: false</span></span><br><span class="line"><span class="string">  forwardHealthCheckVip: false</span></span><br><span class="line"><span class="string">  networkName: &quot;&quot;</span></span><br><span class="line"><span class="string">  rootHnsEndpointName: &quot;&quot;</span></span><br><span class="line"><span class="string">  sourceVip: &quot;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-config-init.yaml  --v=5</span><br></pre></td></tr></table></figure>

<h3 id="直接创建-master节点（不建议）"><a href="#直接创建-master节点（不建议）" class="headerlink" title="直接创建 master节点（不建议）"></a>直接创建 <code>master</code>节点（不建议）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init \</span><br><span class="line">--node-name master-158 \</span><br><span class="line"><span class="comment"># 用于指定`kube-apiserver`监听的`ip`地址，就是`master`本机`IP`地址</span></span><br><span class="line">--apiserver-advertise-address=192.168.2.158 \</span><br><span class="line"><span class="comment">## 指定阿里云镜像仓库地址</span></span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers \ </span><br><span class="line"><span class="comment"># 用于指定`k8s`版本(`kubeadm config images list`查看的)</span></span><br><span class="line">--kubernetes-version v1.24.1 \ </span><br><span class="line"><span class="comment"># 用于指定`SVC`的网络范围</span></span><br><span class="line">--service-cidr=10.96.0.0/16 \</span><br><span class="line"><span class="comment"># 用于指定`Pod`的网络范围：`10.244.0.0/16`</span></span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519114218846.png" alt="image-20220519114218846"></p>
<h3 id="非Root用户运行kubectl配置"><a href="#非Root用户运行kubectl配置" class="headerlink" title="非Root用户运行kubectl配置"></a>非Root用户运行<code>kubectl</code>配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 普通用户</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="comment"># root 可以直接执行</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<h3 id="加入当前集群"><a href="#加入当前集群" class="headerlink" title="加入当前集群"></a>加入当前集群</h3><h4 id="host158上生成加入节点的脚本："><a href="#host158上生成加入节点的脚本：" class="headerlink" title="host158上生成加入节点的脚本："></a><code>host158</code>上生成加入节点的脚本：</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<h4 id="host159加入"><a href="#host159加入" class="headerlink" title="host159加入"></a><code>host159</code>加入</h4><p>证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 158 上执行</span></span><br><span class="line">ssh root@192.168.2.159 <span class="string">&quot;mkdir -p /etc/kubernetes/pki&quot;</span></span><br><span class="line">scp -r /etc/kubernetes/pki/*  root@192.168.2.159:/etc/kubernetes/pki</span><br></pre></td></tr></table></figure>

<p>加入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在159上执行：添加加 master-159 节点</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.2.158:6443 --node-name master-159 --token fk3wpg.gs0mcv4twx3tz2mc \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:533e488affe662b66310ed8a353b1fba17c354e4c0df5285b95a01a33e986219 \</span><br><span class="line">        --control-plane --v=5</span><br></pre></td></tr></table></figure>

<p>配置和校验</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="#error_jwt"><code>configmap jwt token 错误</code></a></p>
</blockquote>
<h4 id="host160加入"><a href="#host160加入" class="headerlink" title="host160加入"></a><code>host160</code>加入</h4><p>证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 158 上执行</span></span><br><span class="line">ssh root@192.168.2.160 <span class="string">&quot;mkdir -p /etc/kubernetes/pki&quot;</span></span><br><span class="line">scp -r /etc/kubernetes/pki/*  root@192.168.2.160:/etc/kubernetes/pki</span><br></pre></td></tr></table></figure>

<p>加入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在160上执行：添加 master-160 节点</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.2.158:6443 --node-name master-160 --token fk3wpg.gs0mcv4twx3tz2mc \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:533e488affe662b66310ed8a353b1fba17c354e4c0df5285b95a01a33e986219 \</span><br><span class="line">        --control-plane --v=5</span><br></pre></td></tr></table></figure>

<p>配置和校验</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<h4 id="host161加入"><a href="#host161加入" class="headerlink" title="host161加入"></a><code>host161</code>加入</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加普通节点</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.2.158:6443 --node-name node-161 --token fk3wpg.gs0mcv4twx3tz2mc \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:533e488affe662b66310ed8a353b1fba17c354e4c0df5285b95a01a33e986219 --v=5</span><br></pre></td></tr></table></figure>

<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220529185350418.png" alt="image-20220529185350418"></p>
<p><code>--experimental-control-plane</code> 作为控制节点加入</p>
<p>在控制节点 <code>host158</code> 上执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220529185643763.png" alt="image-20220529185643763"></p>
<h4 id="token"><a href="#token" class="headerlink" title="token"></a><code>token</code></h4><p>获取令牌：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519143852023.png" alt="image-20220519143852023"></p>
<p>创建新令牌</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create</span><br></pre></td></tr></table></figure>

<p>输出类似于以下内容：</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5didvk.d09sbcov8ph2amjw</span><br></pre></td></tr></table></figure>

<p>直接创建加入脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command --ttl=240h </span><br></pre></td></tr></table></figure>

<p>如果你没有 <code>--discovery-token-ca-cert-hash</code> 的值，则可以通过在控制平面节点上执行以下命令链来获取它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认证书 /etc/kubernetes/pki/ca.crt</span></span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | \</span><br><span class="line">openssl dgst -sha256 -hex | sed <span class="string">&#x27;s/^.* //&#x27;</span></span><br></pre></td></tr></table></figure>

<p>输出类似于以下内容：</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">5094a16f108636a64edc65194ef8f61b446f831ebab3265dda5723a394030ee1</span><br></pre></td></tr></table></figure>

<h3 id="查看证书"><a href="#查看证书" class="headerlink" title="查看证书"></a>查看证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">kubeadm alpha certs check-expiration</span><br><span class="line"><span class="comment"># 更新证书</span></span><br><span class="line">kubeadm alpha certs renew all</span><br></pre></td></tr></table></figure>

<h3 id="init-时的几个配置"><a href="#init-时的几个配置" class="headerlink" title="init 时的几个配置"></a>init 时的几个配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/etc/kubernetes</span><br><span class="line"><span class="comment"># certificate-authority-data:  cat /etc/kubernetes/pki/ca.crt | base64 -w 0</span></span><br><span class="line">/etc/kubernetes/kubelet.conf  </span><br><span class="line"><span class="comment">#kubelet</span></span><br><span class="line">/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">/var/lib/kubelet/config.yaml</span><br><span class="line"><span class="comment"># manifest</span></span><br><span class="line">/etc/kubernetes/manifests</span><br></pre></td></tr></table></figure>

<h2 id="五、安装pods网络插件"><a href="#五、安装pods网络插件" class="headerlink" title="五、安装pods网络插件"></a>五、安装<code>pods</code>网络插件</h2><ul>
<li><code>Flannel</code>: 最成熟、最简单的选择（当前选择）</li>
<li><code>Calico</code>: 性能好、灵活性最强，目前的企业级主流</li>
<li><code>Canal</code>: 将<code>Flannel</code>提供的网络层与<code>Calico</code>的网络策略功能集成在一起。</li>
<li><code>Weave</code>: 独有的功能，是对整个网络的简单加密，会增加网络开销</li>
<li><code>Kube-router</code>: kube-router采用<code>lvs</code>实现<code>svc</code>网络,采用<code>bgp</code>实现pod网络.</li>
<li><code>CNI-Genie</code>：<code>CNI-Genie</code> 是一个可以让<code>k8s</code>使用多个<code>cni</code>网络插件的组件，暂时不支持隔离策略</li>
</ul>
<p><code>k8s</code>的容器虚拟化网络方案大体分为两种： 基于隧道方案和基于路由方案</p>
<ul>
<li>隧道方案：<code>flannel</code>的 <code>vxlan</code>模式、<code>calico</code>的<code>ipip</code>模式都是隧道模式。</li>
<li>路由方案：<code>flannel</code>的<code>host-gw</code>模式，<code>calico</code>的<code>bgp</code>模式都是路由方案</li>
</ul>
<h3 id="calico-安装（推荐）"><a href="#calico-安装（推荐）" class="headerlink" title="calico 安装（推荐）"></a><code>calico</code> 安装（推荐）</h3><p><a href="./ebede6df"><code>k8s</code>安装pods网络插件calico（<code>etcd+tls</code>）</a></p>
<blockquote>
<p><a href="#containerdreport"><code>Containerd</code> 镜像配置</a></p>
<p><a href="https://github.com/projectcalico/calico"> <code>calic0oGitHub</code> </a></p>
</blockquote>
<h3 id="Fiannel安装"><a href="#Fiannel安装" class="headerlink" title="Fiannel安装"></a><code>Fiannel</code>安装</h3><p>在 <code>master</code>上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"><span class="comment"># 可选参数 --no-check-certificate</span></span><br><span class="line">wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml -O kube-flannel.yml</span><br><span class="line"><span class="comment"># 或者,直接使用没有指定网卡，可能会使 flannel处在CrashLoopBackOff状态</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>建议 <code>flannel</code> 使用 <code>Kubernetes API</code> 作为其后备存储，这样可以避免为 <code>flannel</code> 部署离散的 <code>etcd</code> 集群。</p>
<p><a href="https://github.com/flannel-io/flannel#flannel"><code>Flannel GitHub</code>地址</a></p>
</blockquote>
<h4 id="修改-kube-flannel-yml"><a href="#修改-kube-flannel-yml" class="headerlink" title="修改 kube-flannel.yml"></a>修改 <code>kube-flannel.yml</code></h4><p>添加网卡</p>
<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220529194923226.png" alt="image-20220529194923226"></p>
<blockquote>
<p>不添加网卡会报错  <code>Failed to find any valid interface to use: failed to get default interface: protocol not available</code></p>
<p>错误：<code>Failed to find interface</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Could not find valid interface matching ens33: failed to find IPv4 address <span class="keyword">for</span> interface ens33</span><br><span class="line">Failed to find interface to use that matches the interfaces and/or regexes provided</span><br></pre></td></tr></table></figure>

<p>进入容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system <span class="built_in">exec</span> -it kube-flannel-ds-f92wg sh</span><br><span class="line">kubectl -n kube-system <span class="built_in">exec</span> -it kube-flannel-ds-f92wg bash</span><br></pre></td></tr></table></figure>
</blockquote>
<p>修改网段</p>
<p><code>kubeadm init</code> 时自定义的<code>--pod-network-cidr=10.244.0.0/16</code> 如果有变动，则需要修改  <code>kube-flannel.yml</code></p>
<p>加载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml </span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519114713469.png" alt="image-20220519114713469"></p>
<p>查看容器配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get ds kube-flannel-ds -o yaml</span><br></pre></td></tr></table></figure>

<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519114825112.png" alt="image-20220519114825112"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -n kube-system kube-flannel-ds-88xsf -f</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519143532444.png" alt="image-20220519143532444"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7cff00e253f4">kube-proxy ipvs 模式源码分析</a></p>
<p><a target="_blank" rel="noopener" href="http://events.jianshu.io/p/a057bbc98936">使用ipvs负载均衡</a></p>
</blockquote>
<h3 id="获取节点"><a href="#获取节点" class="headerlink" title="获取节点"></a>获取节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519114512672.png" alt="image-20220519114512672"></p>
<h1 id="etcd-集群指南"><a href="#etcd-集群指南" class="headerlink" title="etcd 集群指南"></a><code>etcd</code> 集群指南</h1><p><a href="./ebede6de">安装<code>etcd</code>集群</a></p>
<h3 id="校验运行状态"><a href="#校验运行状态" class="headerlink" title="校验运行状态"></a>校验运行状态</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 /opt/etcd/etcdctl \</span><br><span class="line">  --endpoints 192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379 \</span><br><span class="line">  --cacert /etc/certs/etcd-root-ca.pem \</span><br><span class="line">  --cert /etc/certs/etcd-158.pem \</span><br><span class="line">  --key /etc/certs/etcd-158-key.pem \</span><br><span class="line">  endpoint health</span><br><span class="line">  </span><br><span class="line">ENDPOINTS=192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379</span><br><span class="line">ETCD_AUTH=<span class="string">&#x27;--cacert /etc/certs/etcd-root-ca.pem --cert /etc/certs/etcd-158.pem --key /etc/certs/etcd-158-key.pem &#x27;</span></span><br><span class="line">etcdctl --write-out=table --endpoints=<span class="variable">$&#123;ENDPOINTS&#125;</span> <span class="variable">$&#123;ETCD_AUTH&#125;</span> --user=root:1 endpoint status</span><br></pre></td></tr></table></figure>

<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220529234008606.png" alt="image-20220529234008606"></p>
<h3 id="要动-Kubernetes-API-服务参数"><a href="#要动-Kubernetes-API-服务参数" class="headerlink" title="要动 Kubernetes API 服务参数"></a>要动 <code>Kubernetes API</code> 服务参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务地址（可以使用负载均衡）</span></span><br><span class="line">--etcd-servers=192.168.2.158:2379,192.168.2.159:2379,192.168.2.160:2379</span><br><span class="line"><span class="comment"># 安全通信 </span></span><br><span class="line">--etcd-certfile=/etc/certs/etcd-158.pem</span><br><span class="line">--etcd-keyfile=/etc/certs/etcd-158-key.pem</span><br><span class="line">--etcd-cafile=/etc/certs/etcd-root-ca.pem</span><br></pre></td></tr></table></figure>

<h2 id="配置kubelet"><a href="#配置kubelet" class="headerlink" title="配置kubelet"></a>配置<code>kubelet</code></h2><p>由于 <code>etcd</code> 是首先创建的，因此你必须通过创建具有更高优先级的新文件来覆盖 <code>kubeadm</code> 提供的 <code>kubelet</code> 单元文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原文件 </span></span><br><span class="line">sudo <span class="built_in">cat</span> /etc/systemd/system/multi-user.target.wants/kubelet.service</span><br><span class="line">sudo <span class="built_in">mkdir</span> /etc/systemd/system/kubelet.service.d/</span><br><span class="line">sudo <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/systemd/system/kubelet.service.d/20-etcd-service-manager.conf </span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=</span></span><br><span class="line"><span class="string"># 将下面的 &quot;systemd&quot; 替换为你的容器运行时所使用的 cgroup 驱动。</span></span><br><span class="line"><span class="string"># kubelet 的默认值为 &quot;cgroupfs&quot;。</span></span><br><span class="line"><span class="string"># 如果需要的话，将 &quot;--container-runtime-endpoint &quot; 的值替换为一个不同的容器运行时。</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br><span class="line">sudo systemctl status kubelet</span><br><span class="line">journalctl -xeu kubelet</span><br><span class="line"><span class="built_in">cat</span> /etc/kubernetes/manifests/etcd.yaml</span><br><span class="line"><span class="built_in">cat</span> /etc/kubernetes/kubelet.conf</span><br><span class="line"><span class="built_in">cat</span> /var/lib/kubelet/config.yaml</span><br><span class="line"><span class="built_in">cat</span> /etc/kubernetes/bootstrap-kubelet.conf</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/best-practices/certificates/">https://kubernetes.io/zh/docs/setup/best-practices/certificates/</a>)</p>
</blockquote>
<h1 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml -O recommended.yaml --no-check-certificate</span><br><span class="line">kubectl apply -f recommended.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519115844935.png" alt="image-20220519115844935"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br><span class="line">kubectl describe pod -n kubernetes-dashboard kubernetes-dashboard-6cdd697d84-9nv4w</span><br><span class="line">kubectl logs -f -n kubernetes-dashboard kubernetes-dashboard-6cdd697d84-9nv4w</span><br></pre></td></tr></table></figure>

<p>启用 <code>Dashboard</code> 访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://192.168.2.150/:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/"><code>http://192.168.2.150/:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</code></a></p>
<h4 id="创建管理员"><a href="#创建管理员" class="headerlink" title="创建管理员"></a>创建管理员</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/dashboard-admin.yaml </span><br></pre></td></tr></table></figure>

<p>写入</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为用户分配权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/dashboard-admin-bind-cluster-role.yaml </span><br></pre></td></tr></table></figure>

<p>写入</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin-bind-cluster-role</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>

<p>分配权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f ~/dashboard-admin.yaml</span><br><span class="line">kubectl create -f ~/dashboard-admin-bind-cluster-role.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519120532859.png" alt="image-20220519120532859"></p>
<p>查看并复制Token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep dashboard-admin | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>访问，用刚刚的token登录</p>
<p><a target="_blank" rel="noopener" href="https://192.168.2.150:30000/"><code>https://192.168.2.150:30000</code></a></p>
<h1 id="部署应用"><a href="#部署应用" class="headerlink" title="部署应用"></a>部署应用</h1><p><strong>在Kubernetes<strong><strong>集群中部署一个Nginx</strong></strong>：</strong></p>
<p>kubectl create deployment nginx –image&#x3D;nginx</p>
<p>kubectl expose deployment nginx –port&#x3D;80 –type&#x3D;NodePort</p>
<p>kubectl get pod,svc</p>
<p>访问地址：<a href="http://nodeip:Port/">http://NodeIP:Port</a></p>
<p><strong>在Kubernetes<strong><strong>集群中部署一个Tomcat</strong></strong>：</strong></p>
<p>kubectl create deployment tomcat –image&#x3D;tomcat</p>
<p>kubectl expose deployment tomcat –port&#x3D;8080 –type&#x3D;NodePort</p>
<p>访问地址：<a href="http://nodeip:Port/">http://NodeIP:Port</a></p>
<p><strong>K8s<strong><strong>部署微服务（springboot</strong></strong>程序）</strong></p>
<p>1、项目打包（jar、war）–&gt;可以采用一些工具git、maven、jenkins</p>
<p>2、制作Dockerfile文件，生成镜像；</p>
<p>3、kubectl create deployment nginx –image&#x3D; 你的镜像</p>
<p>4、你的springboot就部署好了，是以docker容器的方式运行在pod里面的；</p>
<h1 id="卸载集群"><a href="#卸载集群" class="headerlink" title="卸载集群"></a>卸载集群</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除对集群的本地引用,集群名称 k8s-cluster</span></span><br><span class="line">kubectl config delete-cluster k8s-cluster</span><br><span class="line"><span class="comment"># 重置 `kubeadm` 安装的状态</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;y&quot;</span> | kubeadm reset</span><br><span class="line"><span class="comment"># 删除节点信息</span></span><br><span class="line"><span class="built_in">rm</span> -rf /etc/kubernetes/</span><br><span class="line"><span class="comment"># 删除本地配置</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="comment"># 删除网路</span></span><br><span class="line"><span class="comment"># rm -rf /var/lib/kubelet/</span></span><br></pre></td></tr></table></figure>

<p>删除 <code>calico</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除 cni</span></span><br><span class="line"><span class="built_in">rm</span> -rf /etc/cni/net.d/</span><br><span class="line"><span class="comment"># 删除 calico</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/log/calico/</span><br></pre></td></tr></table></figure>

<h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><p>使用适当的凭证与控制平面节点通信，运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain &lt;node name&gt; --delete-emptydir-data --force --ignore-daemonsets</span><br></pre></td></tr></table></figure>

<p>在删除节点之前，请重置 <code>kubeadm</code> 安装的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;y&quot;</span> | kubeadm reset</span><br></pre></td></tr></table></figure>

<p>重置过程不会重置或清除 iptables 规则或 IPVS 表。如果你希望重置 iptables，则必须手动进行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br></pre></td></tr></table></figure>

<p>如果要重置 IPVS 表，则必须运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -C</span><br><span class="line">ipvsadm --clear</span><br></pre></td></tr></table></figure>

<p>现在删除节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete node &lt;node name&gt;</span><br></pre></td></tr></table></figure>

<p>如果你想重新开始，只需运行 <code>kubeadm init</code> 或 <code>kubeadm join</code> 并加上适当的参数。</p>
<h2 id="卸载-Containerd-io"><a href="#卸载-Containerd-io" class="headerlink" title="卸载 Containerd.io"></a>卸载 <code>Containerd.io</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove -y containerd.io</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/containerd</span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://i4t.com/5435.html">Kubernetes容器运行时弃用Docker转型Containerd</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40612128/article/details/123579086">Kubernetes02：容器运行时：Docker or Containerd如何选择、Containerd全面上手实践</a></p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="CentOS7镜像"><a href="#CentOS7镜像" class="headerlink" title="CentOS7镜像"></a><code>CentOS7</code>镜像<span id="repo"></span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份</span></span><br><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line"><span class="comment"># 下载源文件</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment"># 生成缓存</span></span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>

<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker "></a><code>Docker</code> <span id="docker-repo"></span></h3><blockquote>
<p>虚拟机需要挂载<code>ISO</code>镜像</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要挂载 ISO 镜像</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /mnt/cdrom</span><br><span class="line">sudo mount /dev/cdrom /mnt/cdrom/</span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h3 id="使用阿里云"><a href="#使用阿里云" class="headerlink" title="使用阿里云"></a>使用阿里云</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="comment"># Step 2: 添加软件源信息</span></span><br><span class="line">sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># Step 3</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo yum makecache fast</span><br></pre></td></tr></table></figure>

<h3 id="Containerd-镜像"><a href="#Containerd-镜像" class="headerlink" title="Containerd 镜像 "></a><code>Containerd</code> 镜像 <span id="containerdreport"></span></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>

<p>找到 <code> [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</code></p>
<p>写入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">                endpoint = [<span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<span class="string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span>,<span class="string">&quot;https://registry.docker-cn.com&quot;</span>,<span class="string">&quot;https://aj2rgad5.mirror.aliyuncs.com&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220601111938470.png" alt="image-20220601111938470"></p>
<h2 id="Kubelet启动失败问题"><a href="#Kubelet启动失败问题" class="headerlink" title="Kubelet启动失败问题"></a><code>Kubelet</code>启动失败问题</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl -xefu kubelet</span><br><span class="line">journalctl -f -u kubelet</span><br></pre></td></tr></table></figure>

<h2 id="问题处理"><a href="#问题处理" class="headerlink" title="问题处理"></a>问题处理</h2><h3 id="pod-kube-proxy-CrashLoopBackOff"><a href="#pod-kube-proxy-CrashLoopBackOff" class="headerlink" title="pod/kube-proxy CrashLoopBackOff"></a><code>pod/kube-proxy CrashLoopBackOff</code></h3><p>查看 <code>ipvs</code>安装步骤。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#确定检测本地流量的方式，默认为 LocalModeClusterCIDR</span></span><br><span class="line"><span class="attr">detectLocalMode:</span> <span class="string">&quot;&quot;</span> <span class="comment"># 这里不需要填默认值</span></span><br></pre></td></tr></table></figure>

<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><h3 id="could-not-find-a-JWS-signature-in-the-cluster-info-ConfigMap"><a href="#could-not-find-a-JWS-signature-in-the-cluster-info-ConfigMap" class="headerlink" title=" could not find a JWS signature in the cluster-info ConfigMap"></a><code> could not find a JWS signature in the cluster-info ConfigMap</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kube config 命令查看 cluster-info </span></span><br><span class="line">kubectl get configmap cluster-info --namespace=kube-public -o yaml</span><br><span class="line"><span class="built_in">cat</span> /etc/kubernetes/kubelet.conf</span><br><span class="line"><span class="comment"># 可能是CA不对。</span></span><br><span class="line"><span class="comment"># 重新生成 hash256</span></span><br><span class="line"><span class="comment"># 默认证书 /etc/kubernetes/pki/ca.crt</span></span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/etcd/etcd-ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | \</span><br><span class="line">openssl dgst -sha256 -hex | sed <span class="string">&#x27;s/^.* //&#x27;</span></span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | \</span><br><span class="line">openssl dgst -sha256 -hex | sed <span class="string">&#x27;s/^.* //&#x27;</span></span><br><span class="line"><span class="comment"># 对比之后发现，真的CA不对</span></span><br></pre></td></tr></table></figure>

<h3 id="join-时的-JWS-问题"><a href="#join-时的-JWS-问题" class="headerlink" title="join 时的 JWS 问题"></a><code>join</code> 时的 <code>JWS</code> 问题</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The cluster-info ConfigMap does not yet contain a JWS signature for token ID &quot;j2lxkq&quot;, will try again</span><br></pre></td></tr></table></figure>

<p>这里  <code>kubeadm token list</code> 可以看到 <code>token</code> 都很正常。</p>
<p>cluster info中的 <code>JWS</code> 需要在<code>kube-controller-manager</code>运行后创建。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -A</span><br></pre></td></tr></table></figure>

<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220602104516917.png" alt="image-20220602104516917"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">kubectl describe -n kube-system  kube-controller-manager-master-158</span><br><span class="line">kubectl logs -n kube-system  kube-controller-manager-master-158</span><br><span class="line">kubectl logs -n kube-system  kube-controller-manager-master-158 --v=10</span><br></pre></td></tr></table></figure>

<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220602104739590.png" alt="image-20220602104739590"></p>
<h3 id="节点NotReady"><a href="#节点NotReady" class="headerlink" title="节点NotReady"></a>节点<code>NotReady</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe nodes master-160</span><br></pre></td></tr></table></figure>

<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220603102357056.png" alt="image-20220603102357056"></p>
<h3 id="cni-plugin-not-initialized"><a href="#cni-plugin-not-initialized" class="headerlink" title="cni plugin not initialized"></a><code>cni plugin not initialized</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart containerd</span><br></pre></td></tr></table></figure>

<h3 id="failed-to-quot-CreatePodSandbox-quot-for-quot-coredns"><a href="#failed-to-quot-CreatePodSandbox-quot-for-quot-coredns" class="headerlink" title="failed to \&quot;CreatePodSandbox\&quot; for \&quot;coredns"></a><code>failed to \&quot;CreatePodSandbox\&quot; for \&quot;coredns</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no such file or directory: check that the calico/node container is running and has mounted /var/lib/calico/\&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>是因为<code>calico</code> 没有启动成功</p>
<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Node状态</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="comment"># 节点IP可以用空格隔开写多个</span></span><br><span class="line">kubectl get node master-158</span><br><span class="line"><span class="comment"># 查看 Service 信息</span></span><br><span class="line">kubectl get service</span><br><span class="line"><span class="comment">#查看namespace</span></span><br><span class="line">kubectl get namespaces</span><br><span class="line"><span class="comment"># 创建</span></span><br><span class="line">kubectl create namespace xxxxxx</span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">kubectl delete namespaces xxxxxx</span><br><span class="line"><span class="comment"># 查看所有名称空间内资源</span></span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"><span class="comment">#进入pod里面</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it podName -n uat bash</span><br><span class="line"><span class="comment"># 同时查看多种资源信息</span></span><br><span class="line">kubectl get pod,svc -n kube-system</span><br><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">kubectl create -f xxxx.yaml --namespace=xxxx</span><br><span class="line"><span class="comment"># 查看具体pod的yaml配置信息</span></span><br><span class="line">kubectl get pod -n namespace_name xxxxpod -o=yaml</span><br><span class="line"><span class="comment"># 查看Pod的详细信息，包括记录的事件：</span></span><br><span class="line">kubectl describe pod -n namespace_name xxxxpod</span><br><span class="line"><span class="comment"># 查看节点信息</span></span><br><span class="line">kubectl get pod -n kube-system -l k8s-app=flannel -o wide</span><br><span class="line"><span class="comment"># 删除节点信息：</span></span><br><span class="line">kubectl delete pod -n kube-system 节点名称</span><br><span class="line">kubectl delete pod/节点名称 -n kube-system </span><br><span class="line"><span class="comment"># 查看 API 对象细节</span></span><br><span class="line"><span class="comment"># 使用 kubectl describe 命令，查看一个 API 对象的细节：</span></span><br><span class="line">kubectl describe node master-158</span><br><span class="line"><span class="comment">#kubectl delete node master-158</span></span><br><span class="line"><span class="comment"># 查询 kubeadm 配置文件</span></span><br><span class="line">kubectl describe cm -n kube-system kubeadm-config</span><br><span class="line">kubectl get cm -n kube-system kubeadm-config -o yaml</span><br><span class="line">kubectl describe cm -n kube-system kubelet-config</span><br><span class="line">kubectl describe cm -n kube-system kube-proxy</span><br><span class="line">kubectl get cm -n kube-system coredns -o yaml</span><br><span class="line">kubectl get cm -n kube-system kube-proxy -o yaml</span><br><span class="line">kubectl describe cm -n kube-system   </span><br><span class="line"><span class="comment"># 编辑，编辑后删除响应的pod，k8s 会自动重建</span></span><br><span class="line">kubectl edit cm -n kube-system kubeadm-config</span><br><span class="line">kubectl edit cm -n kube-system kubelet-config</span><br><span class="line">kubectl edit cm -n kube-system kube-proxy</span><br><span class="line">kubectl describe ns default</span><br><span class="line"><span class="comment">#查看k8s监控Dashboard的token</span></span><br><span class="line">kubectl -n kube-system get serviceaccount -l k8s-app=kubernetes-dashboard -o yaml</span><br><span class="line">kubectl -n kube-system describe secrets secrets.name</span><br><span class="line"><span class="comment"># 更新 ConfigMap 内容到本地文件 /var/lib/kubelet/config.conf</span></span><br><span class="line">kubeadm upgrade node phase kubelet-config --v=10</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">kubeadm upgrade node phase control-plane --v=5</span><br><span class="line">kubeadm upgrade node phase preflight --v=5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">kubectl cluster-info</span><br><span class="line"><span class="comment"># Kubernetes master is running at https://127.0.0.1:6443</span></span><br><span class="line"><span class="comment"># 查看各组件信息</span></span><br><span class="line"><span class="comment"># 使用安全连接：</span></span><br><span class="line">kubectl -s https://192.168.2.151 get componentstatuses</span><br><span class="line"><span class="comment"># 未使用安全连接</span></span><br><span class="line">kubectl -s http://192.168.2.151 get componentstatuses</span><br><span class="line"><span class="comment"># 查看资源类型所对应的Apiversion</span></span><br><span class="line">kubectl explain pod</span><br><span class="line"><span class="comment"># 查看帮助</span></span><br><span class="line">kubectl explain deployment</span><br><span class="line">kubectl explain deployment.spec</span><br><span class="line">kubectl explain deployment.spec.replicas</span><br><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">kubectl -n kube-system <span class="built_in">exec</span> -it kube-flannel-ds-f92wg sh</span><br><span class="line">kubectl -n kube-system <span class="built_in">exec</span> -it kube-flannel-ds-f92wg bash</span><br></pre></td></tr></table></figure>

<h2 id="Docker-or-Containerd"><a href="#Docker-or-Containerd" class="headerlink" title="Docker or Containerd"></a><code>Docker or Containerd</code></h2><p><code>kubelet</code> 通过 <code>Container Runtime Interface (CRI)</code> 与容器运行时交互，以管理镜像和容器。</p>
<p>通用的容器运行时：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#containerd">containerd</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#cri-o">CRI-O</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker">Docker</a></li>
</ul>
<p><img src="D:/develop/code/blog_code/source/_posts/Docker/image-20220529003748105.png" alt="image-20220529003748105"></p>
<h3 id="调用链区别有哪些？"><a href="#调用链区别有哪些？" class="headerlink" title="调用链区别有哪些？"></a>调用链区别有哪些？</h3><ul>
<li>Docker 作为 K8S 容器运行时，调用关系如下：<br><code>kubelet --&gt; docker shim （在 kubelet 进程中） --&gt; dockerd --&gt; containerd</code></li>
<li>Containerd 作为 K8S 容器运行时，调用关系如下：<br><code>kubelet --&gt; cri plugin（在 containerd 进程中） --&gt; containerd</code></li>
</ul>
<h3 id="CNI-网络"><a href="#CNI-网络" class="headerlink" title="CNI 网络"></a>CNI 网络</h3><table>
<thead>
<tr>
<th align="left">对比项</th>
<th align="left">Docker</th>
<th align="left">Containerd</th>
</tr>
</thead>
<tbody><tr>
<td align="left">谁负责调用 CNI</td>
<td align="left">Kubelet 内部的 docker-shim</td>
<td align="left">Containerd 内置的 cri-plugin（containerd 1.1 以后）</td>
</tr>
<tr>
<td align="left">如何配置 CNI</td>
<td align="left">Kubelet 参数 <code>--cni-bin-dir</code> 和 <code>--cni-conf-dir</code></td>
<td align="left">Containerd 配置文件（toml）： <code>[plugins.cri.cni]</code> <code>bin_dir = &quot;/opt/cni/bin&quot;</code> <code>conf_dir = &quot;/etc/cni/net.d&quot;</code></td>
</tr>
</tbody></table>
<h3 id="容器日志及相关参数"><a href="#容器日志及相关参数" class="headerlink" title="容器日志及相关参数"></a>容器日志及相关参数</h3><table>
<thead>
<tr>
<th align="left">对比项</th>
<th align="left">Docker</th>
<th align="left">Containerd</th>
</tr>
</thead>
<tbody><tr>
<td align="left">存储路径</td>
<td align="left">如果 Docker 作为 K8S 容器运行时，容器日志的落盘将由 docker 来完成，保存在类似<code>/var/lib/docker/containers/$CONTAINERID</code> 目录下。Kubelet 会在 <code>/var/log/pods</code> 和 <code>/var/log/containers</code> 下面建立软链接，指向 <code>/var/lib/docker/containers/$CONTAINERID</code> 该目录下的容器日志文件。</td>
<td align="left">如果 Containerd 作为 K8S 容器运行时， 容器日志的落盘由 Kubelet 来完成，保存至 <code>/var/log/pods/$CONTAINER_NAME</code> 目录下，同时在 <code>/var/log/containers</code> 目录下创建软链接，指向日志文件。</td>
</tr>
<tr>
<td align="left">配置参数</td>
<td align="left">在 docker 配置文件中指定： <code>&quot;log-driver&quot;: &quot;json-file&quot;,</code> <code>&quot;log-opts&quot;: &#123;&quot;max-size&quot;: &quot;100m&quot;,&quot;max-file&quot;: &quot;5&quot;&#125;</code></td>
<td align="left">方法一：在 kubelet 参数中指定： <code>--container-log-max-files=5--container-log-max-size=&quot;100Mi&quot;</code> 方法二：在 KubeletConfiguration 中指定： <code>&quot;containerLogMaxSize&quot;: &quot;100Mi&quot;,</code> <code>&quot;containerLogMaxFiles&quot;: 5,</code></td>
</tr>
<tr>
<td align="left">把容器日志保存到数据盘</td>
<td align="left">把数据盘挂载到 “data-root”（缺省是 <code>/var/lib/docker</code>）即可。</td>
<td align="left">创建一个软链接 <code>/var/log/pods</code> 指向数据盘挂载点下的某个目录。 在 TKE 中选择“将容器和镜像存储在数据盘”，会自动创建软链接 <code>/var/log/pods</code>。</td>
</tr>
</tbody></table>
<h3 id="容器运行时的选择："><a href="#容器运行时的选择：" class="headerlink" title="容器运行时的选择："></a>容器运行时的选择：</h3><ul>
<li><p><code>kubenetes</code>不支持<code>docker</code>了</p>
</li>
<li><p><code>Containerd</code> 不支持 docker API 和 <code>docker CLI</code>，但是可以通过 <code>cri-tool</code> 命令实现类似的功能。</p>
</li>
<li><p>当您遇到以下情况时，请选择 <code>docker</code> 作为运行时组件：</p>
<ul>
<li>如需使用 <code>docker in docker</code>。</li>
<li>如需在 <code>TKE</code> 节点使用 <code>docker build/push/save/load</code> 等命令。</li>
<li>如需调用 <code>docker API</code>。</li>
<li>如需 <code>docker compose</code> 或 <code>docker swarm</code>。</li>
</ul>
</li>
</ul>
<h2 id="Docker与-Containerd常用命令"><a href="#Docker与-Containerd常用命令" class="headerlink" title="Docker与 Containerd常用命令"></a><code>Docker</code>与 <code>Containerd</code>常用命令</h2><table>
<thead>
<tr>
<th align="left">镜像相关功能</th>
<th align="left">Docker</th>
<th align="left">Containerd</th>
</tr>
</thead>
<tbody><tr>
<td align="left">显示本地镜像列表</td>
<td align="left">docker images</td>
<td align="left">crictl images</td>
</tr>
<tr>
<td align="left">下载镜像</td>
<td align="left">docker pull</td>
<td align="left">crictl pull</td>
</tr>
<tr>
<td align="left">上传镜像</td>
<td align="left">docker push</td>
<td align="left">无</td>
</tr>
<tr>
<td align="left">删除本地镜像</td>
<td align="left">docker rmi</td>
<td align="left">crictl rmi</td>
</tr>
<tr>
<td align="left">查看镜像详情</td>
<td align="left">docker inspect IMAGE-ID</td>
<td align="left">crictl inspect IMAGE-ID</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">容器相关功能</th>
<th align="left">Docker</th>
<th align="left">Containerd</th>
</tr>
</thead>
<tbody><tr>
<td align="left">显示容器列表</td>
<td align="left">docker ps</td>
<td align="left">crictl ps</td>
</tr>
<tr>
<td align="left">创建容器</td>
<td align="left">docker create</td>
<td align="left">crictl create</td>
</tr>
<tr>
<td align="left">启动容器</td>
<td align="left">docker start</td>
<td align="left">crictl start</td>
</tr>
<tr>
<td align="left">停止容器</td>
<td align="left">docker stop</td>
<td align="left">crictl stop</td>
</tr>
<tr>
<td align="left">删除容器</td>
<td align="left">docker rm</td>
<td align="left">crictl rm</td>
</tr>
<tr>
<td align="left">查看容器详情</td>
<td align="left">docker inspect</td>
<td align="left">crictl inspect</td>
</tr>
<tr>
<td align="left">attach</td>
<td align="left">docker attach</td>
<td align="left">crictl attach</td>
</tr>
<tr>
<td align="left">exec</td>
<td align="left">docker exec</td>
<td align="left">crictl exec</td>
</tr>
<tr>
<td align="left">logs</td>
<td align="left">docker logs</td>
<td align="left">crictl logs</td>
</tr>
<tr>
<td align="left">stats</td>
<td align="left">docker stats</td>
<td align="left">crictl stats</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">POD 相关功能</th>
<th align="left">Docker</th>
<th align="left">Containerd</th>
</tr>
</thead>
<tbody><tr>
<td align="left">显示 POD 列表</td>
<td align="left">无</td>
<td align="left">crictl pods</td>
</tr>
<tr>
<td align="left">查看 POD 详情</td>
<td align="left">无</td>
<td align="left">crictl inspectp</td>
</tr>
<tr>
<td align="left">运行 POD</td>
<td align="left">无</td>
<td align="left">crictl runp</td>
</tr>
<tr>
<td align="left">停止 POD</td>
<td align="left">无</td>
<td align="left">crictl stopp</td>
</tr>
</tbody></table>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/cdb1e23a/">https://github.com/maxzhao-it/blog/post/cdb1e23a/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/9c2c35af/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/9c2c35af/" class="post-title-link" itemprop="url">CentOS安装K8S-Kuboard</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-23 17:16:30" itemprop="dateModified" datetime="2022-12-23T17:16:30+08:00">2022-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/K8S/" itemprop="url" rel="index"><span itemprop="name">K8S</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="./21945">安装好<code>docker</code></a></p>
<p><code>dashborad</code> 没有成功</p>
<p>我这里有</p>
<ul>
<li><code>192.168.222.150 master</code></li>
<li><code>192.168.222.151 node</code></li>
<li><code>192.168.222.152 node</code></li>
</ul>
<p><img src="/blog/uploads/images/Docker/asjkdjalkdjlasjdlkajl.png"></p>
<p><img src="/blog/uploads/images/Docker/watermark,type__center-16532245302993.png" alt="Node节点"></p>
<h1 id="Kuboard安装方式"><a href="#Kuboard安装方式" class="headerlink" title="Kuboard安装方式"></a><a target="_blank" rel="noopener" href="https://kuboard.cn/install/install-k8s.html#kuboard-spray"><code>Kuboard</code>安装方式</a></h1><p>这里只做记录：<a target="_blank" rel="noopener" href="https://kuboard.cn/install/install-k8s.html#%E5%8A%A0%E8%BD%BD%E7%A6%BB%E7%BA%BF%E8%B5%84%E6%BA%90%E5%8C%85">点击参考官方文档</a></p>
<p>这里需要：</p>
<ul>
<li><code>192.168.222.150 k8s master</code></li>
<li><code>192.168.222.151 k8s node</code></li>
<li><code>192.168.222.152 k8s node</code></li>
<li><code>192.168.222.251 Docker</code> 安装 <code>Kuboard-Spray</code> ，<code>k8s</code>不能安装这台设备上</li>
</ul>
<blockquote>
<p>注意：如果是虚拟机，必须是固定<code>IP</code></p>
<ul>
<li><code>kubelet</code>  节点通信</li>
<li><code>kubectl</code>  集群管理工具</li>
</ul>
</blockquote>
<h2 id="安装Kuboard-Spray"><a href="#安装Kuboard-Spray" class="headerlink" title="安装Kuboard-Spray"></a>安装<code>Kuboard-Spray</code></h2><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop firewalld</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"><span class="comment"># 关闭selinux</span></span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>

<h3 id="加载镜像"><a href="#加载镜像" class="headerlink" title="加载镜像"></a>加载镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --privileged \</span><br><span class="line">  --restart=unless-stopped \</span><br><span class="line">  --name=kuboard-spray \</span><br><span class="line">  -p 80:80/tcp \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  -v ~/kuboard-spray-data:/data \</span><br><span class="line">  swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard-spray:latest-amd64</span><br><span class="line">  <span class="comment"># 如果抓不到这个镜像，可以尝试一下这个备用地址：</span></span><br><span class="line">  <span class="comment"># eipwork/kuboard-spray:latest-amd64</span></span><br></pre></td></tr></table></figure>

<p><code>http://192.168.222.251</code>，输入用户名 <code>admin</code>，默认密码 <code>Kuboard123</code>，即可登录 <code>Kuboard-Spray</code> 界面</p>
<h2 id="加载资源"><a href="#加载资源" class="headerlink" title="加载资源"></a>加载资源</h2><p> <code>系统设置</code> –&gt; <code>资源包管理</code> 界面，找到最新版本（需要的版本点击导入），点击标题中的加载xxx操作。</p>
<p>离线导入请参考<a target="_blank" rel="noopener" href="https://kuboard.cn/install/install-k8s.html#%E5%8A%A0%E8%BD%BD%E7%A6%BB%E7%BA%BF%E8%B5%84%E6%BA%90%E5%8C%85">官方文档</a></p>
<h2 id="规划集群"><a href="#规划集群" class="headerlink" title="规划集群"></a>规划集群</h2><p><code>集群管理</code> 界面，点击 <code>添加集群安装计划</code> 按钮，填写集群名称和资源包：</p>
<p><img src="/blog/uploads/images/Docker/image-20220522203628018.png" alt="image-20220522203628018"></p>
<p>注意事项</p>
<ul>
<li><p>最少的节点数量是 1 个；</p>
</li>
<li><p><code>ETCD</code> 节点、控制节点的总数量必须为奇数；</p>
</li>
<li><p>在 <code>全局设置</code> 标签页，可以设置节点的通用连接参数，例如所有的节点都使用相同的 ssh 端口、用户名、密码，则共同的参数只在此处设置即可；</p>
</li>
<li><p>在节点标签页，如果该节点的角色包含 <code>etcd</code> 则必须填写 <code>ETCD 成员名称</code> 这个字段；</p>
</li>
<li><p>如果您 <code>KuboardSpray</code> 所在节点不能直接访问到 <code>Kubernetes</code> 集群的节点，您可以设置跳板机参数，使 <code>KuboardSpray</code> 可以通过 ssh 访问集群节点。</p>
</li>
<li><p>集群安装过程中，除了已经导入的资源包以外，还需要使用 yum 或 apt 指令安装一些系统软件，例如 <code>curl, rsync, ipvadm, ipset, ethtool</code> 等，此时要用到操作系统的 apt 软件源或者 yum 软件源。<strong>全局设置</strong>标签页中，可以引导您完成 apt &#x2F; yum 软件源的设置，您可以：</p>
<ul>
<li>使用节点操作系统已经事先配置的 apt &#x2F; yum 源，或者</li>
<li>在安装过程中自动配置节点的操作系统使用指定的软件源</li>
</ul>
</li>
<li><p>如果您使用 docker 作为集群的容器引擎，还需要在<strong>全局设置</strong>标签页指定安装 docker 用的 apt &#x2F; yum 源。</p>
<blockquote>
<p>如果您使用 containerd 作为容器引擎，则无需配置 docker 的 apt &#x2F; yum 源，containerd 的安装包已经包含在 KuboardSpray 离线资源包中。</p>
</blockquote>
</li>
</ul>
<h3 id="配置镜像源"><a href="#配置镜像源" class="headerlink" title="配置镜像源"></a>配置镜像源</h3><p>只有一个 <code>aliyun</code>的<code>CentOS</code>源的路径是新的，其它在添加时都能找到。</p>
<p><strong>强烈建议配在操作系统里。镜像源使用操作系统默认<a href="#repo">参考配置</a></strong></p>
<blockquote>
<p><strong>注意：虚拟机需要挂载<code>ISO</code>镜像</strong>  <code>mount /dev/cdrom /mnt/cdrom</code></p>
<p>否则可能会报错</p>
<p><img src="/blog/uploads/images/Docker/image-20220522212745114.png" alt="image-20220522212745114"></p>
</blockquote>
<p><img src="/blog/uploads/images/Docker/image-20220522205725154.png" alt="image-20220522205725154"></p>
<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><p>建议默认配置，镜像源使用操作系统默认<a href="#repo">参考配置</a></p>
<h3 id="节点配置"><a href="#节点配置" class="headerlink" title="节点配置"></a>节点配置</h3><p><img src="/blog/uploads/images/Docker/image-20220522210928019.png" alt="image-20220522210928019"></p>
<h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><p>点击<strong>保存</strong>，然后点击<strong>安装&#x2F;设置集群</strong></p>
<p><img src="/blog/uploads/images/Docker/image-20220522214914299.png" alt="image-20220522214914299"></p>
<h2 id="访问集群"><a href="#访问集群" class="headerlink" title="访问集群"></a>访问集群</h2><p>界面给出了三种方式可以访问 <code>kubernetes</code> 集群：</p>
<ul>
<li>在集群主节点上执行 <code>kubectl</code> 命令</li>
<li>获取集群的 <code>.kubeconfig</code> 文件</li>
<li>将集群导入到 <code>kuboard</code>管理界面</li>
</ul>
<p><img src="/blog/uploads/images/Docker/image-20220522215445220.png" alt="image-20220522215445220"></p>
<p>也可以安装 <code>portainer.io</code></p>
<h1 id="安装k8s管理工具"><a href="#安装k8s管理工具" class="headerlink" title="安装k8s管理工具"></a>安装<code>k8s</code>管理工具</h1><p>这里使用：<a target="_blank" rel="noopener" href="https://docs.portainer.io/start/install/server/kubernetes/baremetal"><code>poerainer</code></a></p>
<p>安装在 <code>192.168.222.150</code></p>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><h3 id="查看-StorageClass"><a href="#查看-StorageClass" class="headerlink" title="查看 StorageClass "></a>查看 <code>StorageClass </code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sc</span><br></pre></td></tr></table></figure>

<p>如果是 <code>No resources found</code> 则需要创建一个。</p>
<h3 id="创建-StorageClass"><a href="#创建-StorageClass" class="headerlink" title="创建 StorageClass"></a>创建 <code>StorageClass</code></h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huwh_/article/details/96016423">https://blog.csdn.net/huwh_&#x2F;article&#x2F;details&#x2F;96016423</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.portainer.io/start/install/server/kubernetes/baremetal">https://docs.portainer.io/start/install/server/kubernetes/baremetal</a></p>
</blockquote>
<h3 id="设置-StorageClass为默认值"><a href="#设置-StorageClass为默认值" class="headerlink" title="设置 StorageClass为默认值"></a>设置 <code>StorageClass</code>为默认值</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch storageclass maxzhao-cluster-storage-class -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="deploy-use-yaml-manifests"><a href="#deploy-use-yaml-manifests" class="headerlink" title="deploy use yaml manifests"></a><code>deploy use yaml manifests</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 社区版</span></span><br><span class="line">kubectl apply -n portainer -f https://downloads.portainer.io/ce2-13/portainer.yaml</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">kubectl patch deployments -n portainer portainer -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;template&quot;: &#123;&quot;spec&quot;: &#123;&quot;nodeSelector&quot;: &#123;&quot;kubernetes.io/master-150&quot;: &quot;&#x27;</span>$(kubectl get pods -n portainer -o jsonpath=<span class="string">&#x27;&#123; ..nodeName &#125;&#x27;</span>)<span class="string">&#x27;&quot;&#125;&#125;&#125;&#125;&#125;&#x27;</span> || (<span class="built_in">echo</span> Failed to identify current node of portainer pod; <span class="built_in">exit</span> 1)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>也可以使用 <code>portainer</code> 的 <code>helm</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm repo add portainer https://portainer.github.io/k8s/</span><br><span class="line">helm repo update</span><br><span class="line"><span class="comment"># 社区版</span></span><br><span class="line">helm install --create-namespace -n portainer portainer portainer/portainer --<span class="built_in">set</span> tls.force=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://localhost:30779/">https://localhost:30779/</a> or <a target="_blank" rel="noopener" href="http://localhost:30777/">http://localhost:30777/</a></p>
<h1 id="重启虚拟机"><a href="#重启虚拟机" class="headerlink" title="重启虚拟机"></a>重启虚拟机</h1><p>请参考<a target="_blank" rel="noopener" href="https://kuboard.cn/install/k8s-restart.html#worker%E8%8A%82%E7%82%B9%E4%B8%8D%E8%83%BD%E5%90%AF%E5%8A%A8"><code>Kuboard</code>中的介绍</a></p>
<h2 id="Worker节点不能"><a href="#Worker节点不能" class="headerlink" title="Worker节点不能"></a><code>Worker</code>节点不能</h2><p>可能是<code>IP</code>变化引起的，需要固定<code>IP</code>后重装集群。</p>
<h2 id="许多Pod一直Crash或不能正常访问"><a href="#许多Pod一直Crash或不能正常访问" class="headerlink" title="许多Pod一直Crash或不能正常访问"></a>许多Pod一直<code>Crash</code>或不能正常访问</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>

<p>重启后会发现许多 <code>Pod</code> 不在 <code>Running</code> 状态，此时，请使用如下命令删除这些状态不正常的 <code>Pod</code>。通常，您的 <code>Pod</code> 如果是使用 <code>Deployment</code>、StatefulSet 等控制器创建的，<code>kubernetes</code> 将创建新的 <code>Pod</code> 作为替代，重新启动的 <code>Pod</code> 通常能够正常工作。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod &lt;pod-name&gt; -n &lt;pod-namespece&gt;</span><br></pre></td></tr></table></figure>

<h1 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h1><h2 id="关闭防火墙-1"><a href="#关闭防火墙-1" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop firewalld</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"><span class="comment"># 关闭selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 永久</span></span><br><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  </span><br><span class="line"><span class="comment"># 关闭swap（k8s禁止虚拟内存以提高性能）</span></span><br><span class="line">swapoff -a </span><br><span class="line"><span class="comment">#永久</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab </span><br></pre></td></tr></table></figure>

<h3 id="Docker镜像"><a href="#Docker镜像" class="headerlink" title="Docker镜像"></a><code>Docker</code>镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>改为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://aj2rgad5.mirror.aliyuncs.com&quot;</span><span class="punctuation">,</span><span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span> <span class="string">&quot;8.8.4.4&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>远程访问：<code>&quot;hosts&quot;: [&quot;unix:///var/run/docker.sock&quot;, &quot;tcp://127.0.0.1:2375&quot;]</code></p>
<h3 id="配置-k8s-镜像"><a href="#配置-k8s-镜像" class="headerlink" title="配置 k8s 镜像"></a>配置 <code>k8s</code> 镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/yum.repos.d/kubernetes.repo</span><br></pre></td></tr></table></figure>

<p>写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></table></figure>

<p>刷新</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于官网未开放同步方式, 可能会有索引gpg检查失败的情况</span></span><br><span class="line"><span class="comment"># sudo yum clean all &amp;&amp; sudo yum makecache</span></span><br></pre></td></tr></table></figure>

<p>华为云镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://repo.huaweicloud.com/kubernetes/yum/repos/kubernetes-el7-$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://repo.huaweicloud.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">https://repo.huaweicloud.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br></pre></td></tr></table></figure>

<h1 id="卸载集群"><a href="#卸载集群" class="headerlink" title="卸载集群"></a>卸载集群</h1><p><code>kubectl config delete-cluster</code> 删除对集群的本地引用。</p>
<h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><p>使用适当的凭证与控制平面节点通信，运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain &lt;node name&gt; --delete-emptydir-data --force --ignore-daemonsets</span><br></pre></td></tr></table></figure>

<p>在删除节点之前，请重置 <code>kubeadm</code> 安装的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<p>重置过程不会重置或清除 iptables 规则或 IPVS 表。如果你希望重置 iptables，则必须手动进行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br></pre></td></tr></table></figure>

<p>如果要重置 IPVS 表，则必须运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -C</span><br></pre></td></tr></table></figure>

<p>现在删除节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete node &lt;node name&gt;</span><br></pre></td></tr></table></figure>

<p>如果你想重新开始，只需运行 <code>kubeadm init</code> 或 <code>kubeadm join</code> 并加上适当的参数。</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="CentOS7镜像"><a href="#CentOS7镜像" class="headerlink" title="CentOS7镜像"></a><code>CentOS7</code>镜像<span id="repo"></span></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份</span></span><br><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line"><span class="comment"># 下载源文件</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment"># 生成缓存</span></span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>



<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a><code>Docker</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要挂载 ISO 镜像</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /mnt/cdrom</span><br><span class="line">sudo mount /dev/cdrom /mnt/cdrom/</span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h3 id="使用阿里云"><a href="#使用阿里云" class="headerlink" title="使用阿里云"></a>使用阿里云</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="comment"># Step 2: 添加软件源信息</span></span><br><span class="line">sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># Step 3</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo yum makecache fast</span><br></pre></td></tr></table></figure>

<h2 id="Docker镜像加速"><a href="#Docker镜像加速" class="headerlink" title="Docker镜像加速"></a><code>Docker</code>镜像加速</h2><h3 id="手动修改"><a href="#手动修改" class="headerlink" title="手动修改"></a>手动修改</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/docker</span><br><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>写入</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;https://aj2rgad5.mirror.aliyuncs.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;https://registry.docker-cn.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span> <span class="string">&quot;8.8.4.4&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Spray安装后使用脚本"><a href="#Spray安装后使用脚本" class="headerlink" title="Spray安装后使用脚本"></a><code>Spray</code>安装后使用脚本</h3><p>可以使用任意一个地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker中国 mirror</span></span><br><span class="line"><span class="comment"># export REGISTRY_MIRROR=&quot;https://registry.docker-cn.com&quot;</span></span><br><span class="line"><span class="comment"># 腾讯云 docker hub mirror</span></span><br><span class="line"><span class="comment"># export REGISTRY_MIRROR=&quot;https://mirror.ccs.tencentyun.com&quot;</span></span><br><span class="line"><span class="comment"># 华为云镜像</span></span><br><span class="line"><span class="comment"># export REGISTRY_MIRROR=&quot;https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com&quot;</span></span><br><span class="line"><span class="comment"># DaoCloud 镜像</span></span><br><span class="line"><span class="comment"># export REGISTRY_MIRROR=&quot;http://f1361db2.m.daocloud.io&quot;</span></span><br><span class="line"><span class="comment"># 阿里云 docker hub mirror</span></span><br><span class="line"><span class="built_in">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/set_mirror.sh | sh -s <span class="variable">$&#123;REGISTRY_MIRROR&#125;</span></span><br><span class="line"></span><br><span class="line">systemctl restart kubelet  <span class="comment"># 假设您安装了 kubenetes</span></span><br></pre></td></tr></table></figure>

<h3 id="查看修改结果"><a href="#查看修改结果" class="headerlink" title="查看修改结果"></a>查看修改结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220522214702999.png" alt="image-20220522214702999"></p>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/9c2c35af/">https://github.com/maxzhao-it/blog/post/9c2c35af/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/cfe111da/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/cfe111da/" class="post-title-link" itemprop="url">K8S中的StorageClass</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/K8S/" itemprop="url" rel="index"><span itemprop="name">K8S</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>StorageClass</code> 为管理员提供了一种描述他们提供的存储<code>Class</code>的方法。不同的类可能映射到服务质量级别、备份策略或集群管理员确定的任意策略。 <code>Kubernetes</code> 本身对类代表什么没有意见。这个概念有时在其他存储系统中称为<code>profiles</code>。</p>
<p>每个 <code>StorageClass</code> 都包含字段 <code>provisioner</code>、<code>parameters</code> 和 <code>reclaimPolicy</code>，当需要动态配置属于该类的 <code>PersistentVolume</code> 时使用这些字段。</p>
<p><code>StorageClass</code> 对象的名称很重要，它是用户请求特定类的方式。管理员在第一次创建<code>StorageClass</code>对象时设置类的名称和其他参数，<strong>对象一旦创建就不能更新</strong>。</p>
<p>管理员只能为不请求绑定任何特定类的 <code>PVC</code> 指定默认 <code>StorageClass</code>：有关详细信息，请参阅 <code>PersistentVolumeClaim</code> 部分。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">standard</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">gp2</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">debug</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">Immediate</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>来自<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/"><code>storage-classes</code></a></p>
</blockquote>
<h1 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h1><h2 id="Provisioner分配器"><a href="#Provisioner分配器" class="headerlink" title="Provisioner分配器"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner"><code>Provisioner</code></a>分配器</h2><p>每个<code>StorageClass</code>都有一个<code>provisioner</code>，决定使用什么卷插件来配置<code>PV</code>。这个字段必须被指定。</p>
<p>分配器分为：内部分配器、外部分配器</p>
<h2 id="Reclaim-Policy回收策略"><a href="#Reclaim-Policy回收策略" class="headerlink" title="Reclaim Policy回收策略"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#reclaim-policy"><code>Reclaim Policy</code></a>回收策略</h2><p>由 <code>StorageClass</code> 动态创建的 <code>PersistentVolume</code> 将具有在类的 <code>reclaimPolicy</code> 字段中指定的回收策略，该字段可以是 <code>Delete</code> 或 <code>Retain</code>。如果在创建 <code>StorageClass</code> 对象时未指定 <code>reclaimPolicy</code>，则默认为 <code>Delete</code>。</p>
<p>手动创建并通过 <code>StorageClass</code> 管理的 <code>PersistentVolume</code> 将具有在创建时分配的任何回收策略</p>
<h2 id="Allow-Volume-Expansion允许卷扩展"><a href="#Allow-Volume-Expansion允许卷扩展" class="headerlink" title="Allow Volume Expansion允许卷扩展"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#allow-volume-expansion"><code>Allow Volume Expansion</code></a>允许卷扩展</h2><p><code>PersistentVolume</code> 可以配置为可扩展。此功能设置为 true 时，允许用户通过编辑相应的 PVC 对象来调整卷的大小。</p>
<h2 id="Mount-Options挂载"><a href="#Mount-Options挂载" class="headerlink" title="Mount Options挂载"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#mount-options"><code>Mount Options</code></a>挂载</h2><p>由 <code>StorageClass</code> 动态创建的 <code>PersistentVolume</code> 将具有在类的 <code>mountOptions</code> 字段中指定的挂载选项。</p>
<p>如果卷插件不支持挂载选项但指定了挂载选项，则配置将失败。挂载选项未在类或 <code>PV</code> 上验证。如果挂载选项无效，则 <code>PV</code> 挂载失败</p>
<h2 id="Volume-Binding-Mode"><a href="#Volume-Binding-Mode" class="headerlink" title="Volume Binding Mode"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#volume-binding-mode"><code>Volume Binding Mode</code></a></h2><p><code>volumeBindingMode</code> 字段控制何时应该发生卷绑定和动态配置。未设置时，默认使用“立即”模式。</p>
<p>即时模式表示一旦创建 <code>PersistentVolumeClaim</code>，就会发生卷绑定和动态供应。对于拓扑受限且无法从集群中的所有节点全局访问的存储后端，将在不知道 <code>Pod</code> 调度要求的情况下绑定或配置 <code>PersistentVolume</code>。这可能会导致不可调度的 <code>Pod</code>。</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#allowed-topologies"><code>Allowed Topologies</code></a></p>
<p>当集群操作员指定 <code>WaitForFirstConsumer</code> 卷绑定模式时，在大多数情况下不再需要将配置限制为特定拓扑。但是，如果仍然需要，可以指定 <code>allowedTopologies</code>。</p>
<p>此示例演示如何将已配置卷的拓扑限制到特定区域，并且应该用作受支持插件的区域和区域参数的替代。</p>
<h2 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/storage-classes/#parameters"><code>Parameters</code></a></h2><p>存储类具有描述属于该存储类的卷的参数。根据 <code>provisioner</code> 的不同，可以接受不同的参数。例如，参数类型的值 <code>io1</code> 和参数 <code>iopsPerGB </code> 特定于 <code>EBS</code>。当省略参数时，使用一些默认值。</p>
<p>一个 <code>StorageClass</code> 最多可以定义 <code>512</code> 个参数。参数对象的总长度（包括其键和值）不能超过 <code>256 KiB</code></p>
<h1 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a><code>NFS</code></h1><h2 id="创建存储类"><a href="#创建存储类" class="headerlink" title="创建存储类"></a>创建存储类</h2><p><code>example-nfs-storage-class.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-nfs-storage-class</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.240</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/share</span></span><br><span class="line">  <span class="attr">readOnly:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>server</code>：<code>Server</code> 是 <code>NFS</code> 服务器的主机名或 <code>IP</code> 地址。</li>
<li><code>path</code> ：<code>NFS</code>服务器导出的路径。</li>
<li><code>readOnly</code>：指示存储是否将被安装为只读的标志（默认为 false）。</li>
</ul>
<p><code>Kubernetes</code> 不包含内部 <code>NFS</code> 供应商。您需要使用外部供应商为 <code>NFS</code> 创建 <code>StorageClass</code>。这里有些例子：</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/nfs-ganesha-server-and-external-provisioner">NFS Ganesha server and external provisioner</a></li>
<li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">NFS subdir external provisioner</a></li>
</ul>
<h2 id="创建pvc"><a href="#创建pvc" class="headerlink" title="创建pvc"></a>创建<code>pvc</code></h2><p><code>nfs-pvc.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">example-nfs-storage-class</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Mi</span></span><br></pre></td></tr></table></figure>

<h2 id="使用nfs-pvc"><a href="#使用nfs-pvc" class="headerlink" title="使用nfs-pvc"></a>使用<code>nfs-pvc</code></h2><p><code>test-deployment.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-deployment</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;while true; do date &gt; /mnt/index.html; hostname &gt;&gt; /mnt/index.html; sleep $(($RANDOM % 5 + 5)); done&#x27;</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nfs-pvc</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f test-deployment.yaml</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/cfe111da/">https://github.com/maxzhao-it/blog/post/cfe111da/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/605d48da/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/605d48da/" class="post-title-link" itemprop="url">Nginx代理SSH端口</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-21 14:16:58" itemprop="dateModified" datetime="2022-12-21T14:16:58+08:00">2022-12-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>一般情况下 <code>nginx</code> 是代理七层的 <code>http</code> 协议，其实 <code>nginx</code> 也可以代理第四层协议</p>
<p>修改配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">	upstream ssh-proxy &#123;</span><br><span class="line">		server 192.168.2.240:22;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 50022;</span><br><span class="line">		proxy_pass ssh-proxy;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>连接命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.7.173 -p 50022</span><br><span class="line">ssh 192.168.7.173 -l root -p 50022</span><br></pre></td></tr></table></figure>



<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><p>转发请求头</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /prod-api/ &#123;</span><br><span class="line">	proxy_set_header Host $http_host;</span><br><span class="line">	proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">	proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">	proxy_pass xxx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/605d48da/">https://github.com/maxzhao-it/blog/post/605d48da/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/297cc7d3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/297cc7d3/" class="post-title-link" itemprop="url">Centos配置时间和时区</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/CentOS/" itemprop="url" rel="index"><span itemprop="name">CentOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>安装工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y ntpdate</span><br></pre></td></tr></table></figure>

<p>同步时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ntpdate -u ntp.api.bz</span><br><span class="line">或者</span><br><span class="line">sudo ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<p>常用服务</p>
<p>ntp常用服务器：</p>
<ul>
<li>中国国家授时中心：<code>210.72.145.44</code></li>
<li>NTP服务器(上海) ：<code>ntp.api.bz</code></li>
<li>美国： <code>time.nist.gov</code></li>
<li>复旦： <code>ntp.fudan.edu.cn</code></li>
<li>微软公司授时主机(美国) ：<code>time.windows.com</code></li>
<li>北京邮电大学 : <code>s1a.time.edu.cn</code></li>
<li>清华大学 : <code>s1b.time.edu.cn</code></li>
<li>北京大学 : <code>s1c.time.edu.cn</code></li>
<li>台警大授时中心(台湾)：<code>asia.pool.ntp.org</code></li>
</ul>
<p>查看时区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span> -R</span><br></pre></td></tr></table></figure>

<p>修改时区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tzselect</span><br><span class="line"><span class="comment"># 5 9 1 1</span></span><br><span class="line">sudo <span class="built_in">rm</span> /etc/localtime</span><br><span class="line">sudo <span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/297cc7d3/">https://github.com/maxzhao-it/blog/post/297cc7d3/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/4c3b1032/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/4c3b1032/" class="post-title-link" itemprop="url">Docker安装LDAP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Docker/LDAP/" itemprop="url" rel="index"><span itemprop="name">LDAP</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>轻型目录访问协议</strong>（<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%8B%B1%E6%96%87">英文</a>：<strong>Lightweight Directory Access Protocol</strong>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BC%A9%E5%86%99">缩写</a>：<strong>LDAP</strong>，&#x2F;ˈɛldæp&#x2F;）是一个开放的，中立的，工业标准的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E5%8D%8F%E8%AE%AE">应用协议</a>，通过<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/IP%E5%8D%8F%E8%AE%AE">IP协议</a>提供访问控制和维护分布式信息的目录信息。</p>
<h4 id="LDAP的主要应用场景"><a href="#LDAP的主要应用场景" class="headerlink" title="LDAP的主要应用场景"></a>LDAP的主要应用场景</h4><p>1.网络服务：DNS服务<br>2.统一认证服务：<br>3.Linux PAM (ssh, login, cvs. . . )<br>4.Apache访问控制<br>5.各种服务登录(ftpd, php based, perl based, python based. . . )<br>6.个人信息类，如地址簿<br>7.服务器信息，如帐号管理、邮件服务等</p>
<blockquote>
<p><code>注意</code>:从<code>OpenLDAP2.4.23</code>版本开始所有配置数据都保存在<code>/etc/openldap/slapd.d/</code>中，不再使用<code>slapd.conf</code>作为配置文件</p>
</blockquote>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a><code>LDAP</code></h2><h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull osixia/openldap</span><br><span class="line">docker image list</span><br></pre></td></tr></table></figure>

<ul>
<li>安装后的目录：<code>/etc/openldap/</code></li>
<li>数据文件路径：<code>/var/lib/ldap</code></li>
<li>配置文件路径：<code>/etc/ldap/slapd.d</code></li>
<li>模板数据库配置文件：<code>/usr/share/openldap-servers/DB_CONFIG.example</code> </li>
<li><code>/usr/share/openldap-servers/slapd.ldif</code></li>
</ul>
<h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><h4 id="映射端口"><a href="#映射端口" class="headerlink" title="映射端口"></a>映射端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 389:389 -p 636:636 --name openldap-container --detach osixia/openldap:latest</span><br></pre></td></tr></table></figure>

<h4 id="映射环境"><a href="#映射环境" class="headerlink" title="映射环境"></a>映射环境</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 389:389 -p 636:636 \</span><br><span class="line">--<span class="built_in">env</span> LDAP_ORGANISATION=<span class="string">&quot;maxzhao&quot;</span> \</span><br><span class="line">	--<span class="built_in">env</span> LDAP_DOMAIN=<span class="string">&quot;maxzhao.com&quot;</span> \</span><br><span class="line">	--<span class="built_in">env</span> LDAP_ADMIN_PASSWORD=<span class="string">&quot;maxzhao&quot;</span> \</span><br><span class="line">	--volume /data/slapd/var/lib/ldap:/var/lib/ldap \</span><br><span class="line">	--volume /data/slapd/etc/ldap/slapd.d:/etc/ldap/slapd.d \</span><br><span class="line">	--name openldap-container --detach osixia/openldap:latest</span><br></pre></td></tr></table></figure>

<h2 id="构建自己的镜像"><a href="#构建自己的镜像" class="headerlink" title="构建自己的镜像"></a>构建自己的镜像</h2><p>主机与容器匹配用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker build \</span><br><span class="line">	--build-arg LDAP_OPENLDAP_GID=1234 \</span><br><span class="line">	--build-arg LDAP_OPENLDAP_UID=2345 \</span><br><span class="line">	-t my_ldap_image .</span><br><span class="line">docker run --name my_ldap_container -d my_ldap_image</span><br><span class="line"><span class="comment"># this should output uid=2345(openldap) gid=1234(openldap) groups=1234(openldap)</span></span><br><span class="line">docker <span class="built_in">exec</span> my_ldap_container <span class="built_in">id</span> openldap</span><br></pre></td></tr></table></figure>

<h2 id="连接工具"><a href="#连接工具" class="headerlink" title="连接工具"></a>连接工具</h2><p>  <a target="_blank" rel="noopener" href="https://dlcdn.apache.org/[...]/ApacheDirectoryStudio-2.0.0.v20210717-M17-win32.win32.x86_64.zip"><code>apache directory studio</code>下载</a></p>
<p>查看配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /data/slapd/etc/ldap/slapd.d/cn\=config/olcDatabase\=\&#123;1\&#125;mdb.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/Docker/image-20220519165543873.png" alt="image-20220519165543873"></p>
<p>新建 <code>Connection</code></p>
<p><img src="/blog/uploads/images/Docker/image-20220519165509438.png" alt="image-20220519165509438"></p>
<p><img src="/blog/uploads/images/Docker/image-20220519165521134.png" alt="image-20220519165521134"></p>
<blockquote>
<p>参考：</p>
<p> <a href="https://github.com/osixia/docker-openldap#quick-start"><code>docker-openldap</code></a></p>
</blockquote>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/4c3b1032/">https://github.com/maxzhao-it/blog/post/4c3b1032/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/de2905c4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/de2905c4/" class="post-title-link" itemprop="url">Linux安装NFS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-09-07 15:00:30" itemprop="dateModified" datetime="2022-09-07T15:00:30+08:00">2022-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>网络文件系统<code>Network File System(NFS)</code></p>
<p>是由<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/SUN/69463">SUN</a>公司研制的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/UNIX/219943">UNIX</a><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%A1%A8%E7%A4%BA%E5%B1%82/4329716">表示层</a>协议(presentation layer protocol)，能使使用者访问网络上别处的文件就像在使用自己的计算机一样。</p>
<p>是一种 <code>CS</code> 架构</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpcbind 会默认安装 rpcbind</span></span><br><span class="line">sudo yum install -y nfs-utils</span><br></pre></td></tr></table></figure>

<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start rpcbind</span><br><span class="line">sudo systemctl start nfs</span><br><span class="line">sudo systemctl enable rpcbind</span><br><span class="line">sudo systemctl enable nfs</span><br></pre></td></tr></table></figure>

<h3 id="配置共享目录"><a href="#配置共享目录" class="headerlink" title="配置共享目录"></a>配置共享目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /data</span><br><span class="line">sudo chmod 755 /data</span><br></pre></td></tr></table></figure>

<h3 id="配置-nfs"><a href="#配置-nfs" class="headerlink" title="配置 nfs"></a>配置 <code>nfs</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/exports</span><br></pre></td></tr></table></figure>

<p>写入下面配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/ *(rw,sync,no_root_squash,no_all_squash)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>/data</code>: 共享目录位置。</li>
<li><code>*</code>: 客户端 <code>IP</code> 范围，<code>*</code>代表没有限制 ，限制某个子网(192.168.0.0&#x2F;24)。</li>
<li><code>rw</code>: 权限设置，可读可写。</li>
<li><code>sync</code>: 同步共享目录。</li>
<li><code>no_root_squash</code>: 当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(不常用)。</li>
<li><code>root_squash</code>：当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)</li>
<li><code>no_all_squash</code>: 可以使用普通用户授权。</li>
</ul>
<h3 id="使配置生效"><a href="#使配置生效" class="headerlink" title="使配置生效"></a>使配置生效</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs -r</span><br></pre></td></tr></table></figure>

<h3 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nfs</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询某 `IP` 的 `NFS` 服务</span></span><br><span class="line">showmount -e 127.0.0.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查当前服务</span></span><br><span class="line">exportfs</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询端口占用</span></span><br><span class="line">rpcinfo -p 192.168.14.118</span><br></pre></td></tr></table></figure>

<h3 id="配置端口"><a href="#配置端口" class="headerlink" title="配置端口"></a>配置端口</h3><ol>
<li>portmapper：默认 111</li>
<li>nfs： 默认 2049</li>
<li>mountd：使用默认892</li>
<li>statd：使用默认 662</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/sysconfig/nfs</span><br></pre></td></tr></table></figure>

<p>添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LOCKD_TCPPORT=32803</span><br><span class="line">LOCKD_UDPPORT=32769</span><br><span class="line">MOUNTD_PORT=892</span><br><span class="line">STATD_PORT=662</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/modprobe.d/lockd.conf </span><br></pre></td></tr></table></figure>

<p>添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">options lockd nlm_tcpport=32803</span><br><span class="line">options lockd nlm_udpport=32769</span><br></pre></td></tr></table></figure>

<p>重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启服务</span></span><br><span class="line">sudo systemctl restart rpcbind</span><br><span class="line">sudo systemctl restart nfs</span><br><span class="line">sudo systemctl restart nfs-config</span><br><span class="line">sudo systemctl restart nfs-idmap</span><br><span class="line">sudo systemctl restart nfs-lock</span><br><span class="line">sudo systemctl restart nfs-server</span><br></pre></td></tr></table></figure>



<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-service=nfs --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=32803/tcp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=32769/udp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=111/tcp --add-port=111/udp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=892/tcp --add-port=892/udp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=662/tcp --add-port=662/udp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=2049/tcp --add-port=2049/udp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br><span class="line">sudo firewall-cmd --zone=public --list-ports</span><br><span class="line">sudo firewall-cmd --zone=public --list-services</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询需要开放的端口</span></span><br><span class="line">rpcinfo -p 192.168.14.118</span><br></pre></td></tr></table></figure>



<h2 id="客户端挂载NFS"><a href="#客户端挂载NFS" class="headerlink" title="客户端挂载NFS"></a>客户端挂载<code>NFS</code></h2><h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install nfs-utils</span><br></pre></td></tr></table></figure>

<h3 id="查询某-IP-的-NFS-服务"><a href="#查询某-IP-的-NFS-服务" class="headerlink" title="查询某 IP 的 NFS 服务"></a>查询某 <code>IP</code> 的 <code>NFS</code> 服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 192.168.2.140</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Export list for 192.168.2.140:</span><br><span class="line">/data/ *</span><br></pre></td></tr></table></figure>

<h3 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建本地目录</span></span><br><span class="line">sudo mkdir /mnt/data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">挂载服务端目录到本地</span></span><br><span class="line">sudo mount -t nfs 192.168.2.140:/data /mnt/data</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/de2905c4/">https://github.com/maxzhao-it/blog/post/de2905c4/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/4754f56b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/4754f56b/" class="post-title-link" itemprop="url">CentOS安装LDAP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/CentOS/" itemprop="url" rel="index"><span itemprop="name">CentOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>轻型目录访问协议</strong>（<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%8B%B1%E6%96%87">英文</a>：<strong>Lightweight Directory Access Protocol</strong>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BC%A9%E5%86%99">缩写</a>：<strong>LDAP</strong>，&#x2F;ˈɛldæp&#x2F;）是一个开放的，中立的，工业标准的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E5%8D%8F%E8%AE%AE">应用协议</a>，通过<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/IP%E5%8D%8F%E8%AE%AE">IP协议</a>提供访问控制和维护分布式信息的目录信息。</p>
<h4 id="LDAP的主要应用场景"><a href="#LDAP的主要应用场景" class="headerlink" title="LDAP的主要应用场景"></a>LDAP的主要应用场景</h4><p>1.网络服务：DNS服务<br>2.统一认证服务：<br>3.Linux PAM (ssh, login, cvs. . . )<br>4.Apache访问控制<br>5.各种服务登录(ftpd, php based, perl based, python based. . . )<br>6.个人信息类，如地址簿<br>7.服务器信息，如帐号管理、邮件服务等</p>
<blockquote>
<p><code>注意</code>:从<code>OpenLDAP2.4.23</code>版本开始所有配置数据都保存在<code>/etc/openldap/slapd.d/</code>中，不再使用<code>slapd.conf</code>作为配置文件</p>
</blockquote>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a><code>LDAP</code></h2><h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y openldap compat-openldap openldap  openldap-clients  openldap-devel openldap-servers </span><br><span class="line"><span class="comment"># 可选 collectd-openldap</span></span><br></pre></td></tr></table></figure>

<ul>
<li>安装后的目录：<code>/etc/openldap/</code></li>
<li>数据文件路径：<code>/var/lib/ldap</code></li>
<li>模板数据库配置文件： <code>/usr/share/openldap-servers/DB_CONFIG.example</code> </li>
<li><code>/usr/share/openldap-servers/slapd.ldif</code></li>
</ul>
<blockquote>
<p>如果是虚拟机安装：需要挂载<code>cdrom</code></p>
</blockquote>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start slapd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> slapd</span><br><span class="line">sudo systemctl status slapd</span><br></pre></td></tr></table></figure>

<h3 id="查看端口"><a href="#查看端口" class="headerlink" title="查看端口"></a>查看端口</h3><p>占用 <code>389</code> 端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tlnp | grep slapd</span><br></pre></td></tr></table></figure>



<h3 id="查看用户"><a href="#查看用户" class="headerlink" title="查看用户"></a>查看用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -n 1 /etc/passwd</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="修改域信息"><a href="#修改域信息" class="headerlink" title="修改域信息"></a>修改域信息</h4><p>设置管理员密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slappasswd</span><br><span class="line"><span class="comment"># 也可以指明密码</span></span><br><span class="line">slappasswd -s maxzhao</span><br></pre></td></tr></table></figure>

<p>输出的密码：<code>&#123;SSHA&#125;0tKDKqne3gJ30xZ73rDO491r/AlaJd0N</code></p>
<p>修改域信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openldap/slapd.d/cn\=config</span><br><span class="line">vim /etc/openldap/slapd.d/cn\=config/olcDatabase\=\&#123;2\&#125;hdb.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518194041425.png" alt="image-20220518194041425"></p>
<ul>
<li><code>olcRootDN：cn=root</code> 中的 <code>root</code>是管理员用户名</li>
<li><code>olcRootPW</code>：表示管理员密码</li>
</ul>
<h4 id="修改管理员信息"><a href="#修改管理员信息" class="headerlink" title="修改管理员信息"></a>修改管理员信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openldap/slapd.d/cn\=config/olcDatabase\=\&#123;1\&#125;monitor.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518193954213.png" alt="image-20220518193954213"></p>
<ul>
<li><strong>dn.base</strong>是修改<strong>OpenLDAP的管理员的相关信息</strong></li>
</ul>
<p>验证OpenLDAP的基本配置，使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaptest -u</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518194138726.png" alt="image-20220518194138726"></p>
<p>重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart slapd</span><br><span class="line">sudo systemctl status slapd</span><br></pre></td></tr></table></figure>

<h3 id="配置OpenLDAP数据库"><a href="#配置OpenLDAP数据库" class="headerlink" title="配置OpenLDAP数据库"></a>配置<code>OpenLDAP</code>数据库</h3><p>OpenLDAP默认使用的数据库是BerkeleyDB，现在来开始配置OpenLDAP数据库，使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span><br><span class="line"><span class="built_in">cp</span> /usr/share/openldap-servers/slapd.ldif /etc/openldap/slapd.ldif</span><br><span class="line"><span class="built_in">chown</span> ldap:ldap -R /var/lib/ldap</span><br><span class="line"><span class="built_in">chmod</span> 700 -R /var/lib/ldap</span><br><span class="line">ll /var/lib/ldap/</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518194451664.png" alt="image-20220518194451664"></p>
<blockquote>
<p><code>/var/lib/ldap/</code>就是 <code>BerkeleyDB</code> 数据库默认存储的路径。</p>
</blockquote>
<h3 id="导入基本Schema"><a href="#导入基本Schema" class="headerlink" title="导入基本Schema"></a>导入基本Schema</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif</span><br></pre></td></tr></table></figure>

<h2 id="安装-migrationtools"><a href="#安装-migrationtools" class="headerlink" title="安装  migrationtools"></a>安装  <code>migrationtools</code></h2><p><code>migrationtools</code> 实现<code>OpenLDAP</code> 用户及用户组的添加，<code>migrationtools</code> 开源工具通过查找&#x2F;etc&#x2F;passwd、&#x2F;etc&#x2F;shadow、&#x2F;etc&#x2F;groups 生成LDIF 文件，并通过<code>ldapadd</code> 命令更新数据库数据，完成用户添加。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y migrationtools</span><br></pre></td></tr></table></figure>

<h3 id="修改migrate-common-ph文件"><a href="#修改migrate-common-ph文件" class="headerlink" title="修改migrate_common.ph文件"></a>修改migrate_common.ph文件</h3><p><code>migrate_common.ph</code>文件主要是用于生成<code>ldif</code>文件使用，修改<code>migrate_common.ph</code>文件，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/share/migrationtools/migrate_common.ph +71</span><br></pre></td></tr></table></figure>

<p>写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$DEFAULT_MAIL_DOMAIN = “maxzhao.com”;</span><br><span class="line">$DEFAULT_BASE = “dc=maxzhao,dc=com”;</span><br><span class="line">$EXTENDED_SCHEMA = 1;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518195011644.png" alt="image-20220518195011644"></p>
<h2 id="添加用户和用户组"><a href="#添加用户和用户组" class="headerlink" title="添加用户和用户组"></a>添加用户和用户组</h2><p>管理员用户就是 <code>root</code>，没有普通用户</p>
<h3 id="添加系统用户"><a href="#添加系统用户" class="headerlink" title="添加系统用户"></a>添加系统用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">groupadd ldapg1</span><br><span class="line">groupadd ldapg2</span><br><span class="line">useradd -g ldapg1 ldapu1</span><br><span class="line">useradd -g ldapg2 ldapu2</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;1&#x27;</span> | passwd --stdin ldapu1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;2&#x27;</span> | passwd --stdin ldapu2</span><br></pre></td></tr></table></figure>

<h3 id="生成-ldif文件"><a href="#生成-ldif文件" class="headerlink" title="生成 ldif文件"></a>生成 <code>ldif</code>文件</h3><p>取出用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;:10[0-9][0-9]&quot;</span> /etc/passwd &gt; /root/users</span><br><span class="line">grep <span class="string">&quot;:10[0-9][0-9]&quot;</span> /etc/group &gt; /root/groups</span><br><span class="line"><span class="built_in">cat</span> <span class="built_in">users</span></span><br><span class="line"><span class="built_in">cat</span> <span class="built_in">groups</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518195600679.png" alt="image-20220518195600679"></p>
<p>根据上述生成的用户和用户组属性，使用<code>migrate_passwd.pl</code>文件生成要添加用户和用户组的<code>ldif</code>，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/migrationtools/migrate_passwd.pl /root/users &gt; /root/users.ldif</span><br><span class="line">/usr/share/migrationtools/migrate_group.pl /root/groups &gt; /root/groups.ldif</span><br><span class="line"><span class="built_in">cat</span> users.ldif</span><br><span class="line"><span class="built_in">cat</span> groups.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518195823844.png" alt="image-20220518195823844"></p>
<p><img src="/blog/uploads/images/image-20220518195845785.png" alt="image-20220518195845785"></p>
<h3 id="导入用户到LDAP"><a href="#导入用户到LDAP" class="headerlink" title="导入用户到LDAP"></a>导入用户到<code>LDAP</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /root/base.ldif &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">dn: dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">o: maxzhao com</span></span><br><span class="line"><span class="string">dc: maxzhao</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: dcObject</span></span><br><span class="line"><span class="string">objectclass: organization</span></span><br><span class="line"><span class="string">dn: cn=root,dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">cn: root</span></span><br><span class="line"><span class="string">objectClass: organizationalRole</span></span><br><span class="line"><span class="string">description: Directory Manager</span></span><br><span class="line"><span class="string">dn: ou=People,dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">ou: People</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: organizationalUnit</span></span><br><span class="line"><span class="string">dn: ou=Group,dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">ou: Group</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: organizationalUnit</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>导入基础数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -x -w <span class="string">&quot;maxzhao&quot;</span> -D <span class="string">&quot;cn=root,dc=maxzhao,dc=com&quot;</span> -f /root/base.ldif</span><br></pre></td></tr></table></figure>

<p>导入用户到数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -x -w <span class="string">&quot;maxzhao&quot;</span> -D <span class="string">&quot;cn=root,dc=maxzhao,dc=com&quot;</span> -f /root/users.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518200312581.png" alt="image-20220518200312581"></p>
<p>查看<code>BerkeleyDB</code>数据库文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /var/lib/ldap/</span><br></pre></td></tr></table></figure>







<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.ilanni.com/?p=13775">https://www.ilanni.com/?p=13775</a></p>
</blockquote>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/4754f56b/">https://github.com/maxzhao-it/blog/post/4754f56b/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/14/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/blog/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/41/">41</a><a class="extend next" rel="next" href="/blog/page/16/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">赵联胜</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>




  <script src="/blog/js/third-party/pace.js"></script>

  





</body>
</html>
