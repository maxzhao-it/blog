<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/uploads/images/gt.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/images/gt-32.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/images/gt-16.jpg">
  <link rel="mask-icon" href="/blog/uploads/images/logo.png" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>



<link rel="canonical" href="https://github.com/maxzhao-it/blog/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>maxzhao</title>
  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<link rel="alternate" href="/blog/atom.xml" title="maxzhao" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">maxzhao</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不要害怕Exception和Error</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-schedule"><a href="/blog/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="赵联胜"
      src="/blog/uploads/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">赵联胜</p>
  <div class="site-description" itemprop="description">小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">289</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">133</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">161</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://gitee.com/zhaoliansheng" title="GitHub → https:&#x2F;&#x2F;gitee.com&#x2F;zhaoliansheng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/blog/1441439636@qq.com" title="E-Mail → 1441439636@qq.com"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.jianshu.com/u/e8c426a6007e" title="https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;e8c426a6007e" rel="noopener" target="_blank">我的简书</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/e1cf5d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/e1cf5d/" class="post-title-link" itemprop="url">CentOS安装Jenkins</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-28 18:30:51" itemprop="dateModified" datetime="2022-07-28T18:30:51+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/DevelopTools/" itemprop="url" rel="index"><span itemprop="name">DevelopTools</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/DevelopTools/Jenkins/" itemprop="url" rel="index"><span itemprop="name">Jenkins</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>Jenkins</code> 是一款非常强大的持续集成工具</p>
<p><code>Jenkins</code>需要安装 <code>Java8 or  Java11</code></p>
<h3 id="安装-Java8"><a href="#安装-Java8" class="headerlink" title="安装 Java8"></a>安装 <code>Java8</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y java-1.8.0-openjdk-devel</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<h3 id="安装-Jenkins"><a href="#安装-Jenkins" class="headerlink" title="安装 Jenkins"></a>安装 <code>Jenkins</code></h3><p>To use this repository, run the following command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo yum upgrade</span><br><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">sudo yum install epel-release # repository that provides &#x27;daemonize&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install java-11-openjdk-devel</span></span><br><span class="line">sudo yum install jenkins</span><br></pre></td></tr></table></figure>

<p>If you’ve previously imported the key from Jenkins, the <code>rpm --import</code> will fail because you already have a key. Please<br>ignore that and move on.</p>
<p>The rpm packages were signed using this key:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pub   rsa4096 2020-03-30 [SC] [expires: 2023-03-30]</span><br><span class="line">      62A9756BFD780C377CF24BA8FCEF32E745F2C3D5</span><br><span class="line">uid                      Jenkins Project </span><br><span class="line">sub   rsa4096 2020-03-30 [E] [expires: 2023-03-30]</span><br></pre></td></tr></table></figure>

<h3 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h3><p><a href="https://github.com/jenkinsci/jenkins/releases"><code>GitHub</code>地址</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh jenkins-2.327-1.1.noarch.rpm</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start jenkins</span><br><span class="line">sudo systemctl status jenkins</span><br><span class="line">sudo systemctl enable jenkins</span><br><span class="line">sudo cat /var/lib/jenkins/secrets/initialAdminPassword </span><br></pre></td></tr></table></figure>

<h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><p><a target="_blank" rel="noopener" href="http://192.168.2.250:8080/">http://192.168.2.250:8080</a></p>
<p>输入 <code>initialAdminPassword</code> 文件中的密码</p>
<h3 id="配置中文"><a href="#配置中文" class="headerlink" title="配置中文"></a>配置中文</h3><p>插件管理中安装 <code>locale</code>插件。</p>
<p>系统管理配置中找到 <code>Default Language</code> &#x3D; <code>zh_CN</code></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://pkg.jenkins.io/redhat-stable/">参考官网</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jenkins.io/doc/book/installing/linux/">官网 doc book install linux</a></p>
</blockquote>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/e1cf5d/">https://github.com/maxzhao-it/blog/post/e1cf5d/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/cf860b21/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/cf860b21/" class="post-title-link" itemprop="url">SpringBoot集成liquibase案例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-28 17:37:15" itemprop="dateModified" datetime="2022-07-28T17:37:15+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/DB/" itemprop="url" rel="index"><span itemprop="name">DB</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>项目中版本发布需要做一个版本管理工具，项目使用 <code>SpringBoot</code> 框架。</p>
<p>目前有两款 <code>liquibase</code> 和 <code>flyway</code>。</p>
<p><code>flyway</code>不支持并发，也就是集群项目会执行多次，进而否掉。</p>
<p><code>Liquibase</code> ：</p>
<ul>
<li>支持执行锁、回滚；</li>
<li>支持<code>MySQL</code>, <code>PostgreSQL</code>, <code>Oracle</code>, <code>Sql Server</code>等；</li>
<li>支持多开发者（每个脚本必须写 <code>author</code> ）；</li>
<li>多种运行方式：命令行、<code>Spring</code>集成、<code>Maven</code>插件等</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.liquibase.com/home.html">官网</a></p>
</blockquote>
<p><code>Liquibase</code>文件结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">databaseChangeLog</span><br><span class="line">├── createTable </span><br><span class="line">|    ├── column</span><br><span class="line">|    ├── ...</span><br><span class="line">|    └── remarks </span><br><span class="line">├── createView</span><br><span class="line">|    ├── ...</span><br><span class="line">|    └── viewName </span><br><span class="line">├── ...</span><br><span class="line">└── sqlFile </span><br></pre></td></tr></table></figure>

<h2 id="Liquibase使用"><a href="#Liquibase使用" class="headerlink" title="Liquibase使用"></a><code>Liquibase</code>使用</h2><h3 id="Maven引入"><a href="#Maven引入" class="headerlink" title="Maven引入"></a><code>Maven</code>引入</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.liquibase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>liquibase-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><code>application.yml</code> 文件配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">liquibase:</span></span><br><span class="line">    <span class="comment"># 开启(默认true)</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 文件路径</span></span><br><span class="line">    <span class="attr">change-log:</span> <span class="string">classpath:/liquibase/change_log/Init_table.xml</span></span><br><span class="line">    <span class="comment"># 是否先删除数据库模式(默认 false)</span></span><br><span class="line">    <span class="attr">drop-first:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 版本记录表名</span></span><br><span class="line">    <span class="attr">database-change-log-table:</span> <span class="string">DATABASECHANGELOG</span></span><br><span class="line">    <span class="comment"># 版本记录执行锁</span></span><br><span class="line">    <span class="attr">database-change-log-lock-table:</span> <span class="string">DATABASECHANGELOGLOCK</span></span><br></pre></td></tr></table></figure>

<p><code>Init_table.xml</code> 文件配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">databaseChangeLog</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns</span>=<span class="string">&quot;http://www.liquibase.org/xml/ns/dbchangelog&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">changeSet</span> <span class="attr">id</span>=<span class="string">&quot;V0.0.1-20211017-001&quot;</span> <span class="attr">author</span>=<span class="string">&quot;maxzhao&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">createTable</span> <span class="attr">tableName</span>=<span class="string">&quot;a_demo_user&quot;</span> <span class="attr">remarks</span>=<span class="string">&quot;用户表&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;bigint&quot;</span> <span class="attr">remarks</span>=<span class="string">&quot;用户主键&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">constraints</span> <span class="attr">nullable</span>=<span class="string">&quot;false&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;true&quot;</span> <span class="attr">primaryKeyName</span>=<span class="string">&quot;pk_a_demo_user_id&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">column</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">type</span>=<span class="string">&quot;varchar(100)&quot;</span> <span class="attr">remarks</span>=<span class="string">&quot;用户名&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">constraints</span> <span class="attr">nullable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">column</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">type</span>=<span class="string">&quot;varchar(100)&quot;</span> <span class="attr">remarks</span>=<span class="string">&quot;密码&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">constraints</span> <span class="attr">nullable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">createTable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">changeSet</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;changeSet id=&quot;V0.0.1-20211017-001&quot; author=&quot;maxzhao&quot;&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SQL 文件的方式，不推荐，不能兼容不同数据库 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;sqlFile path=&quot;test.sql&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;/changeSet&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  加载其它文件  --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;include file=&quot;&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">databaseChangeLog</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：</p>
<ul>
<li><code>ID</code>是唯一的，是存储数据库中判断 <code>ChangeSet</code> 是否执行的重要依据</li>
<li><code>SQL</code> 脚本文件不应该包含 <code>schema</code> 名称</li>
<li>表、字段需要添加 <code>remarks</code> 注释</li>
<li>已经执行的 <code>changeSet</code> 禁止修改，启动会报错。</li>
<li>不要随便升级版本，特别是大版本。不同版本的 <code>CHangeSet MD5SUM</code> 算法很可能不一样。</li>
<li>不要添加业务数据的修改，可能换个项目就不能用了。</li>
</ul>
</blockquote>
<h3 id="生成已存在表结构"><a href="#生成已存在表结构" class="headerlink" title="生成已存在表结构"></a>生成已存在表结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成表结构</span></span><br><span class="line">liquibase --driver=com.mysql.cj.jdbc.Driver --classpath=mysql-connector-java-8.0.26.jar --changeLogFile=./dbchangelog.xml --url=&quot;jdbc:mysql://localhost:3306/blog&quot; --username=root --password=root generateChangeLog</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成表数据</span></span><br><span class="line">liquibase --driver=com.mysql.cj.jdbc.Driver --classpath=mysql-connector-java-8.0.26.jar --changeLogFile=./dbchangelog.xml --url=&quot;jdbc:mysql://localhost:3306/blog&quot; --username=root --password=root --diffTypes=data generateChangeLog</span><br></pre></td></tr></table></figure>


<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/cf860b21/">https://github.com/maxzhao-it/blog/post/cf860b21/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/b2db72d0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/b2db72d0/" class="post-title-link" itemprop="url">JetCache注解配置全局默认CacheType</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Jetcache</code>缓存可以使用的 <code>CacheType</code> 有 <code>REMOTE</code>, <code>LOCAL</code>, <code>BOTH</code> ；</p>
<p>注解 <code>@Cached</code> 在使用时，可以 <code>CacheType</code>，如果不指定，则默认为 <code>REMOTE</code>。</p>
<p>平台中的缓存注解在各个项目运行时，是无法修改的，并且平台中的缓存注解没有指定 <code>CacheType</code>。</p>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>满足不同项目对平台缓存存储方式的自定义配置。</p>
<p>场景一：没有缓存中间件，使用 <code>caffeine</code> 本地缓存。</p>
<p>场景二：有缓存中间件，比如<code>Redis</code>，使用 <code>remote.**.type=REDIS</code></p>
<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>为了满足不同场景的需要。</p>
<p>实现以下功能：</p>
<ol>
<li>在注解<code>CacheType=REMOTE</code> 的情况下，实现默认缓存可以由 <code>REMOTE</code>  改为   <code>LOCAL</code>、<code>BOTH</code>。</li>
</ol>
<h2 id="风险"><a href="#风险" class="headerlink" title="风险"></a>风险</h2><h3 id="风险一"><a href="#风险一" class="headerlink" title="风险一"></a>风险一</h3><p>在用户需要把缓存注解默认为 <code>CacheType=REMOTE</code> 的数据，改为 <code>BOTH</code>，并且需要主动指定缓存注解 <code>CacheType=REMOTE</code> 的数据，只存到 <code>REMOTE</code> 中。</p>
<h2 id="解决风险"><a href="#解决风险" class="headerlink" title="解决风险"></a>解决风险</h2><h3 id="风险一-1"><a href="#风险一-1" class="headerlink" title="风险一"></a>风险一</h3><p>当前是实现了多个缓存系统（<code>LOCAL</code>、<code>REMOTE</code>），所以需要自定义的缓存中，指定缓存的 <code>area</code> （默认为 <code>default</code>）。</p>
<p>下面是 <code>area</code> 描述的原话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * If you want to use multi backend cache system, you can setup multi &quot;cache area&quot; in configuration,</span><br><span class="line">     * this attribute specifies the name of the &quot;cache area&quot; you want to use.</span><br><span class="line">     * @return the name of cache area</span><br><span class="line">     */</span><br></pre></td></tr></table></figure>



<p>因为主要目的是修改平台默认的缓存方案，并不是项目中默认的缓存方案，所以只需要处理平台缓存 <code>area</code> 下的 <code>CacheType</code>。</p>
<p>当平台缓存的 <code>area</code> 与  项目中缓存的 <code>area</code> 区分开来时，那么平台的默认缓存就很容易修改了。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><ol>
<li>重写 <code>jetcache</code>下的<code>ConfigMap</code>类，处理 <code>CacheType</code>。</li>
<li>建议修改平台缓存的 <code>area</code>（为了适配一个项目多种缓存系统）。</li>
</ol>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="平台中的缓存注解"><a href="#平台中的缓存注解" class="headerlink" title="平台中的缓存注解"></a>平台中的缓存注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CategoryItemServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;CategoryItemMapper, CategoryItem&gt; <span class="keyword">implements</span> <span class="title class_">ICategoryItemService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Cached(name = &quot;categoryItemList:parentId:&quot;,key = &quot;#parentId+&#x27;&#x27;&quot;,area=&quot;systemo_demo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CategoryItemDTO&gt; <span class="title function_">loadCategoryItemListByParentId</span><span class="params">(Long parentId)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;CategoryItem&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.select(</span><br><span class="line">                CategoryItem::getId,</span><br><span class="line">                CategoryItem::getParentId,</span><br><span class="line">                CategoryItem::getItemCode,</span><br><span class="line">                CategoryItem::getName)</span><br><span class="line">                .eq(CategoryItem::getParentId,parentId)</span><br><span class="line">                .eq(CategoryItem::getDelStatus,BaseConstant.NO)</span><br><span class="line">                .orderByAsc(CategoryItem::getSortIndex);</span><br><span class="line">        <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> <span class="built_in">this</span>.list(queryWrapper);</span><br><span class="line">        <span class="keyword">return</span> categoryConvert.convertToCategoryItemDTOList(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>systemo_demo</code>是平台内的系统常量</p>
</blockquote>
<h3 id="ConfigMap处理默认缓存方式"><a href="#ConfigMap处理默认缓存方式" class="headerlink" title="ConfigMap处理默认缓存方式"></a><code>ConfigMap</code>处理默认缓存方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCacheConfigMap</span> <span class="keyword">extends</span> <span class="title class_">ConfigMap</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putByMethodInfo</span><span class="params">(String key, CacheInvokeConfig config)</span> &#123;</span><br><span class="line">        methodInfoMap.put(key, config);</span><br><span class="line">        <span class="type">CachedAnnoConfig</span> <span class="variable">cac</span> <span class="operator">=</span> config.getCachedAnnoConfig();</span><br><span class="line">        <span class="keyword">if</span> (cac != <span class="literal">null</span> &amp;&amp; !CacheConsts.isUndefined(cac.getName())) &#123;</span><br><span class="line">            <span class="comment">/*自定义校验使用的 CacheType，这里需要注意，只需要判断默认情况下的缓存类型，非默认情况下的默认为开发者主动修改*/</span></span><br><span class="line">            <span class="keyword">if</span> (CacheConsts.DEFAULT_CACHE_TYPE.equals(cac.getCacheType())</span><br><span class="line">                    &amp;&amp; <span class="string">&quot;system.demo&quot;</span>.equals(cac.getArea())</span><br><span class="line">                    <span class="comment">/*当前配置的 cacheType 不为 null*/</span></span><br><span class="line">                    &amp;&amp; cacheConfig.getCacheType() != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                cac.setCacheType(cacheConfig.getCacheType());</span><br><span class="line">            &#125;</span><br><span class="line">            cacheNameMap.put(cac.getArea() + <span class="string">&quot;_&quot;</span> + cac.getName(), config);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/b2db72d0/">https://github.com/maxzhao-it/blog/post/b2db72d0/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/784e58da/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/784e58da/" class="post-title-link" itemprop="url">JetCache注解配置全局默认CacheType</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><ol>
<li>重写 <code>jetcache</code>下的<code>ConfigMap</code>类，处理 <code>CacheType</code>。</li>
<li>建议修改平台缓存的 <code>area</code>（为了适配一个项目多种缓存系统）。</li>
</ol>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="平台中的缓存注解"><a href="#平台中的缓存注解" class="headerlink" title="平台中的缓存注解"></a>平台中的缓存注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CategoryItemServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;CategoryItemMapper, CategoryItem&gt; <span class="keyword">implements</span> <span class="title class_">ICategoryItemService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Cached(name = &quot;categoryItemList:parentId:&quot;, key = &quot;#parentId+&#x27;&#x27;&quot;, area = &quot;systemo_demo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CategoryItemDTO&gt; <span class="title function_">loadCategoryItemListByParentId</span><span class="params">(Long parentId)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;CategoryItem&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.select(</span><br><span class="line">                        CategoryItem::getId,</span><br><span class="line">                        CategoryItem::getParentId,</span><br><span class="line">                        CategoryItem::getItemCode,</span><br><span class="line">                        CategoryItem::getName)</span><br><span class="line">                .eq(CategoryItem::getParentId, parentId)</span><br><span class="line">                .eq(CategoryItem::getDelStatus, BaseConstant.NO)</span><br><span class="line">                .orderByAsc(CategoryItem::getSortIndex);</span><br><span class="line">        <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> <span class="built_in">this</span>.list(queryWrapper);</span><br><span class="line">        <span class="keyword">return</span> categoryConvert.convertToCategoryItemDTOList(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>systemo_demo</code>是平台内的系统常量</p>
</blockquote>
<h3 id="ConfigMap处理默认缓存方式"><a href="#ConfigMap处理默认缓存方式" class="headerlink" title="ConfigMap处理默认缓存方式"></a><code>ConfigMap</code>处理默认缓存方式</h3><p>具体实现请看附录中的 <code>CustomCacheConfigMap</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCacheConfigMap</span> <span class="keyword">extends</span> <span class="title class_">ConfigMap</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putByMethodInfo</span><span class="params">(String key, CacheInvokeConfig config)</span> &#123;</span><br><span class="line">        methodInfoMap.put(key, config);</span><br><span class="line">        <span class="type">CachedAnnoConfig</span> <span class="variable">cac</span> <span class="operator">=</span> config.getCachedAnnoConfig();</span><br><span class="line">        <span class="keyword">if</span> (cac != <span class="literal">null</span> &amp;&amp; !CacheConsts.isUndefined(cac.getName())) &#123;</span><br><span class="line">            <span class="comment">/*自定义校验使用的 CacheType，这里需要注意，只需要判断默认情况下的缓存类型，非默认情况下的默认为开发者主动修改*/</span></span><br><span class="line">            <span class="keyword">if</span> (CacheConsts.DEFAULT_CACHE_TYPE.equals(cac.getCacheType())</span><br><span class="line">                    &amp;&amp; <span class="string">&quot;system.demo&quot;</span>.equals(cac.getArea())</span><br><span class="line">                    <span class="comment">/*当前配置的 cacheType 不为 null*/</span></span><br><span class="line">                    &amp;&amp; cacheConfig.getCacheType() != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                cac.setCacheType(cacheConfig.getCacheType());</span><br><span class="line">            &#125;</span><br><span class="line">            cacheNameMap.put(cac.getArea() + <span class="string">&quot;_&quot;</span> + cac.getName(), config);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><h2 id="自定义的-CustomCacheConfigMap"><a href="#自定义的-CustomCacheConfigMap" class="headerlink" title="自定义的 CustomCacheConfigMap"></a>自定义的 <code>CustomCacheConfigMap</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义缓存注解存储类&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * 替代 jetcache 的默认 ConfigMap&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * 实现了全局配置默认缓存方式&lt;br&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> maxzhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-09-24 15:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCacheConfigMap</span> <span class="keyword">extends</span> <span class="title class_">ConfigMap</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义缓存配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BootCacheProperties bootCacheProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomCacheConfigMap</span><span class="params">(BootCacheProperties bootCacheProperties)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bootCacheProperties = bootCacheProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, CacheInvokeConfig&gt; methodInfoMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注解后的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, CacheInvokeConfig&gt; cacheNameMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putByMethodInfo</span><span class="params">(String key, CacheInvokeConfig config)</span> &#123;</span><br><span class="line">        methodInfoMap.put(key, config);</span><br><span class="line">        <span class="type">CachedAnnoConfig</span> <span class="variable">cac</span> <span class="operator">=</span> config.getCachedAnnoConfig();</span><br><span class="line">        Map&lt;String, CacheType&gt; autoAreaCacheType = Optional.ofNullable(bootCacheProperties.getAutoAreaCacheType()).orElse(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cac != <span class="literal">null</span> &amp;&amp; !CacheConsts.isUndefined(cac.getName())) &#123;</span><br><span class="line">            <span class="comment">/*自定义校验使用的 CacheType，这里需要注意，只需要判断默认情况下的缓存类型，非默认情况下的默认为开发者主动修改*/</span></span><br><span class="line">            <span class="type">CacheType</span> <span class="variable">cacheType</span> <span class="operator">=</span> autoAreaCacheType.get(cac.getArea());</span><br><span class="line">            <span class="keyword">if</span> (config.getCachedAnnoConfig() != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; CacheConsts.DEFAULT_CACHE_TYPE.equals(config.getCachedAnnoConfig().getCacheType())</span><br><span class="line">                    <span class="comment">/*当前配置的 cacheType 不为 null*/</span></span><br><span class="line">                    &amp;&amp; cacheType != <span class="literal">null</span>) &#123;</span><br><span class="line">                config.getCachedAnnoConfig().setCacheType(cacheType);</span><br><span class="line">            &#125;</span><br><span class="line">            cacheNameMap.put(cac.getArea() + <span class="string">&quot;_&quot;</span> + cac.getName(), config);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CacheInvokeConfig <span class="title function_">getByMethodInfo</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> methodInfoMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CacheInvokeConfig <span class="title function_">getByCacheName</span><span class="params">(String area, String cacheName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cacheNameMap.get(area + <span class="string">&quot;_&quot;</span> + cacheName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="BootCacheProperties-配置"><a href="#BootCacheProperties-配置" class="headerlink" title="BootCacheProperties 配置"></a><code>BootCacheProperties</code> 配置</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gt:</span></span><br><span class="line">  <span class="attr">boot:</span></span><br><span class="line">    <span class="comment"># 缓存配置</span></span><br><span class="line">    <span class="attr">cache:</span></span><br><span class="line">      <span class="comment"># 不同域的默认缓存方式 JetCache默认方式为 remote</span></span><br><span class="line">      <span class="attr">auto-area-cache-type:</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">REMOTE</span></span><br><span class="line">        <span class="attr">otherArea:</span> <span class="string">REMOTE</span></span><br><span class="line">      <span class="comment"># 对不同名称的缓存，进行自定义的缓存配置</span></span><br><span class="line">      <span class="attr">autoConfig:</span> &#123; <span class="attr">user:</span> <span class="string">60ms</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootCacheProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不同域的默认缓存方式&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * JetCache默认方式为 remote，</span></span><br><span class="line"><span class="comment">     * 这里需要根据 area 划分，统一替换 单个 area 的 CacheType</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, CacheType&gt; autoAreaCacheType = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义配置 cacheName 与 过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Duration&gt; autoConfig = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注册-Bean"><a href="#注册-Bean" class="headerlink" title="注册 Bean"></a>注册 <code>Bean</code></h3><p>在配置类中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*激活 Cached*/</span></span><br><span class="line"><span class="meta">@EnableMethodCache(basePackages = &quot;com.gt&quot;)</span></span><br><span class="line"><span class="comment">/*激活 CreateCache注解*/</span></span><br><span class="line"><span class="meta">@EnableCreateCacheAnnotation</span></span><br><span class="line"><span class="meta">@EnableCaching(mode = AdviceMode.PROXY)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartCacheConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CacheProperties 的 bean 没有默认加载，所有要手动加载一下</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.cache&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CacheProperties <span class="title function_">getCacheProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CacheProperties</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义的缓存配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> BootCacheProperties</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;gt.boot.cache&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BootCacheProperties <span class="title function_">bootCacheProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BootCacheProperties</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisCacheConfiguration <span class="title function_">cacheConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CacheConfigurationUtil.getRedisCacheConfigurationWithTtl(Duration.ZERO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解决 <span class="doctag">@Cache</span> 方法上注解的默认 CacheType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bootCacheProperties 自定义参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ConfigMap 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line">    <span class="keyword">public</span> ConfigMap <span class="title function_">jetcacheConfigMap</span><span class="params">(BootCacheProperties bootCacheProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomCacheConfigMap</span>(bootCacheProperties);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/784e58da/">https://github.com/maxzhao-it/blog/post/784e58da/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/15752/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/15752/" class="post-title-link" itemprop="url">MyBatisPlus代码生成器打包ZIP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/MyBatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>MyBatisPlus</code> 通过自定义生成器、模板引擎、模板，可以生成许多简化开发的类、方法等等。</p>
<p>这里把生成的文件，导出到<code>ZIP</code>文件。</p>
<p>主要目的是方便统一管理代码生成器。</p>
<blockquote>
<p>需要了解自定义代码生成器</p>
<p>参考：<a href="../15751">MyBatisPlus代码生成器自定义FreemarkerEngine</a></p>
</blockquote>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="pom-xml配置"><a href="#pom-xml配置" class="headerlink" title="pom.xml配置"></a><code>pom.xml</code>配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义模板引擎类"><a href="#自定义模板引擎类" class="headerlink" title="自定义模板引擎类"></a>自定义模板引擎类</h2><p><code>CustomFreemarkerTemplateEngine</code></p>
<h2 id="AutoGenerator配置"><a href="#AutoGenerator配置" class="headerlink" title="AutoGenerator配置"></a><code>AutoGenerator</code>配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MpGeneratorDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AutoGenerator</span> <span class="variable">mpg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutoGenerator</span>();</span><br><span class="line">        <span class="comment">/**省略其他配置*/</span></span><br><span class="line">        <span class="type">CustomFreemarkerTemplateEngine</span> <span class="variable">templateEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomFreemarkerTemplateEngine</span>(config);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ZipOutputStream</span> <span class="variable">zip</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipOutputStream</span>(outputStream);</span><br><span class="line">        templateEngine.setZipOutputStream(zip);</span><br><span class="line">        <span class="comment">/*配置模板引擎的属性，比如自定义的config，构造时传参*/</span></span><br><span class="line">        mpg.setTemplateEngine(templateEngine);</span><br><span class="line">        <span class="comment">/*待输出的的文件流*/</span></span><br><span class="line">        outputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="FreemarkerEngine"><a href="#FreemarkerEngine" class="headerlink" title="FreemarkerEngine"></a><code>FreemarkerEngine</code></h1><p><strong>为什么把生成文件写在模板引擎里？</strong></p>
<p>因为模板引擎里有装配好的文件路径，比较直观。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFreemarkerTemplateEngine</span> <span class="keyword">extends</span> <span class="title class_">AbstractTemplateEngine</span> &#123;</span><br><span class="line">    <span class="comment">/*****************/</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * zip 输出流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> ZipOutputStream zipOutputStream;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writer</span><span class="params">(Map&lt;String, Object&gt; objectMap, String templatePath, String outputFile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(templatePath);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile)) &#123;</span><br><span class="line">            template.process(objectMap, <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(fileOutputStream, ConstVal.UTF8));</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;模板:&quot;</span> + templatePath + <span class="string">&quot;;  文件:&quot;</span> + outputFile);</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            zipOutputStream.putNextEntry(<span class="keyword">new</span> <span class="title class_">ZipEntry</span>(outputFile.replace(config.getOutPutDir(), <span class="string">&quot;&quot;</span>)));</span><br><span class="line">            <span class="type">byte</span>[] buff = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(outputFile);</span><br><span class="line">                <span class="comment">/*读取文件*/</span></span><br><span class="line">                bufferedInputStream = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(inputStream);</span><br><span class="line">                <span class="comment">/*判断：当前已经传递的数据大小+当前已有的长度，小于总长度时，*/</span></span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedInputStream.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    zipOutputStream.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误：模板 :&#123;&#125;;  文件:&#123;&#125;&quot;</span>, templatePath, outputFile);</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IOUtils.closeQuietly(inputStream);</span><br><span class="line">                IOUtils.closeQuietly(bufferedInputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="CodeGeneratorFactory类"><a href="#CodeGeneratorFactory类" class="headerlink" title="CodeGeneratorFactory类"></a><code>CodeGeneratorFactory</code>类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gt.code.generator.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.AutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.InjectionConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.*;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.converts.OracleTypeConvert;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.IColumnType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorConfig;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorDbConfig;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorEnumVal;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorVal;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.util.template.CustomFreemarkerTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成代码工厂&lt;br&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> maxzhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-08-27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeGeneratorFactory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动填充</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;TableFill&gt; TABLE_FILL_LIST = Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;createTime&quot;</span>, FieldFill.INSERT),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;updateTime&quot;</span>, FieldFill.UPDATE),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;delStatus&quot;</span>, FieldFill.INSERT_UPDATE));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">CodeGeneratorFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] generate(CodeGeneratorConfig config) &#123;</span><br><span class="line">        <span class="type">AutoGenerator</span> <span class="variable">mpg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutoGenerator</span>();</span><br><span class="line">        <span class="type">CodeGeneratorDbConfig</span> <span class="variable">dbConfig</span> <span class="operator">=</span> config.getDbConfig();</span><br><span class="line">        <span class="comment">/*输出路径*/</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">outPutDir</span> <span class="operator">=</span> config.getFullOutPutDir();</span><br><span class="line">        <span class="comment">//region 注入配置</span></span><br><span class="line">        mpg.setCfg(configInjection(config));</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 数据源配置</span></span><br><span class="line">        <span class="type">DataSourceConfig</span> <span class="variable">dataSource</span> <span class="operator">=</span> dbConfig.generatorDataSourceConfig();</span><br><span class="line">        <span class="keyword">if</span> (dataSource.getDbType() == DbType.ORACLE) &#123;</span><br><span class="line">            dataSource.setTypeConvert(<span class="keyword">new</span> <span class="title class_">OracleTypeConvert</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> IColumnType <span class="title function_">processTypeConvert</span><span class="params">(GlobalConfig globalConfig, String fieldType)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fieldType.toLowerCase(Locale.ROOT).matches(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.processTypeConvert(globalConfig, fieldType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        mpg.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 表策略配置</span></span><br><span class="line">        <span class="type">StrategyConfig</span> <span class="variable">strategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StrategyConfig</span>();</span><br><span class="line">        <span class="comment">/*驼峰*/</span></span><br><span class="line">        strategy.setNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">        <span class="comment">/*驼峰*/</span></span><br><span class="line">        strategy.setColumnNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">        <span class="comment">/*使用 lombok*/</span></span><br><span class="line">        strategy.setEntityLombokModel(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">/*默认使用 restfull风格*/</span></span><br><span class="line">        strategy.setRestControllerStyle(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">/*标*/</span></span><br><span class="line">        strategy.setInclude(config.getTablesNames());</span><br><span class="line">        <span class="comment">/*驼峰转连字符串*/</span></span><br><span class="line">        strategy.setControllerMappingHyphenStyle(<span class="literal">true</span>);</span><br><span class="line">        strategy.setTablePrefix(config.getTablePrefix());</span><br><span class="line">        <span class="comment">/*字段添加 @TableField*/</span></span><br><span class="line">        strategy.setEntityTableFieldAnnotationEnable(<span class="literal">true</span>);</span><br><span class="line">        strategy.setTableFillList(TABLE_FILL_LIST);</span><br><span class="line">        mpg.setStrategy(strategy);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 包配置</span></span><br><span class="line">        <span class="type">PackageConfig</span> <span class="variable">pc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageConfig</span>();</span><br><span class="line">        pc.setModuleName(config.getModuleName());</span><br><span class="line">        pc.setParent(config.getParentPackage());</span><br><span class="line">        <span class="comment">/*设置 controller 文件 包名*/</span></span><br><span class="line">        pc.setController(CodeGeneratorEnumVal.CONTROLLER.getPackageName());</span><br><span class="line">        <span class="comment">/*设置 xml 文件 包名*/</span></span><br><span class="line">        pc.setXml(<span class="string">&quot;mapper&quot;</span>);</span><br><span class="line">        <span class="comment">/*设置 entity 文件 包名*/</span></span><br><span class="line">        pc.setEntity(<span class="string">&quot;model.entity&quot;</span>);</span><br><span class="line">        pc.setXml(<span class="string">&quot;mapper&quot;</span>);</span><br><span class="line">        mpg.setPackageInfo(pc);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 模板配置</span></span><br><span class="line">        <span class="type">TemplateConfig</span> <span class="variable">templateConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplateConfig</span>()</span><br><span class="line">                .setEntity(CodeGeneratorEnumVal.ENTITY.getTemplate())</span><br><span class="line">                .setController(CodeGeneratorEnumVal.CONTROLLER.getTemplate())</span><br><span class="line">                .setService(CodeGeneratorEnumVal.SERVICE.getTemplate())</span><br><span class="line">                .setServiceImpl(CodeGeneratorEnumVal.SERVICE_IMPL.getTemplate())</span><br><span class="line">                .setMapper(CodeGeneratorEnumVal.MAPPER.getTemplate())</span><br><span class="line">                .setXml(CodeGeneratorEnumVal.TEMPLATE_XML.getTemplate());</span><br><span class="line">        mpg.setTemplate(templateConfig);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 全局配置</span></span><br><span class="line">        <span class="comment">/*默认使用雪花算法*/</span></span><br><span class="line">        <span class="type">GlobalConfig</span> <span class="variable">gc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GlobalConfig</span>();</span><br><span class="line">        gc.setOutputDir(outPutDir);</span><br><span class="line">        gc.setAuthor(config.getAuthor());</span><br><span class="line">        gc.setOpen(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">/*默认不覆盖，如果文件存在，将不会再生成，配置true就是覆盖*/</span></span><br><span class="line">        gc.setFileOverride(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">/*配置 swagger2*/</span></span><br><span class="line">        gc.setSwagger2(config.getSwagger2());</span><br><span class="line">        <span class="comment">/*开启 ActiveRecord 模式*/</span></span><br><span class="line">        gc.setActiveRecord(config.getActiveRecord());</span><br><span class="line">        mpg.setGlobalConfig(gc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 模板引擎</span></span><br><span class="line">        <span class="comment">// 选择 freemarker 引擎需要指定如下加，注意 pom 依赖必须有！</span></span><br><span class="line">        <span class="type">CustomFreemarkerTemplateEngine</span> <span class="variable">templateEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomFreemarkerTemplateEngine</span>(config);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">ZipOutputStream</span> <span class="variable">zip</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="comment">/*下载zip文件 字节输出流*/</span></span><br><span class="line">            outputStream = <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            zip = <span class="keyword">new</span> <span class="title class_">ZipOutputStream</span>(outputStream);</span><br><span class="line">            templateEngine.setZipOutputStream(zip);</span><br><span class="line">            <span class="comment">/*下载zip ，会覆盖文件*/</span></span><br><span class="line">            gc.setFileOverride(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mpg.setTemplateEngine(templateEngine);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        mpg.execute();</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="comment">/*获取结果*/</span></span><br><span class="line">            <span class="comment">//等同于自己写判断然后关闭</span></span><br><span class="line">            IOUtils.closeQuietly(zip);</span><br><span class="line">            <span class="keyword">return</span> outputStream != <span class="literal">null</span> ? outputStream.toByteArray() : <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加自动填充</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableFill 新的自动填充</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addTableFill</span><span class="params">(TableFill tableFill)</span> &#123;</span><br><span class="line">        TABLE_FILL_LIST.add(tableFill);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置自定义参数/属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config 配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InjectionConfig <span class="title function_">configInjection</span><span class="params">(CodeGeneratorConfig config)</span> &#123;</span><br><span class="line">        <span class="comment">// 自定义配置</span></span><br><span class="line">        <span class="type">InjectionConfig</span> <span class="variable">cfg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectionConfig</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initMap</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">controllerPackage</span> <span class="operator">=</span> <span class="built_in">this</span>.getConfig().getPackageInfo().get(<span class="string">&quot;Controller&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Dto&quot;</span>, controllerPackage + <span class="string">&quot;.dto&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Params&quot;</span>, controllerPackage + <span class="string">&quot;.Params&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Vo&quot;</span>, controllerPackage + <span class="string">&quot;.vo&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Convert&quot;</span>, controllerPackage.substring(<span class="number">0</span>, controllerPackage.lastIndexOf(CodeGeneratorEnumVal.CONTROLLER.getPackageName())) + CodeGeneratorEnumVal.CONVERT.getPackageName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">xmlPath</span> <span class="operator">=</span> <span class="built_in">this</span>.getConfig().getPathInfo().get(<span class="string">&quot;xml_path&quot;</span>);</span><br><span class="line">                <span class="comment">/*修改 xml 生成路径*/</span></span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPathInfo().put(<span class="string">&quot;xml_path&quot;</span>, xmlPath.replace(CodeGeneratorVal.JAVA_SOURCE_PATH, CodeGeneratorVal.XML_SOURCE_PATH));</span><br><span class="line">                Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">                <span class="comment">/*自定义cfg引用*/</span></span><br><span class="line">                <span class="built_in">this</span>.setMap(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        List&lt;FileOutConfig&gt; focList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">/*dto 模板*/</span></span><br><span class="line">        focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.DTO));</span><br><span class="line">        <span class="comment">/*params 模板*/</span></span><br><span class="line">        focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.PARAMS));</span><br><span class="line">        <span class="comment">/*vo 模板*/</span></span><br><span class="line">        focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.VO));</span><br><span class="line">        <span class="comment">/*判断是否使用 mapstruct convert*/</span></span><br><span class="line">        <span class="keyword">if</span> ((config.getUseConvert() != <span class="literal">null</span> &amp;&amp; config.getUseConvert())</span><br><span class="line">                <span class="comment">/*增删查改时使用*/</span></span><br><span class="line">                || (config.getActiveCrud() != <span class="literal">null</span> &amp;&amp; config.getActiveCrud())) &#123;</span><br><span class="line">            <span class="comment">/*convert 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.CONVERT));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*使用增删查改*/</span></span><br><span class="line">        <span class="keyword">if</span> (config.getActiveCrud() != <span class="literal">null</span> &amp;&amp; config.getActiveCrud()) &#123;</span><br><span class="line">            <span class="comment">/*exception 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.EXCEPTION));</span><br><span class="line">            <span class="comment">/*exception enum 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.EXCEPTION_ENUM));</span><br><span class="line">            <span class="comment">/*exception handler 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.EXCEPTION_HANDLER));</span><br><span class="line">        &#125;</span><br><span class="line">        cfg.setFileOutConfigList(focList);</span><br><span class="line">        <span class="keyword">return</span> cfg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载文件输出配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config  配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> enumVal 模板</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mybatis plus 文件输出配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> FileOutConfig <span class="title function_">convertFileOutConfig</span><span class="params">(CodeGeneratorConfig config, CodeGeneratorEnumVal enumVal)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileOutConfig</span>(enumVal.getTemplate()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">outputFile</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">                <span class="comment">/*指定模板生，自定义生成文件到哪个地方*/</span></span><br><span class="line">                <span class="keyword">return</span> config.getModuleOutPutDir() + File.separator +</span><br><span class="line">                        enumVal.getPackageName().replace(<span class="string">&quot;.&quot;</span>, File.separator) +</span><br><span class="line">                        File.separator +</span><br><span class="line">                        String.format(enumVal.getClassName(), tableInfo.getEntityName()) + StringPool.DOT_JAVA;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomFreemarkerTemplateEngine类"><a href="#CustomFreemarkerTemplateEngine类" class="headerlink" title="CustomFreemarkerTemplateEngine类"></a><code>CustomFreemarkerTemplateEngine</code>类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gt.code.generator.util.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.ConstVal;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.builder.ConfigBuilder;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.engine.AbstractTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.engine.FreemarkerTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorConfig;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorEnumVal;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.util.CustomTableInfo;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Configuration;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Template;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义 Freemarker 模板引擎</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> maxzhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-08-28 08:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFreemarkerTemplateEngine</span> <span class="keyword">extends</span> <span class="title class_">AbstractTemplateEngine</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * freemarker 配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * zip 输出流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> ZipOutputStream zipOutputStream;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CodeGeneratorConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config 自定义配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomFreemarkerTemplateEngine</span><span class="params">(CodeGeneratorConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CustomFreemarkerTemplateEngine <span class="title function_">init</span><span class="params">(ConfigBuilder configBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.init(configBuilder);</span><br><span class="line">        configuration = <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.DEFAULT_INCOMPATIBLE_IMPROVEMENTS);</span><br><span class="line">        configuration.setDefaultEncoding(ConstVal.UTF8);</span><br><span class="line">        configuration.setClassForTemplateLoading(FreemarkerTemplateEngine.class, StringPool.SLASH);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writer</span><span class="params">(Map&lt;String, Object&gt; objectMap, String templatePath, String outputFile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(templatePath);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile)) &#123;</span><br><span class="line">            template.process(objectMap, <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(fileOutputStream, ConstVal.UTF8));</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;模板:&quot;</span> + templatePath + <span class="string">&quot;;  文件:&quot;</span> + outputFile);</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            zipOutputStream.putNextEntry(<span class="keyword">new</span> <span class="title class_">ZipEntry</span>(outputFile.replace(config.getOutPutDir(), <span class="string">&quot;&quot;</span>)));</span><br><span class="line">            <span class="type">byte</span>[] buff = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(outputFile);</span><br><span class="line">                <span class="comment">/*读取文件*/</span></span><br><span class="line">                bufferedInputStream = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(inputStream);</span><br><span class="line">                <span class="comment">/*判断：当前已经传递的数据大小+当前已有的长度，小于总长度时，*/</span></span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedInputStream.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    zipOutputStream.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误：模板 :&#123;&#125;;  文件:&#123;&#125;&quot;</span>, templatePath, outputFile);</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IOUtils.closeQuietly(inputStream);</span><br><span class="line">                IOUtils.closeQuietly(bufferedInputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模板路径&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 在配置时，一般不配置 .ftl 文件，这是 Freemarker 模板的习惯，所以这里要在路径上添加 .ftl</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 模板路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 模板真实路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">templateFilePath</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> filePath + <span class="string">&quot;.ftl&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getObjectMap</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; objectMap = <span class="built_in">super</span>.getObjectMap(tableInfo);</span><br><span class="line">        <span class="comment">/*获取类 Package*/</span></span><br><span class="line">        Map&lt;String, String&gt; packageInfo = <span class="built_in">super</span>.getConfigBuilder().getPackageInfo();</span><br><span class="line">        <span class="type">String</span> <span class="variable">controllerPackage</span> <span class="operator">=</span> packageInfo.get(<span class="string">&quot;Controller&quot;</span>);</span><br><span class="line">        <span class="comment">/*基础 package*/</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">basePackage</span> <span class="operator">=</span> controllerPackage.substring(<span class="number">0</span>, controllerPackage.lastIndexOf(CodeGeneratorEnumVal.CONTROLLER.getPackageName()));</span><br><span class="line">        packageInfo.put(<span class="string">&quot;basePackage&quot;</span>, basePackage);</span><br><span class="line">        <span class="comment">/*自定义表数据*/</span></span><br><span class="line">        <span class="type">CustomTableInfo</span> <span class="variable">customTableInfo</span> <span class="operator">=</span> CustomTableInfo.getInstance(tableInfo);</span><br><span class="line">        <span class="comment">/*使用增删改查*/</span></span><br><span class="line">        objectMap.put(<span class="string">&quot;activeCrud&quot;</span>, config.getActiveCrud());</span><br><span class="line">        <span class="keyword">if</span> (config.getActiveCrud() != <span class="literal">null</span> &amp;&amp; config.getActiveCrud()) &#123;</span><br><span class="line">            <span class="comment">/*使用增删改查时，添加代码引入*/</span></span><br><span class="line">            packageInfo.put(<span class="string">&quot;ExceptionHandler&quot;</span>, basePackage + <span class="string">&quot;exception.handler&quot;</span>);</span><br><span class="line">            packageInfo.put(<span class="string">&quot;Exception&quot;</span>, basePackage + <span class="string">&quot;exception&quot;</span>);</span><br><span class="line">            packageInfo.put(<span class="string">&quot;ExceptionEnum&quot;</span>, basePackage + <span class="string">&quot;exception&quot;</span>);</span><br><span class="line">            customTableInfo.initImportPackage(packageInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*每个类的 package*/</span></span><br><span class="line">        objectMap.put(<span class="string">&quot;packageInfo&quot;</span>, packageInfo);</span><br><span class="line">        <span class="comment">/*自定义表数据*/</span></span><br><span class="line">        objectMap.put(<span class="string">&quot;table&quot;</span>, customTableInfo);</span><br><span class="line">        <span class="keyword">return</span> objectMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomTableInfo类"><a href="#CustomTableInfo类" class="headerlink" title="CustomTableInfo类"></a><code>CustomTableInfo</code>类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gt.code.generator.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorEnumVal;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义表配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> maxzhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-08-29 10:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomTableInfo</span> <span class="keyword">extends</span> <span class="title class_">TableInfo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键类型，默认为 String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String idTypeClassName;</span><br><span class="line">    <span class="keyword">private</span> String dtoName;</span><br><span class="line">    <span class="keyword">private</span> String paramsName;</span><br><span class="line">    <span class="keyword">private</span> String voName;</span><br><span class="line">    <span class="keyword">private</span> String convertName;</span><br><span class="line">    <span class="keyword">private</span> String serviceBeanName;</span><br><span class="line">    <span class="keyword">private</span> String mapperBeanName;</span><br><span class="line">    <span class="keyword">private</span> String convertBeanName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常类名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String exceptionName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常枚举</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String exceptionEnumName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常处理类名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String exceptionHandlerName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 CONTROLLER 引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; apiImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 SERVICE 接口引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; serviceImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 SERVICE 实现引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; serviceImplImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 通用 实现引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; crudImplImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomTableInfo</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setConvert(tableInfo.isConvert());</span><br><span class="line">        <span class="built_in">this</span>.setEntityName(tableInfo.getEntityName());</span><br><span class="line">        List&lt;TableField&gt; fields = tableInfo.getFields();</span><br><span class="line">        <span class="built_in">this</span>.setFields(fields);</span><br><span class="line">        <span class="keyword">for</span> (TableField field : fields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (field.isKeyFlag()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.idTypeClassName = field.getColumnType().getType();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(<span class="built_in">this</span>.idTypeClassName)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.idTypeClassName = <span class="string">&quot;String&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.getImportPackages().addAll(tableInfo.getImportPackages());</span><br><span class="line">        <span class="built_in">this</span>.setName(tableInfo.getName());</span><br><span class="line">        <span class="built_in">this</span>.setComment(tableInfo.getComment());</span><br><span class="line">        <span class="built_in">this</span>.setEntityName(tableInfo.getEntityName());</span><br><span class="line">        <span class="built_in">this</span>.setMapperName(tableInfo.getMapperName());</span><br><span class="line">        <span class="built_in">this</span>.setXmlName(tableInfo.getXmlName());</span><br><span class="line">        <span class="built_in">this</span>.setServiceName(tableInfo.getServiceName());</span><br><span class="line">        <span class="built_in">this</span>.setServiceImplName(tableInfo.getServiceImplName());</span><br><span class="line">        <span class="built_in">this</span>.setControllerName(tableInfo.getControllerName());</span><br><span class="line">        <span class="built_in">this</span>.setCommonFields(tableInfo.getCommonFields());</span><br><span class="line">        <span class="built_in">this</span>.setFieldNames(tableInfo.getFieldNames());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CustomTableInfo <span class="title function_">getInstance</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        <span class="type">CustomTableInfo</span> <span class="variable">customTableInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomTableInfo</span>(tableInfo);</span><br><span class="line"></span><br><span class="line">        customTableInfo.setDtoName(String.format(CodeGeneratorEnumVal.DTO.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setParamsName(String.format(CodeGeneratorEnumVal.PARAMS.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setVoName(String.format(CodeGeneratorEnumVal.VO.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setConvertName(String.format(CodeGeneratorEnumVal.CONVERT.getClassName(), tableInfo.getEntityName()));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceBeanName</span> <span class="operator">=</span> customTableInfo.getServiceName().substring(<span class="number">1</span>);</span><br><span class="line">        serviceBeanName = serviceBeanName.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase() + serviceBeanName.substring(<span class="number">1</span>);</span><br><span class="line">        customTableInfo.setServiceBeanName(serviceBeanName);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapperBeanName</span> <span class="operator">=</span> customTableInfo.getMapperName();</span><br><span class="line">        mapperBeanName = mapperBeanName.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase() + mapperBeanName.substring(<span class="number">1</span>);</span><br><span class="line">        customTableInfo.setMapperBeanName(mapperBeanName);</span><br><span class="line">        customTableInfo.setConvertBeanName(customTableInfo.getConvertName().substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase(Locale.ROOT) +</span><br><span class="line">                customTableInfo.getConvertName().substring(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*异常类名 */</span></span><br><span class="line">        customTableInfo.setExceptionName(String.format(CodeGeneratorEnumVal.EXCEPTION.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setExceptionEnumName(String.format(CodeGeneratorEnumVal.EXCEPTION_ENUM.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setExceptionHandlerName(String.format(CodeGeneratorEnumVal.EXCEPTION_HANDLER.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        <span class="keyword">return</span> customTableInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化导入依赖</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packageInfo 所有的 package</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initImportPackage</span><span class="params">(Map&lt;String, String&gt; packageInfo)</span> &#123;</span><br><span class="line">        apiImportPackages.add(java.util.List.class.getCanonicalName());</span><br><span class="line">        apiImportPackages.add(org.springframework.http.ResponseEntity.class.getCanonicalName());</span><br><span class="line"></span><br><span class="line">        serviceImportPackages.add(java.util.List.class.getCanonicalName());</span><br><span class="line">        serviceImplImportPackages.add(java.util.List.class.getCanonicalName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;Convert&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getConvertName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;Exception&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getExceptionName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;ExceptionEnum&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getExceptionEnumName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;ExceptionHandler&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getExceptionHandlerName());</span><br><span class="line">        serviceImplImportPackages.add(com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper.class.getCanonicalName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        crudImplImportPackages.add(com.baomidou.mybatisplus.core.metadata.IPage.class.getCanonicalName());</span><br><span class="line">        crudImplImportPackages.add(com.baomidou.mybatisplus.extension.plugins.pagination.Page.class.getCanonicalName());</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Dto&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.dtoName);</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Params&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.paramsName);</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Vo&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.voName);</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Entity&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getEntityName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/15752/">https://github.com/maxzhao-it/blog/post/15752/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/15751/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/15751/" class="post-title-link" itemprop="url">MyBatisPlus代码生成器自定义FreemarkerEngine</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/MyBatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>MyBatisPlus：AutoGenerator 是 MyBatis-Plus 的代码生成器，通过 AutoGenerator 可以快速生成 Entity、Mapper、Mapper XML、Service、Controller<br>等各个模块的代码，极大的提升了开发效率。</p>
<p>很多时候上面生成的代码不能满足开发需求，在自定义模板的同时，我们也会自定义模板引擎，这里使用 <code>Freemarker</code>模板引擎。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.baomidou.com/guide/generator.html">MyBatisPlus代码生成器官方简介</a></p>
</blockquote>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="pom-xml配置"><a href="#pom-xml配置" class="headerlink" title="pom.xml配置"></a><code>pom.xml</code>配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.freemarker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义模板引擎类"><a href="#自定义模板引擎类" class="headerlink" title="自定义模板引擎类"></a>自定义模板引擎类</h2><p><code>CustomFreemarkerTemplateEngine</code></p>
<h2 id="AutoGenerator配置"><a href="#AutoGenerator配置" class="headerlink" title="AutoGenerator配置"></a><code>AutoGenerator</code>配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MpGeneratorDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AutoGenerator</span> <span class="variable">mpg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutoGenerator</span>();</span><br><span class="line">        <span class="comment">/**省略其他配置*/</span></span><br><span class="line">        <span class="type">CustomFreemarkerTemplateEngine</span> <span class="variable">templateEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomFreemarkerTemplateEngine</span>(config);</span><br><span class="line">        <span class="comment">/*配置模板引擎的属性，比如自定义的config，构造时传参*/</span></span><br><span class="line">        mpg.setTemplateEngine(templateEngine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="FreemarkerEngine"><a href="#FreemarkerEngine" class="headerlink" title="FreemarkerEngine"></a><code>FreemarkerEngine</code></h1><h2 id="继承-AbstractTemplateEngine"><a href="#继承-AbstractTemplateEngine" class="headerlink" title="继承 AbstractTemplateEngine"></a>继承 <code>AbstractTemplateEngine</code></h2><p>这里有三个属性</p>
<ol>
<li><code>configuration</code> ：<code>freemarker</code>配置，可以获取模板并操作模板</li>
<li><code>zipOutputStream</code>：导出<code>ZIP</code>文件的输出流</li>
<li><code>config</code>：自定义配置，可以控制是否输出<code>ZIP</code>文件、控制自定义模板属性等等</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFreemarkerTemplateEngine</span> <span class="keyword">extends</span> <span class="title class_">AbstractTemplateEngine</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * freemarker 配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * zip 输出流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> ZipOutputStream zipOutputStream;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CodeGeneratorConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config 自定义配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomFreemarkerTemplateEngine</span><span class="params">(CodeGeneratorConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CustomFreemarkerTemplateEngine <span class="title function_">init</span><span class="params">(ConfigBuilder configBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.init(configBuilder);</span><br><span class="line">        configuration = <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.DEFAULT_INCOMPATIBLE_IMPROVEMENTS);</span><br><span class="line">        configuration.setDefaultEncoding(ConstVal.UTF8);</span><br><span class="line">        configuration.setClassForTemplateLoading(FreemarkerTemplateEngine.class, StringPool.SLASH);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writer</span><span class="params">(Map&lt;String, Object&gt; objectMap, String templatePath, String outputFile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(templatePath);</span><br><span class="line">        <span class="comment">/**生成模板操作***************************/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模板路径&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 在配置时，一般不配置 .ftl 文件，这是 Freemarker 模板的习惯，所以这里要在路径上添加 .ftl</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 模板路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 模板真实路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">templateFilePath</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> filePath + <span class="string">&quot;.ftl&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getObjectMap</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; objectMap = <span class="built_in">super</span>.getObjectMap(tableInfo);</span><br><span class="line">        <span class="comment">/*****************************/</span></span><br><span class="line">        <span class="keyword">return</span> objectMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="writer模板生成方法"><a href="#writer模板生成方法" class="headerlink" title="writer模板生成方法"></a><code>writer</code>模板生成方法</h2><p>当前方法有三个参数：</p>
<ol>
<li>模板的参数<code>Map</code><ul>
<li>当前属性是 <code>AbstractTemplateEngine</code>中配置了一部分</li>
<li>自定义模板引擎中自定义一部分</li>
</ul>
</li>
<li>模板路径</li>
<li>输出文件路径</li>
</ol>
<p>模板生成方法主要做了3件事：</p>
<ol>
<li>根据模板路径获取模板<ul>
<li>模板路径是由配置路径和<code>templateFilePath</code>方法创建的</li>
<li><code>templateFilePath</code>方法是参入配置路径，返回实际模板路径</li>
</ul>
</li>
<li>生成模板</li>
<li>写入<code>ZIP</code>文件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFreemarkerTemplateEngine</span> <span class="keyword">extends</span> <span class="title class_">AbstractTemplateEngine</span> &#123;</span><br><span class="line">    <span class="comment">/************************************/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writer</span><span class="params">(Map&lt;String, Object&gt; objectMap, String templatePath, String outputFile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(templatePath);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile)) &#123;</span><br><span class="line">            template.process(objectMap, <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(fileOutputStream, ConstVal.UTF8));</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;模板:&quot;</span> + templatePath + <span class="string">&quot;;  文件:&quot;</span> + outputFile);</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            zipOutputStream.putNextEntry(<span class="keyword">new</span> <span class="title class_">ZipEntry</span>(outputFile.replace(config.getOutPutDir(), <span class="string">&quot;&quot;</span>)));</span><br><span class="line">            <span class="type">byte</span>[] buff = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(outputFile);</span><br><span class="line">                <span class="comment">/*读取文件*/</span></span><br><span class="line">                bufferedInputStream = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(inputStream);</span><br><span class="line">                <span class="comment">/*判断：当前已经传递的数据大小+当前已有的长度，小于总长度时，*/</span></span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedInputStream.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    zipOutputStream.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误：模板 :&#123;&#125;;  文件:&#123;&#125;&quot;</span>, templatePath, outputFile);</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IOUtils.closeQuietly(inputStream);</span><br><span class="line">                IOUtils.closeQuietly(bufferedInputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/************************************/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="getObjectMap获取模板参数方法"><a href="#getObjectMap获取模板参数方法" class="headerlink" title="getObjectMap获取模板参数方法"></a><code>getObjectMap</code>获取模板参数方法</h2><ol>
<li>当前方法只有一个参数<code>TableInfo</code>，顾名思义，就是单表的信息。</li>
<li><code>TableInfo</code>主要包括表结构、主要的<code>Class</code>名 <code> Entity、Mapper、Mapper XML、Service、Controller</code>；</li>
<li>如果在  <code>AutoGenerator</code> 中配置了策略，这里就会得到执行策略后的名字。</li>
</ol>
<p>我在这里配置了一个自己的<code>CustomTableInfo</code>(附录)，除了自带的信息外，好包含了 <code>dtoName、voName、convertName</code>等等。</p>
<p>下面是一段配置的作用是，传入模板参数 <code>activeCrud</code>，当前参数可以在模板中判断是否生成 <code>crud</code>代码（需要模板中有相关代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFreemarkerTemplateEngine</span> <span class="keyword">extends</span> <span class="title class_">AbstractTemplateEngine</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getObjectMap</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; objectMap = <span class="built_in">super</span>.getObjectMap(tableInfo);</span><br><span class="line">        <span class="comment">/*使用增删改查*/</span></span><br><span class="line">        objectMap.put(<span class="string">&quot;activeCrud&quot;</span>, config.getActiveCrud());</span><br><span class="line">        <span class="keyword">return</span> objectMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我在 <code>freemarker</code>自定义模板中，就可以使用</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="CodeGeneratorFactory类"><a href="#CodeGeneratorFactory类" class="headerlink" title="CodeGeneratorFactory类"></a><code>CodeGeneratorFactory</code>类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gt.code.generator.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.AutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.InjectionConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.*;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.converts.OracleTypeConvert;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.IColumnType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorConfig;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorDbConfig;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorEnumVal;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorVal;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.util.template.CustomFreemarkerTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成代码工厂&lt;br&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> maxzhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-08-27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeGeneratorFactory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动填充</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;TableFill&gt; TABLE_FILL_LIST = Arrays.asList(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;createTime&quot;</span>, FieldFill.INSERT),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;updateTime&quot;</span>, FieldFill.UPDATE),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TableFill</span>(<span class="string">&quot;delStatus&quot;</span>, FieldFill.INSERT_UPDATE));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">CodeGeneratorFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] generate(CodeGeneratorConfig config) &#123;</span><br><span class="line">        <span class="type">AutoGenerator</span> <span class="variable">mpg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutoGenerator</span>();</span><br><span class="line">        <span class="type">CodeGeneratorDbConfig</span> <span class="variable">dbConfig</span> <span class="operator">=</span> config.getDbConfig();</span><br><span class="line">        <span class="comment">/*输出路径*/</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">outPutDir</span> <span class="operator">=</span> config.getFullOutPutDir();</span><br><span class="line">        <span class="comment">//region 注入配置</span></span><br><span class="line">        mpg.setCfg(configInjection(config));</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 数据源配置</span></span><br><span class="line">        <span class="type">DataSourceConfig</span> <span class="variable">dataSource</span> <span class="operator">=</span> dbConfig.generatorDataSourceConfig();</span><br><span class="line">        <span class="keyword">if</span> (dataSource.getDbType() == DbType.ORACLE) &#123;</span><br><span class="line">            dataSource.setTypeConvert(<span class="keyword">new</span> <span class="title class_">OracleTypeConvert</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> IColumnType <span class="title function_">processTypeConvert</span><span class="params">(GlobalConfig globalConfig, String fieldType)</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fieldType.toLowerCase(Locale.ROOT).matches(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.processTypeConvert(globalConfig, fieldType);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        mpg.setDataSource(dataSource);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 表策略配置</span></span><br><span class="line">        <span class="type">StrategyConfig</span> <span class="variable">strategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StrategyConfig</span>();</span><br><span class="line">        <span class="comment">/*驼峰*/</span></span><br><span class="line">        strategy.setNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">        <span class="comment">/*驼峰*/</span></span><br><span class="line">        strategy.setColumnNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">        <span class="comment">/*使用 lombok*/</span></span><br><span class="line">        strategy.setEntityLombokModel(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">/*默认使用 restfull风格*/</span></span><br><span class="line">        strategy.setRestControllerStyle(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">/*标*/</span></span><br><span class="line">        strategy.setInclude(config.getTablesNames());</span><br><span class="line">        <span class="comment">/*驼峰转连字符串*/</span></span><br><span class="line">        strategy.setControllerMappingHyphenStyle(<span class="literal">true</span>);</span><br><span class="line">        strategy.setTablePrefix(config.getTablePrefix());</span><br><span class="line">        <span class="comment">/*字段添加 @TableField*/</span></span><br><span class="line">        strategy.setEntityTableFieldAnnotationEnable(<span class="literal">true</span>);</span><br><span class="line">        strategy.setTableFillList(TABLE_FILL_LIST);</span><br><span class="line">        mpg.setStrategy(strategy);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 包配置</span></span><br><span class="line">        <span class="type">PackageConfig</span> <span class="variable">pc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageConfig</span>();</span><br><span class="line">        pc.setModuleName(config.getModuleName());</span><br><span class="line">        pc.setParent(config.getParentPackage());</span><br><span class="line">        <span class="comment">/*设置 controller 文件 包名*/</span></span><br><span class="line">        pc.setController(CodeGeneratorEnumVal.CONTROLLER.getPackageName());</span><br><span class="line">        <span class="comment">/*设置 xml 文件 包名*/</span></span><br><span class="line">        pc.setXml(<span class="string">&quot;mapper&quot;</span>);</span><br><span class="line">        <span class="comment">/*设置 entity 文件 包名*/</span></span><br><span class="line">        pc.setEntity(<span class="string">&quot;model.entity&quot;</span>);</span><br><span class="line">        pc.setXml(<span class="string">&quot;mapper&quot;</span>);</span><br><span class="line">        mpg.setPackageInfo(pc);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 模板配置</span></span><br><span class="line">        <span class="type">TemplateConfig</span> <span class="variable">templateConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplateConfig</span>()</span><br><span class="line">                .setEntity(CodeGeneratorEnumVal.ENTITY.getTemplate())</span><br><span class="line">                .setController(CodeGeneratorEnumVal.CONTROLLER.getTemplate())</span><br><span class="line">                .setService(CodeGeneratorEnumVal.SERVICE.getTemplate())</span><br><span class="line">                .setServiceImpl(CodeGeneratorEnumVal.SERVICE_IMPL.getTemplate())</span><br><span class="line">                .setMapper(CodeGeneratorEnumVal.MAPPER.getTemplate())</span><br><span class="line">                .setXml(CodeGeneratorEnumVal.TEMPLATE_XML.getTemplate());</span><br><span class="line">        mpg.setTemplate(templateConfig);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 全局配置</span></span><br><span class="line">        <span class="comment">/*默认使用雪花算法*/</span></span><br><span class="line">        <span class="type">GlobalConfig</span> <span class="variable">gc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GlobalConfig</span>();</span><br><span class="line">        gc.setOutputDir(outPutDir);</span><br><span class="line">        gc.setAuthor(config.getAuthor());</span><br><span class="line">        gc.setOpen(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">/*默认不覆盖，如果文件存在，将不会再生成，配置true就是覆盖*/</span></span><br><span class="line">        gc.setFileOverride(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">/*配置 swagger2*/</span></span><br><span class="line">        gc.setSwagger2(config.getSwagger2());</span><br><span class="line">        <span class="comment">/*开启 ActiveRecord 模式*/</span></span><br><span class="line">        gc.setActiveRecord(config.getActiveRecord());</span><br><span class="line">        mpg.setGlobalConfig(gc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        <span class="comment">//region 模板引擎</span></span><br><span class="line">        <span class="comment">// 选择 freemarker 引擎需要指定如下加，注意 pom 依赖必须有！</span></span><br><span class="line">        <span class="type">CustomFreemarkerTemplateEngine</span> <span class="variable">templateEngine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomFreemarkerTemplateEngine</span>(config);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">ZipOutputStream</span> <span class="variable">zip</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="comment">/*下载zip文件 字节输出流*/</span></span><br><span class="line">            outputStream = <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            zip = <span class="keyword">new</span> <span class="title class_">ZipOutputStream</span>(outputStream);</span><br><span class="line">            templateEngine.setZipOutputStream(zip);</span><br><span class="line">            <span class="comment">/*下载zip ，会覆盖文件*/</span></span><br><span class="line">            gc.setFileOverride(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mpg.setTemplateEngine(templateEngine);</span><br><span class="line">        <span class="comment">//endregion</span></span><br><span class="line">        mpg.execute();</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="comment">/*获取结果*/</span></span><br><span class="line">            <span class="comment">//等同于自己写判断然后关闭</span></span><br><span class="line">            IOUtils.closeQuietly(zip);</span><br><span class="line">            <span class="keyword">return</span> outputStream != <span class="literal">null</span> ? outputStream.toByteArray() : <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加自动填充</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableFill 新的自动填充</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addTableFill</span><span class="params">(TableFill tableFill)</span> &#123;</span><br><span class="line">        TABLE_FILL_LIST.add(tableFill);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置自定义参数/属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config 配置信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InjectionConfig <span class="title function_">configInjection</span><span class="params">(CodeGeneratorConfig config)</span> &#123;</span><br><span class="line">        <span class="comment">// 自定义配置</span></span><br><span class="line">        <span class="type">InjectionConfig</span> <span class="variable">cfg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectionConfig</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initMap</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">controllerPackage</span> <span class="operator">=</span> <span class="built_in">this</span>.getConfig().getPackageInfo().get(<span class="string">&quot;Controller&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Dto&quot;</span>, controllerPackage + <span class="string">&quot;.dto&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Params&quot;</span>, controllerPackage + <span class="string">&quot;.Params&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Vo&quot;</span>, controllerPackage + <span class="string">&quot;.vo&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPackageInfo().put(<span class="string">&quot;Convert&quot;</span>, controllerPackage.substring(<span class="number">0</span>, controllerPackage.lastIndexOf(CodeGeneratorEnumVal.CONTROLLER.getPackageName())) + CodeGeneratorEnumVal.CONVERT.getPackageName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">xmlPath</span> <span class="operator">=</span> <span class="built_in">this</span>.getConfig().getPathInfo().get(<span class="string">&quot;xml_path&quot;</span>);</span><br><span class="line">                <span class="comment">/*修改 xml 生成路径*/</span></span><br><span class="line">                <span class="built_in">this</span>.getConfig().getPathInfo().put(<span class="string">&quot;xml_path&quot;</span>, xmlPath.replace(CodeGeneratorVal.JAVA_SOURCE_PATH, CodeGeneratorVal.XML_SOURCE_PATH));</span><br><span class="line">                Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">                <span class="comment">/*自定义cfg引用*/</span></span><br><span class="line">                <span class="built_in">this</span>.setMap(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        List&lt;FileOutConfig&gt; focList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">/*dto 模板*/</span></span><br><span class="line">        focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.DTO));</span><br><span class="line">        <span class="comment">/*params 模板*/</span></span><br><span class="line">        focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.PARAMS));</span><br><span class="line">        <span class="comment">/*vo 模板*/</span></span><br><span class="line">        focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.VO));</span><br><span class="line">        <span class="comment">/*判断是否使用 mapstruct convert*/</span></span><br><span class="line">        <span class="keyword">if</span> ((config.getUseConvert() != <span class="literal">null</span> &amp;&amp; config.getUseConvert())</span><br><span class="line">                <span class="comment">/*增删查改时使用*/</span></span><br><span class="line">                || (config.getActiveCrud() != <span class="literal">null</span> &amp;&amp; config.getActiveCrud())) &#123;</span><br><span class="line">            <span class="comment">/*convert 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.CONVERT));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*使用增删查改*/</span></span><br><span class="line">        <span class="keyword">if</span> (config.getActiveCrud() != <span class="literal">null</span> &amp;&amp; config.getActiveCrud()) &#123;</span><br><span class="line">            <span class="comment">/*exception 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.EXCEPTION));</span><br><span class="line">            <span class="comment">/*exception enum 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.EXCEPTION_ENUM));</span><br><span class="line">            <span class="comment">/*exception handler 模板*/</span></span><br><span class="line">            focList.add(convertFileOutConfig(config, CodeGeneratorEnumVal.EXCEPTION_HANDLER));</span><br><span class="line">        &#125;</span><br><span class="line">        cfg.setFileOutConfigList(focList);</span><br><span class="line">        <span class="keyword">return</span> cfg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载文件输出配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config  配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> enumVal 模板</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mybatis plus 文件输出配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> FileOutConfig <span class="title function_">convertFileOutConfig</span><span class="params">(CodeGeneratorConfig config, CodeGeneratorEnumVal enumVal)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileOutConfig</span>(enumVal.getTemplate()) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">outputFile</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">                <span class="comment">/*指定模板生，自定义生成文件到哪个地方*/</span></span><br><span class="line">                <span class="keyword">return</span> config.getModuleOutPutDir() + File.separator +</span><br><span class="line">                        enumVal.getPackageName().replace(<span class="string">&quot;.&quot;</span>, File.separator) +</span><br><span class="line">                        File.separator +</span><br><span class="line">                        String.format(enumVal.getClassName(), tableInfo.getEntityName()) + StringPool.DOT_JAVA;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomFreemarkerTemplateEngine类"><a href="#CustomFreemarkerTemplateEngine类" class="headerlink" title="CustomFreemarkerTemplateEngine类"></a><code>CustomFreemarkerTemplateEngine</code>类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gt.code.generator.util.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.ConstVal;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.builder.ConfigBuilder;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.engine.AbstractTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.engine.FreemarkerTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorConfig;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorEnumVal;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.util.CustomTableInfo;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Configuration;</span><br><span class="line"><span class="keyword">import</span> freemarker.template.Template;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义 Freemarker 模板引擎</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> maxzhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-08-28 08:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFreemarkerTemplateEngine</span> <span class="keyword">extends</span> <span class="title class_">AbstractTemplateEngine</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * freemarker 配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Configuration configuration;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * zip 输出流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> ZipOutputStream zipOutputStream;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CodeGeneratorConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config 自定义配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomFreemarkerTemplateEngine</span><span class="params">(CodeGeneratorConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CustomFreemarkerTemplateEngine <span class="title function_">init</span><span class="params">(ConfigBuilder configBuilder)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.init(configBuilder);</span><br><span class="line">        configuration = <span class="keyword">new</span> <span class="title class_">Configuration</span>(Configuration.DEFAULT_INCOMPATIBLE_IMPROVEMENTS);</span><br><span class="line">        configuration.setDefaultEncoding(ConstVal.UTF8);</span><br><span class="line">        configuration.setClassForTemplateLoading(FreemarkerTemplateEngine.class, StringPool.SLASH);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writer</span><span class="params">(Map&lt;String, Object&gt; objectMap, String templatePath, String outputFile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Template</span> <span class="variable">template</span> <span class="operator">=</span> configuration.getTemplate(templatePath);</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile)) &#123;</span><br><span class="line">            template.process(objectMap, <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(fileOutputStream, ConstVal.UTF8));</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;模板:&quot;</span> + templatePath + <span class="string">&quot;;  文件:&quot;</span> + outputFile);</span><br><span class="line">        <span class="keyword">if</span> (config.getUseZip()) &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            zipOutputStream.putNextEntry(<span class="keyword">new</span> <span class="title class_">ZipEntry</span>(outputFile.replace(config.getOutPutDir(), <span class="string">&quot;&quot;</span>)));</span><br><span class="line">            <span class="type">byte</span>[] buff = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="type">int</span> len;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(outputFile);</span><br><span class="line">                <span class="comment">/*读取文件*/</span></span><br><span class="line">                bufferedInputStream = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(inputStream);</span><br><span class="line">                <span class="comment">/*判断：当前已经传递的数据大小+当前已有的长度，小于总长度时，*/</span></span><br><span class="line">                <span class="keyword">while</span> ((len = bufferedInputStream.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    zipOutputStream.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误：模板 :&#123;&#125;;  文件:&#123;&#125;&quot;</span>, templatePath, outputFile);</span><br><span class="line">                log.error(<span class="string">&quot;代码生成器：输出ZIP错误&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IOUtils.closeQuietly(inputStream);</span><br><span class="line">                IOUtils.closeQuietly(bufferedInputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模板路径&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 在配置时，一般不配置 .ftl 文件，这是 Freemarker 模板的习惯，所以这里要在路径上添加 .ftl</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 模板路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 模板真实路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">templateFilePath</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> filePath + <span class="string">&quot;.ftl&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getObjectMap</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; objectMap = <span class="built_in">super</span>.getObjectMap(tableInfo);</span><br><span class="line">        <span class="comment">/*获取类 Package*/</span></span><br><span class="line">        Map&lt;String, String&gt; packageInfo = <span class="built_in">super</span>.getConfigBuilder().getPackageInfo();</span><br><span class="line">        <span class="type">String</span> <span class="variable">controllerPackage</span> <span class="operator">=</span> packageInfo.get(<span class="string">&quot;Controller&quot;</span>);</span><br><span class="line">        <span class="comment">/*基础 package*/</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">basePackage</span> <span class="operator">=</span> controllerPackage.substring(<span class="number">0</span>, controllerPackage.lastIndexOf(CodeGeneratorEnumVal.CONTROLLER.getPackageName()));</span><br><span class="line">        packageInfo.put(<span class="string">&quot;basePackage&quot;</span>, basePackage);</span><br><span class="line">        <span class="comment">/*自定义表数据*/</span></span><br><span class="line">        <span class="type">CustomTableInfo</span> <span class="variable">customTableInfo</span> <span class="operator">=</span> CustomTableInfo.getInstance(tableInfo);</span><br><span class="line">        <span class="comment">/*使用增删改查*/</span></span><br><span class="line">        objectMap.put(<span class="string">&quot;activeCrud&quot;</span>, config.getActiveCrud());</span><br><span class="line">        <span class="keyword">if</span> (config.getActiveCrud() != <span class="literal">null</span> &amp;&amp; config.getActiveCrud()) &#123;</span><br><span class="line">            <span class="comment">/*使用增删改查时，添加代码引入*/</span></span><br><span class="line">            packageInfo.put(<span class="string">&quot;ExceptionHandler&quot;</span>, basePackage + <span class="string">&quot;exception.handler&quot;</span>);</span><br><span class="line">            packageInfo.put(<span class="string">&quot;Exception&quot;</span>, basePackage + <span class="string">&quot;exception&quot;</span>);</span><br><span class="line">            packageInfo.put(<span class="string">&quot;ExceptionEnum&quot;</span>, basePackage + <span class="string">&quot;exception&quot;</span>);</span><br><span class="line">            customTableInfo.initImportPackage(packageInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*每个类的 package*/</span></span><br><span class="line">        objectMap.put(<span class="string">&quot;packageInfo&quot;</span>, packageInfo);</span><br><span class="line">        <span class="comment">/*自定义表数据*/</span></span><br><span class="line">        objectMap.put(<span class="string">&quot;table&quot;</span>, customTableInfo);</span><br><span class="line">        <span class="keyword">return</span> objectMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CustomTableInfo类"><a href="#CustomTableInfo类" class="headerlink" title="CustomTableInfo类"></a><code>CustomTableInfo</code>类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.gt.code.generator.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.StringPool;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.gt.code.generator.config.CodeGeneratorEnumVal;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义表配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> maxzhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-08-29 10:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomTableInfo</span> <span class="keyword">extends</span> <span class="title class_">TableInfo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键类型，默认为 String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String idTypeClassName;</span><br><span class="line">    <span class="keyword">private</span> String dtoName;</span><br><span class="line">    <span class="keyword">private</span> String paramsName;</span><br><span class="line">    <span class="keyword">private</span> String voName;</span><br><span class="line">    <span class="keyword">private</span> String convertName;</span><br><span class="line">    <span class="keyword">private</span> String serviceBeanName;</span><br><span class="line">    <span class="keyword">private</span> String mapperBeanName;</span><br><span class="line">    <span class="keyword">private</span> String convertBeanName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常类名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String exceptionName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常枚举</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String exceptionEnumName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常处理类名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String exceptionHandlerName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 CONTROLLER 引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; apiImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 SERVICE 接口引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; serviceImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 SERVICE 实现引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; serviceImplImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 crud 时的 通用 实现引入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; crudImplImportPackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomTableInfo</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setConvert(tableInfo.isConvert());</span><br><span class="line">        <span class="built_in">this</span>.setEntityName(tableInfo.getEntityName());</span><br><span class="line">        List&lt;TableField&gt; fields = tableInfo.getFields();</span><br><span class="line">        <span class="built_in">this</span>.setFields(fields);</span><br><span class="line">        <span class="keyword">for</span> (TableField field : fields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (field.isKeyFlag()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.idTypeClassName = field.getColumnType().getType();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(<span class="built_in">this</span>.idTypeClassName)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.idTypeClassName = <span class="string">&quot;String&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.getImportPackages().addAll(tableInfo.getImportPackages());</span><br><span class="line">        <span class="built_in">this</span>.setName(tableInfo.getName());</span><br><span class="line">        <span class="built_in">this</span>.setComment(tableInfo.getComment());</span><br><span class="line">        <span class="built_in">this</span>.setEntityName(tableInfo.getEntityName());</span><br><span class="line">        <span class="built_in">this</span>.setMapperName(tableInfo.getMapperName());</span><br><span class="line">        <span class="built_in">this</span>.setXmlName(tableInfo.getXmlName());</span><br><span class="line">        <span class="built_in">this</span>.setServiceName(tableInfo.getServiceName());</span><br><span class="line">        <span class="built_in">this</span>.setServiceImplName(tableInfo.getServiceImplName());</span><br><span class="line">        <span class="built_in">this</span>.setControllerName(tableInfo.getControllerName());</span><br><span class="line">        <span class="built_in">this</span>.setCommonFields(tableInfo.getCommonFields());</span><br><span class="line">        <span class="built_in">this</span>.setFieldNames(tableInfo.getFieldNames());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CustomTableInfo <span class="title function_">getInstance</span><span class="params">(TableInfo tableInfo)</span> &#123;</span><br><span class="line">        <span class="type">CustomTableInfo</span> <span class="variable">customTableInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomTableInfo</span>(tableInfo);</span><br><span class="line"></span><br><span class="line">        customTableInfo.setDtoName(String.format(CodeGeneratorEnumVal.DTO.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setParamsName(String.format(CodeGeneratorEnumVal.PARAMS.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setVoName(String.format(CodeGeneratorEnumVal.VO.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setConvertName(String.format(CodeGeneratorEnumVal.CONVERT.getClassName(), tableInfo.getEntityName()));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceBeanName</span> <span class="operator">=</span> customTableInfo.getServiceName().substring(<span class="number">1</span>);</span><br><span class="line">        serviceBeanName = serviceBeanName.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase() + serviceBeanName.substring(<span class="number">1</span>);</span><br><span class="line">        customTableInfo.setServiceBeanName(serviceBeanName);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapperBeanName</span> <span class="operator">=</span> customTableInfo.getMapperName();</span><br><span class="line">        mapperBeanName = mapperBeanName.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase() + mapperBeanName.substring(<span class="number">1</span>);</span><br><span class="line">        customTableInfo.setMapperBeanName(mapperBeanName);</span><br><span class="line">        customTableInfo.setConvertBeanName(customTableInfo.getConvertName().substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase(Locale.ROOT) +</span><br><span class="line">                customTableInfo.getConvertName().substring(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*异常类名 */</span></span><br><span class="line">        customTableInfo.setExceptionName(String.format(CodeGeneratorEnumVal.EXCEPTION.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setExceptionEnumName(String.format(CodeGeneratorEnumVal.EXCEPTION_ENUM.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        customTableInfo.setExceptionHandlerName(String.format(CodeGeneratorEnumVal.EXCEPTION_HANDLER.getClassName(), tableInfo.getEntityName()));</span><br><span class="line">        <span class="keyword">return</span> customTableInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化导入依赖</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packageInfo 所有的 package</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initImportPackage</span><span class="params">(Map&lt;String, String&gt; packageInfo)</span> &#123;</span><br><span class="line">        apiImportPackages.add(java.util.List.class.getCanonicalName());</span><br><span class="line">        apiImportPackages.add(org.springframework.http.ResponseEntity.class.getCanonicalName());</span><br><span class="line"></span><br><span class="line">        serviceImportPackages.add(java.util.List.class.getCanonicalName());</span><br><span class="line">        serviceImplImportPackages.add(java.util.List.class.getCanonicalName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;Convert&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getConvertName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;Exception&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getExceptionName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;ExceptionEnum&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getExceptionEnumName());</span><br><span class="line">        serviceImplImportPackages.add(packageInfo.get(<span class="string">&quot;ExceptionHandler&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getExceptionHandlerName());</span><br><span class="line">        serviceImplImportPackages.add(com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper.class.getCanonicalName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        crudImplImportPackages.add(com.baomidou.mybatisplus.core.metadata.IPage.class.getCanonicalName());</span><br><span class="line">        crudImplImportPackages.add(com.baomidou.mybatisplus.extension.plugins.pagination.Page.class.getCanonicalName());</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Dto&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.dtoName);</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Params&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.paramsName);</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Vo&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.voName);</span><br><span class="line">        crudImplImportPackages.add(packageInfo.get(<span class="string">&quot;Entity&quot;</span>) + StringPool.DOT + <span class="built_in">this</span>.getEntityName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/15751/">https://github.com/maxzhao-it/blog/post/15751/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/1a9b93f6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/1a9b93f6/" class="post-title-link" itemprop="url">Java操作图片翻转</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-28 17:37:16" itemprop="dateModified" datetime="2022-07-28T17:37:16+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Java</code> 操作图片，实现图片的翻转</p>
<h1 id="裁剪图片"><a href="#裁剪图片" class="headerlink" title="裁剪图片"></a>裁剪图片</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;D:\\Pictures\\temp\\1.jpg&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[in.available()];</span><br><span class="line">            <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> in.read(bytes);</span><br><span class="line">            in.close();</span><br><span class="line">            bytes = getFaceHead(getFaceHead);</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;D:\\Pictures\\temp\\&quot;</span> + System.currentTimeMillis() + <span class="string">&quot;.jpg&quot;</span>);</span><br><span class="line">            outputStream.write(bytes);</span><br><span class="line">            outputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;翻转图片失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 水平翻转图片</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pictureBytes 照片数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 人脸图片数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] getFaceHead(<span class="type">byte</span>[] pictureBytes) &#123;</span><br><span class="line">        <span class="comment">/*翻转图片*/</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/*获取图片 buffer*/</span></span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">pictureImage</span> <span class="operator">=</span> ImageIO.read(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(pictureBytes));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> pictureImage.getWidth();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> pictureImage.getHeight();</span><br><span class="line">            <span class="comment">/*读取所有的像素*/</span></span><br><span class="line">            <span class="type">int</span>[] rgbs = pictureImage.getRGB(<span class="number">0</span>, <span class="number">0</span>, width, height, <span class="literal">null</span>, <span class="number">0</span>, width);</span><br><span class="line">            <span class="comment">/*水平切换像素*/</span></span><br><span class="line">            <span class="type">int</span> temp;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">0</span>; row &lt; height; row++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> <span class="number">0</span>; col &lt; width / <span class="number">2</span>; col++) &#123;</span><br><span class="line">                    temp = rgbs[row * width + col];</span><br><span class="line">                    rgbs[row * width + col] = rgbs[row * width + (width - <span class="number">1</span> - col)];</span><br><span class="line">                    rgbs[row * width + (width - <span class="number">1</span> - col)] = temp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*写入像素*/</span></span><br><span class="line">            pictureImage.setRGB(<span class="number">0</span>, <span class="number">0</span>, width, height, rgbs, <span class="number">0</span>, width);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            ImageIO.write(pictureImage, <span class="string">&quot;jpg&quot;</span>, out);</span><br><span class="line">            <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;翻转图片失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h1 id="1-图片操作类"><a href="#1-图片操作类" class="headerlink" title="1 图片操作类"></a>1 图片操作类</h1><ol>
<li><code>Image</code></li>
<li><code>BufferedImage</code><ol>
<li><code>getSubimage</code>  图片裁剪</li>
<li><code>getRGB</code> 获取像素</li>
</ol>
</li>
<li><code>ImageIO</code><ol>
<li><code>read</code> 读取图片</li>
<li><code>wirte</code> 写出图片</li>
</ol>
</li>
</ol>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/1a9b93f6/">https://github.com/maxzhao-it/blog/post/1a9b93f6/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/8bda86f4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/8bda86f4/" class="post-title-link" itemprop="url">Java操作图片裁剪</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-28 17:37:15" itemprop="dateModified" datetime="2022-07-28T17:37:15+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Java</code> 操作图片，实现图片的裁剪</p>
<h1 id="裁剪图片"><a href="#裁剪图片" class="headerlink" title="裁剪图片"></a>裁剪图片</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取人脸图片数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pictureBytes 照片数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentType  请求内容类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> faceName     人脸模型名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 人脸图片数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] getFaceHead(String faceName, <span class="type">byte</span>[] pictureBytes, MediaType contentType) &#123;</span><br><span class="line">        <span class="comment">/*获取人脸位置与大小*/</span></span><br><span class="line">        <span class="type">double</span>[] faceDetectResult = <span class="built_in">this</span>.getFaceDetectResult(faceName, pictureBytes, contentType);</span><br><span class="line">        <span class="keyword">if</span> (faceDetectResult[<span class="number">0</span>] == <span class="number">0</span></span><br><span class="line">                &amp;&amp; faceDetectResult[<span class="number">1</span>] == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (faceDetectResult[<span class="number">2</span>] == <span class="number">0</span></span><br><span class="line">                || faceDetectResult[<span class="number">3</span>] == <span class="number">0</span>)) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;图片无法裁剪，使用原图片&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> pictureBytes;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*裁剪图片*/</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/*获取图片 buffer*/</span></span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">pictureImage</span> <span class="operator">=</span> ImageIO.read(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(pictureBytes));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> pictureImage.getWidth();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> pictureImage.getHeight();</span><br><span class="line">            <span class="comment">/*图片裁剪*/</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> (<span class="type">int</span>) (faceDetectResult[<span class="number">0</span>] * width);</span><br><span class="line">            <span class="comment">/*坐标 - 10*/</span></span><br><span class="line">            x = Math.max((x - <span class="number">10</span>), <span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> (<span class="type">int</span>) (faceDetectResult[<span class="number">1</span>] * height);</span><br><span class="line">            <span class="comment">/*坐标 - 10*/</span></span><br><span class="line">            y = Math.max((y - <span class="number">10</span>), <span class="number">0</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> (<span class="type">int</span>) (faceDetectResult[<span class="number">2</span>] * width);</span><br><span class="line">            <span class="comment">/*宽度 + 10*/</span></span><br><span class="line">            w = Math.min((w + <span class="number">10</span>), width - x);</span><br><span class="line">            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> (<span class="type">int</span>) (faceDetectResult[<span class="number">3</span>] * height);</span><br><span class="line">            <span class="comment">/*高度 + 10*/</span></span><br><span class="line">            h = Math.min((h + <span class="number">10</span>), height - y);</span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">headImage</span> <span class="operator">=</span> pictureImage.getSubimage(x, y, w, h);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            ImageIO.write(headImage, <span class="string">&quot;jpg&quot;</span>, out);</span><br><span class="line">            <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;裁剪图片失败使用原照片 &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;裁剪图片失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h1 id="1-图片操作类"><a href="#1-图片操作类" class="headerlink" title="1 图片操作类"></a>1 图片操作类</h1><ol>
<li><code>Image</code></li>
<li><code>BufferedImage</code><ol>
<li><code>getSubimage</code>  图片裁剪</li>
</ol>
</li>
<li><code>ImageIO</code><ol>
<li><code>read</code> 读取图片</li>
<li><code>wirte</code> 写出图片</li>
</ol>
</li>
</ol>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/8bda86f4/">https://github.com/maxzhao-it/blog/post/8bda86f4/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/5949bf48/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/5949bf48/" class="post-title-link" itemprop="url">JS实现图片裁剪功能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/JS/" itemprop="url" rel="index"><span itemprop="name">JS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>JS</code> 实现图片的裁剪</p>
<h1 id="JS-代码"><a href="#JS-代码" class="headerlink" title="JS 代码"></a><code>JS</code> 代码</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;images&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100px;height:200px;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;3.jpg&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> loadTimer;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> imgObject = <span class="keyword">new</span> <span class="title class_">Image</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    imgObject.<span class="property">src</span> = <span class="string">&#x27;3.jpg&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    imgObject.<span class="property">onLoad</span> = <span class="title function_">onImgLoaded</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgObject.naturalHeight==============&gt;&#x27;</span>, imgObject.<span class="property">naturalHeight</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;imgObject.naturalWidth==============&gt;&#x27;</span>, imgObject.<span class="property">naturalWidth</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">onImgLoaded</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">if</span> (loadTimer != <span class="literal">null</span>) <span class="built_in">clearTimeout</span>(loadTimer);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">if</span> (!imgObject.<span class="property">complete</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            loadTimer = <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="title function_">onImgLoaded</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;, <span class="number">3</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="title function_">onPreloadComplete</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">onPreloadComplete</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">//call the methods that will create a 64-bit version of thumbnail here.</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> newImg = <span class="title function_">getImagePortion</span>(imgObject,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="number">0.17443209886550903</span>* imgObject.<span class="property">naturalWidth</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="number">0.1213589534163475</span> * imgObject.<span class="property">naturalHeight</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="number">0.44079777598381042</span> * imgObject.<span class="property">naturalWidth</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="number">0.44744855165481567</span> * imgObject.<span class="property">naturalHeight</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="number">2</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;newImg&quot;</span>, newImg);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">//place image in appropriate div</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;images&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;&lt;img alt=\&quot;\&quot; src=\&quot;&quot;</span> + newImg + <span class="string">&quot;\&quot; /&gt;&quot;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">getImagePortion</span>(<span class="params">imgObj, newWidth, newHeight, startX, startY, ratio</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;newWidth&#x27;</span>, newWidth);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;newHeight&#x27;</span>, newHeight);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;startX&#x27;</span>, startX);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;startY&#x27;</span>, startY);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// newWidth = Math.floor(newWidth);</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// newHeight = Math.floor(newHeight);</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// startX = Math.floor(startX);</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// startY = Math.floor(startY);</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">/* the parameters: - the image element - the new width - the new height - the x point we start taking pixels - the y point we start taking pixels - the ratio */</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">//set up canvas for thumbnail</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> tnCanvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> tnCanvasContext = tnCanvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        tnCanvas.<span class="property">width</span> = newWidth;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        tnCanvas.<span class="property">height</span> = newHeight;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">/* use the sourceCanvas to duplicate the entire image. This step was crucial for iOS4 and under devices. Follow the link at the end of this post to see what happens when you don’t do this */</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> bufferCanvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;canvas&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> bufferContext = bufferCanvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        bufferCanvas.<span class="property">width</span> = imgObj.<span class="property">width</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        bufferCanvas.<span class="property">height</span> = imgObj.<span class="property">height</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        bufferContext.<span class="title function_">drawImage</span>(imgObj, <span class="number">0</span>, <span class="number">0</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">/* now we use the drawImage method to take the pixels from our bufferCanvas and draw them into our thumbnail canvas */</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        tnCanvasContext.<span class="title function_">drawImage</span>(bufferCanvas, startX, startY, newWidth * ratio, newHeight * ratio, <span class="number">0</span>, <span class="number">0</span>, newWidth, newHeight);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">return</span> tnCanvas.<span class="title function_">toDataURL</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;, <span class="number">1000</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>


<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/5949bf48/">https://github.com/maxzhao-it/blog/post/5949bf48/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/8e2fc2ac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/8e2fc2ac/" class="post-title-link" itemprop="url">PostgreSQL基于Citus的分布式搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/DB/" itemprop="url" rel="index"><span itemprop="name">DB</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/DB/PostgreSql/" itemprop="url" rel="index"><span itemprop="name">PostgreSql</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/DB/PostgreSql/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p><a href="../439bd436"><code>yum</code>快速安装</a></p>
<p><a target="_blank" rel="noopener" href="https://www.citusdata.com/getting-started/">官方介绍</a></p>
</blockquote>
<h2 id="Citus简介"><a href="#Citus简介" class="headerlink" title="Citus简介"></a><strong>Citus</strong>简介</h2><p>Citus以插件的方式扩展到postgresql中，独立于postgresql内核，所以能很快的跟上pg主版本的更新，部署也比较简单，是现在非常流行的分布式方案。Citus在苏宁有大规模应用，微软也提供citus的商业支持。下面是citus的架构：</p>
<p><img src="/blog/uploads/images/2018042723003371.png" alt="2018042723003371"></p>
<p><code>Citus</code><br>节点主要分为协调节点和工作节点，协调节点不存储真实数据，只存储数据分布的元信息，实际的数据被分成若干分片，打散到不同worker节点中，应用连接协调节点，协调节点进行sql解析，生成分布式执行计划，下发到worker节点执行，cn将结果汇总返回客户端。</p>
<blockquote>
<p>来自 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1563023">PostgreSQL的几种分布式架构对比</a></p>
</blockquote>
<p>其它特性：</p>
<p>● PostgreSQL兼容</p>
<p>● 水平扩展</p>
<p>● 实时并发查</p>
<p>● 快速数据加载</p>
<p>● 实时增删改查</p>
<p>● 持分布式事务</p>
<p>● 支持常用DDL</p>
<h3 id="交互"><a href="#交互" class="headerlink" title="交互"></a>交互</h3><ol>
<li>客户端应用访问数据时只和CN节点交互。</li>
<li>CN收到SQL请求后，生成分布式执行计划，并将各个子任务下发到相应的Worker节点，之后收集Worker的结果，经过处理后返回最终结果给客户端。</li>
</ol>
<h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><ul>
<li><code>192.168.2.100:5432 master</code></li>
<li><code>192.168.2.101:5432 worker101</code></li>
<li><code>192.168.2.102:5432 worker102</code></li>
<li><code>192.168.2.103:5432 worker103</code></li>
<li><code>192.168.2.104:5432 worker104</code></li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="全部节点上的操作"><a href="#全部节点上的操作" class="headerlink" title="全部节点上的操作"></a>全部节点上的操作</h2><h3 id="安装-citus"><a href="#安装-citus" class="headerlink" title="安装 citus"></a>安装 <code>citus</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl https://install.citusdata.com/community/rpm.sh | sudo bash</span><br><span class="line"><span class="comment"># 查看所有版本</span></span><br><span class="line">yum list|grep citus</span><br><span class="line"><span class="comment"># 安装与自己PG对应的版本</span></span><br><span class="line">yum install -y citus83_10</span><br></pre></td></tr></table></figure>

<p>查看 <code>PG</code> 配置文件路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres -c <span class="string">&#x27;SHOW config_file&#x27;</span></span><br></pre></td></tr></table></figure>

<p>预加载 <code>citus</code> 扩展</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># preload citus extension</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;shared_preload_libraries = &#x27;citus&#x27;&quot;</span> | sudo <span class="built_in">tee</span> -a /var/lib/pgsql/10/data/postgresql.conf</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">systemctl restart postgresql-10</span><br></pre></td></tr></table></figure>

<h3 id="加载待所有的数据库中"><a href="#加载待所有的数据库中" class="headerlink" title="加载待所有的数据库中"></a>加载待所有的数据库中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -i -u postgres psql -c <span class="string">&quot;CREATE EXTENSION citus;&quot;</span></span><br></pre></td></tr></table></figure>

<p>成功输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTENSION</span><br></pre></td></tr></table></figure>

<h2 id="在Worker节点上执行"><a href="#在Worker节点上执行" class="headerlink" title="在Worker节点上执行"></a>在<code>Worker</code>节点上执行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;host    all             all             192.168.2.100/32            trust&quot;</span> &gt;&gt; /var/lib/pgsql/10/data/pg_hba.conf</span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">systemctl restart postgresql-10</span><br></pre></td></tr></table></figure>

<h2 id="在主节点上执行"><a href="#在主节点上执行" class="headerlink" title="在主节点上执行"></a>在主节点上执行</h2><h3 id="添加-worker-节点"><a href="#添加-worker-节点" class="headerlink" title="添加 worker 节点"></a>添加 <code>worker</code> 节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新版：citus_add_node  旧版：master_add_node</span></span><br><span class="line">sudo -i -u postgres psql -c <span class="string">&quot;SELECT * from master_add_node(&#x27;192.168.2.102&#x27;, 5432);&quot;</span></span><br><span class="line">sudo -i -u postgres psql -c <span class="string">&quot;SELECT * from master_add_node(&#x27;192.168.2.102&#x27;, 5432);&quot;</span></span><br><span class="line">sudo -i -u postgres psql -c <span class="string">&quot;SELECT * from master_add_node(&#x27;192.168.2.103&#x27;, 5432);&quot;</span></span><br><span class="line">sudo -i -u postgres psql -c <span class="string">&quot;SELECT * from master_add_node(&#x27;192.168.2.104&#x27;, 5432);&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新版：citus_get_active_worker_nodes  旧版：master_get_active_worker_nodes</span></span><br><span class="line">sudo -i -u postgres psql -c <span class="string">&quot;SELECT * FROM master_get_active_worker_nodes();&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   node_name   | node_port</span><br><span class="line">---------------+-----------</span><br><span class="line"> 192.168.2.101 |      5432</span><br><span class="line"> 192.168.2.103 |      5432</span><br><span class="line"> 192.168.2.102 |      5432</span><br><span class="line"> 192.168.2.104 |      5432</span><br></pre></td></tr></table></figure>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -i -u postgres psql</span><br></pre></td></tr></table></figure>

<p>这个，有点复杂。</p>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/8e2fc2ac/">https://github.com/maxzhao-it/blog/post/8e2fc2ac/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/6/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/blog/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/29/">29</a><a class="extend next" rel="next" href="/blog/page/8/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">赵联胜</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>




  <script src="/blog/js/third-party/pace.js"></script>

  





</body>
</html>
