<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/uploads/images/gt.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/images/gt-32.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/images/gt-16.jpg">
  <link rel="mask-icon" href="/blog/uploads/images/logo.png" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/blog/js/config.js"></script>



<link rel="canonical" href="https://github.com/maxzhao-it/blog/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>maxzhao</title>
  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<link rel="alternate" href="/blog/atom.xml" title="maxzhao" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">maxzhao</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">不要害怕Exception和Error</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-schedule"><a href="/blog/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="赵联胜"
      src="/blog/uploads/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">赵联胜</p>
  <div class="site-description" itemprop="description">小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">333</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">154</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">185</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://gitee.com/zhaoliansheng" title="GitHub → https:&#x2F;&#x2F;gitee.com&#x2F;zhaoliansheng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/blog/1441439636@qq.com" title="E-Mail → 1441439636@qq.com"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.jianshu.com/u/e8c426a6007e" title="https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;e8c426a6007e" rel="noopener" target="_blank">我的简书</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/4754f56b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/4754f56b/" class="post-title-link" itemprop="url">CentOS安装LDAP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/CentOS/" itemprop="url" rel="index"><span itemprop="name">CentOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>轻型目录访问协议</strong>（<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%8B%B1%E6%96%87">英文</a>：<strong>Lightweight Directory Access Protocol</strong>，<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BC%A9%E5%86%99">缩写</a>：<strong>LDAP</strong>，&#x2F;ˈɛldæp&#x2F;）是一个开放的，中立的，工业标准的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E5%8D%8F%E8%AE%AE">应用协议</a>，通过<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/IP%E5%8D%8F%E8%AE%AE">IP协议</a>提供访问控制和维护分布式信息的目录信息。</p>
<h4 id="LDAP的主要应用场景"><a href="#LDAP的主要应用场景" class="headerlink" title="LDAP的主要应用场景"></a>LDAP的主要应用场景</h4><p>1.网络服务：DNS服务<br>2.统一认证服务：<br>3.Linux PAM (ssh, login, cvs. . . )<br>4.Apache访问控制<br>5.各种服务登录(ftpd, php based, perl based, python based. . . )<br>6.个人信息类，如地址簿<br>7.服务器信息，如帐号管理、邮件服务等</p>
<blockquote>
<p><code>注意</code>:从<code>OpenLDAP2.4.23</code>版本开始所有配置数据都保存在<code>/etc/openldap/slapd.d/</code>中，不再使用<code>slapd.conf</code>作为配置文件</p>
</blockquote>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a><code>LDAP</code></h2><h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y openldap compat-openldap openldap  openldap-clients  openldap-devel openldap-servers </span><br><span class="line"><span class="comment"># 可选 collectd-openldap</span></span><br></pre></td></tr></table></figure>

<ul>
<li>安装后的目录：<code>/etc/openldap/</code></li>
<li>数据文件路径：<code>/var/lib/ldap</code></li>
<li>模板数据库配置文件： <code>/usr/share/openldap-servers/DB_CONFIG.example</code> </li>
<li><code>/usr/share/openldap-servers/slapd.ldif</code></li>
</ul>
<blockquote>
<p>如果是虚拟机安装：需要挂载<code>cdrom</code></p>
</blockquote>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start slapd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> slapd</span><br><span class="line">sudo systemctl status slapd</span><br></pre></td></tr></table></figure>

<h3 id="查看端口"><a href="#查看端口" class="headerlink" title="查看端口"></a>查看端口</h3><p>占用 <code>389</code> 端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tlnp | grep slapd</span><br></pre></td></tr></table></figure>



<h3 id="查看用户"><a href="#查看用户" class="headerlink" title="查看用户"></a>查看用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -n 1 /etc/passwd</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="修改域信息"><a href="#修改域信息" class="headerlink" title="修改域信息"></a>修改域信息</h4><p>设置管理员密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slappasswd</span><br><span class="line"><span class="comment"># 也可以指明密码</span></span><br><span class="line">slappasswd -s maxzhao</span><br></pre></td></tr></table></figure>

<p>输出的密码：<code>&#123;SSHA&#125;0tKDKqne3gJ30xZ73rDO491r/AlaJd0N</code></p>
<p>修改域信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openldap/slapd.d/cn\=config</span><br><span class="line">vim /etc/openldap/slapd.d/cn\=config/olcDatabase\=\&#123;2\&#125;hdb.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518194041425.png" alt="image-20220518194041425"></p>
<ul>
<li><code>olcRootDN：cn=root</code> 中的 <code>root</code>是管理员用户名</li>
<li><code>olcRootPW</code>：表示管理员密码</li>
</ul>
<h4 id="修改管理员信息"><a href="#修改管理员信息" class="headerlink" title="修改管理员信息"></a>修改管理员信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/openldap/slapd.d/cn\=config/olcDatabase\=\&#123;1\&#125;monitor.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518193954213.png" alt="image-20220518193954213"></p>
<ul>
<li><strong>dn.base</strong>是修改<strong>OpenLDAP的管理员的相关信息</strong></li>
</ul>
<p>验证OpenLDAP的基本配置，使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaptest -u</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518194138726.png" alt="image-20220518194138726"></p>
<p>重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart slapd</span><br><span class="line">sudo systemctl status slapd</span><br></pre></td></tr></table></figure>

<h3 id="配置OpenLDAP数据库"><a href="#配置OpenLDAP数据库" class="headerlink" title="配置OpenLDAP数据库"></a>配置<code>OpenLDAP</code>数据库</h3><p>OpenLDAP默认使用的数据库是BerkeleyDB，现在来开始配置OpenLDAP数据库，使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span><br><span class="line"><span class="built_in">cp</span> /usr/share/openldap-servers/slapd.ldif /etc/openldap/slapd.ldif</span><br><span class="line"><span class="built_in">chown</span> ldap:ldap -R /var/lib/ldap</span><br><span class="line"><span class="built_in">chmod</span> 700 -R /var/lib/ldap</span><br><span class="line">ll /var/lib/ldap/</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518194451664.png" alt="image-20220518194451664"></p>
<blockquote>
<p><code>/var/lib/ldap/</code>就是 <code>BerkeleyDB</code> 数据库默认存储的路径。</p>
</blockquote>
<h3 id="导入基本Schema"><a href="#导入基本Schema" class="headerlink" title="导入基本Schema"></a>导入基本Schema</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif</span><br></pre></td></tr></table></figure>

<h2 id="安装-migrationtools"><a href="#安装-migrationtools" class="headerlink" title="安装  migrationtools"></a>安装  <code>migrationtools</code></h2><p><code>migrationtools</code> 实现<code>OpenLDAP</code> 用户及用户组的添加，<code>migrationtools</code> 开源工具通过查找&#x2F;etc&#x2F;passwd、&#x2F;etc&#x2F;shadow、&#x2F;etc&#x2F;groups 生成LDIF 文件，并通过<code>ldapadd</code> 命令更新数据库数据，完成用户添加。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y migrationtools</span><br></pre></td></tr></table></figure>

<h3 id="修改migrate-common-ph文件"><a href="#修改migrate-common-ph文件" class="headerlink" title="修改migrate_common.ph文件"></a>修改migrate_common.ph文件</h3><p><code>migrate_common.ph</code>文件主要是用于生成<code>ldif</code>文件使用，修改<code>migrate_common.ph</code>文件，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/share/migrationtools/migrate_common.ph +71</span><br></pre></td></tr></table></figure>

<p>写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$DEFAULT_MAIL_DOMAIN = “maxzhao.com”;</span><br><span class="line">$DEFAULT_BASE = “dc=maxzhao,dc=com”;</span><br><span class="line">$EXTENDED_SCHEMA = 1;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518195011644.png" alt="image-20220518195011644"></p>
<h2 id="添加用户和用户组"><a href="#添加用户和用户组" class="headerlink" title="添加用户和用户组"></a>添加用户和用户组</h2><p>管理员用户就是 <code>root</code>，没有普通用户</p>
<h3 id="添加系统用户"><a href="#添加系统用户" class="headerlink" title="添加系统用户"></a>添加系统用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">groupadd ldapg1</span><br><span class="line">groupadd ldapg2</span><br><span class="line">useradd -g ldapg1 ldapu1</span><br><span class="line">useradd -g ldapg2 ldapu2</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;1&#x27;</span> | passwd --stdin ldapu1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;2&#x27;</span> | passwd --stdin ldapu2</span><br></pre></td></tr></table></figure>

<h3 id="生成-ldif文件"><a href="#生成-ldif文件" class="headerlink" title="生成 ldif文件"></a>生成 <code>ldif</code>文件</h3><p>取出用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;:10[0-9][0-9]&quot;</span> /etc/passwd &gt; /root/users</span><br><span class="line">grep <span class="string">&quot;:10[0-9][0-9]&quot;</span> /etc/group &gt; /root/groups</span><br><span class="line"><span class="built_in">cat</span> <span class="built_in">users</span></span><br><span class="line"><span class="built_in">cat</span> <span class="built_in">groups</span></span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518195600679.png" alt="image-20220518195600679"></p>
<p>根据上述生成的用户和用户组属性，使用<code>migrate_passwd.pl</code>文件生成要添加用户和用户组的<code>ldif</code>，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/migrationtools/migrate_passwd.pl /root/users &gt; /root/users.ldif</span><br><span class="line">/usr/share/migrationtools/migrate_group.pl /root/groups &gt; /root/groups.ldif</span><br><span class="line"><span class="built_in">cat</span> users.ldif</span><br><span class="line"><span class="built_in">cat</span> groups.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518195823844.png" alt="image-20220518195823844"></p>
<p><img src="/blog/uploads/images/image-20220518195845785.png" alt="image-20220518195845785"></p>
<h3 id="导入用户到LDAP"><a href="#导入用户到LDAP" class="headerlink" title="导入用户到LDAP"></a>导入用户到<code>LDAP</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /root/base.ldif &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">dn: dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">o: maxzhao com</span></span><br><span class="line"><span class="string">dc: maxzhao</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: dcObject</span></span><br><span class="line"><span class="string">objectclass: organization</span></span><br><span class="line"><span class="string">dn: cn=root,dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">cn: root</span></span><br><span class="line"><span class="string">objectClass: organizationalRole</span></span><br><span class="line"><span class="string">description: Directory Manager</span></span><br><span class="line"><span class="string">dn: ou=People,dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">ou: People</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: organizationalUnit</span></span><br><span class="line"><span class="string">dn: ou=Group,dc=maxzhao,dc=com</span></span><br><span class="line"><span class="string">ou: Group</span></span><br><span class="line"><span class="string">objectClass: top</span></span><br><span class="line"><span class="string">objectClass: organizationalUnit</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>导入基础数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -x -w <span class="string">&quot;maxzhao&quot;</span> -D <span class="string">&quot;cn=root,dc=maxzhao,dc=com&quot;</span> -f /root/base.ldif</span><br></pre></td></tr></table></figure>

<p>导入用户到数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -x -w <span class="string">&quot;maxzhao&quot;</span> -D <span class="string">&quot;cn=root,dc=maxzhao,dc=com&quot;</span> -f /root/users.ldif</span><br></pre></td></tr></table></figure>

<p><img src="/blog/uploads/images/image-20220518200312581.png" alt="image-20220518200312581"></p>
<p>查看<code>BerkeleyDB</code>数据库文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /var/lib/ldap/</span><br></pre></td></tr></table></figure>







<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.ilanni.com/?p=13775">https://www.ilanni.com/?p=13775</a></p>
</blockquote>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/4754f56b/">https://github.com/maxzhao-it/blog/post/4754f56b/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/805f48c5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/805f48c5/" class="post-title-link" itemprop="url">Linux获取当前日期+时间</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>计算机系统时间是从 <code>1970-01-01 00:00:00</code> 开始计算的。</p>
</blockquote>
<h1 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h1><h2 id="获取当前日期-时间"><a href="#获取当前日期-时间" class="headerlink" title="获取当前日期+时间"></a>获取当前日期+时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2022-05-16 21:05:53</span></span><br><span class="line">currentTime =`date &quot;+%Y-%m-%d %H:%M:%S&quot;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">简写</span></span><br><span class="line">currentTime =`date &quot;+%F %T&quot;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yyyy-MM-<span class="built_in">dd</span></span></span><br><span class="line">currentTime =`date &quot;+%Y-%m-%d&quot;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HH:mm:ss</span></span><br><span class="line">currentTime =`date &quot;+%H:%M:%S&quot;`</span><br></pre></td></tr></table></figure>

<h2 id="获取时间戳"><a href="#获取时间戳" class="headerlink" title="获取时间戳"></a>获取时间戳</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">时间戳（秒） 输出:1652706914</span></span><br><span class="line">seconds=`date &#x27;+%s&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取时间纳秒数</span></span><br><span class="line">nanoseconds=`date &#x27;+%N&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取当前时间的纳秒级时间戳（不建议使用）</span></span><br><span class="line">current_timestamp=$((`date &#x27;+%s&#x27;`*1000+`date &#x27;+%N&#x27;`/1000000))</span><br></pre></td></tr></table></figure>

<h2 id="获取某个时间的秒数"><a href="#获取某个时间的秒数" class="headerlink" title="获取某个时间的秒数"></a>获取某个时间的秒数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date -d &quot;2022-05-16 00:00:00&quot; +%s</span><br></pre></td></tr></table></figure>

<h2 id="将时间戳转换为时间"><a href="#将时间戳转换为时间" class="headerlink" title="将时间戳转换为时间"></a>将时间戳转换为时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Mon May 16 21:15:14 CST 2022</span></span><br><span class="line">date -d @1652706914</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yyyy-MM-<span class="built_in">dd</span> HH:mm:ss</span></span><br><span class="line">date -d &quot;1970-01-01 UTC 1652706914 seconds&quot; &quot;+%F %T&quot;</span><br></pre></td></tr></table></figure>

<h2 id="format格式说明表如下"><a href="#format格式说明表如下" class="headerlink" title="format格式说明表如下"></a>format格式说明表如下</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看脚本</span></span><br><span class="line">date --help</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>格式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>%%</td>
<td>%的转义</td>
</tr>
<tr>
<td>%a</td>
<td>当地星期几的缩写，例如Sun、日</td>
</tr>
<tr>
<td>%A</td>
<td>当地星期几的全称，例如Sunday、星期二</td>
</tr>
<tr>
<td>%b</td>
<td>当地月份的缩写，例如Jan、12月</td>
</tr>
<tr>
<td>%B</td>
<td>当地月份的全称，例如January、十二月</td>
</tr>
<tr>
<td>%c</td>
<td>当地日期和时间，例如Thu Mar 3 23:05:25 2005，2018年12月18日 星期二 15时46分23秒</td>
</tr>
<tr>
<td>%C</td>
<td>输出世纪，例如现在是2</td>
</tr>
<tr>
<td>%d</td>
<td>当前月份的第几天，例如18（2018-12-18）</td>
</tr>
<tr>
<td>%D</td>
<td>日期，格式与%m%d%y，年为两位数，例如12&#x2F;18&#x2F;18</td>
</tr>
<tr>
<td>%e</td>
<td>当前月份的第几天，例如08（2018-12-08）</td>
</tr>
<tr>
<td>%F</td>
<td>完整格式的日期，与%Y-%m-%d相同，例如2018-12-18</td>
</tr>
<tr>
<td>%g</td>
<td>年份中的后两位数，例如18</td>
</tr>
<tr>
<td>%G</td>
<td>年</td>
</tr>
<tr>
<td>%h</td>
<td>与%b一样</td>
</tr>
<tr>
<td>%H</td>
<td>小时（00…23）,即24小时制</td>
</tr>
<tr>
<td>%I</td>
<td>小时（01…12），即12小时制</td>
</tr>
<tr>
<td>%j</td>
<td>一年中的第几天（001…366）</td>
</tr>
<tr>
<td>%k</td>
<td>小时（1…23）</td>
</tr>
<tr>
<td>%l</td>
<td>小时（1…12）</td>
</tr>
<tr>
<td>%m</td>
<td>月份（01…12）</td>
</tr>
<tr>
<td>%M</td>
<td>分钟（01…59）</td>
</tr>
<tr>
<td>%n</td>
<td>新行</td>
</tr>
<tr>
<td>%N</td>
<td>纳秒（000000000…999999999）</td>
</tr>
<tr>
<td>%p</td>
<td>当地上午或下午，例如PM、下午</td>
</tr>
<tr>
<td>%P</td>
<td>当地上午或下午（小写），例如pm、下午</td>
</tr>
<tr>
<td>%q</td>
<td>第几季度（1…4）</td>
</tr>
<tr>
<td>%r</td>
<td>当地12小时制的时间格式，例如下午 04时06分24秒</td>
</tr>
<tr>
<td>%R</td>
<td>24小时制的时分（%H:%M），例如16:07</td>
</tr>
<tr>
<td>%s</td>
<td>从1970-01-01 00:00:00 UTC到现在的秒数</td>
</tr>
<tr>
<td>%S</td>
<td>当前分钟的秒数（00…59）</td>
</tr>
<tr>
<td>%T</td>
<td>等价%H:%M:%S，时分秒</td>
</tr>
<tr>
<td>%u</td>
<td>从星期一开始数，一周中的第几天（1…7）</td>
</tr>
<tr>
<td>%U</td>
<td>从星期日开始数，一年中的第几周（00…53）</td>
</tr>
<tr>
<td>%V</td>
<td>ISO周数，从周一开始数（01…53）</td>
</tr>
<tr>
<td>%w</td>
<td>从周日开始数，一周中的第几天（0…6）</td>
</tr>
<tr>
<td>%W</td>
<td>从星期一开始数，一年中的第几周（00…53）</td>
</tr>
<tr>
<td>%x</td>
<td>当地日期，例如2018年12月18日</td>
</tr>
<tr>
<td>%X</td>
<td>当地时间，例如16时16分17秒</td>
</tr>
<tr>
<td>%y</td>
<td>年份的后两位数（00…99）</td>
</tr>
<tr>
<td>%Y</td>
<td>年份</td>
</tr>
<tr>
<td>%z</td>
<td>时区，+hhmm，例如东八区+0800</td>
</tr>
<tr>
<td>%?</td>
<td>时区，+hh::mm，例如东八区+08:00</td>
</tr>
<tr>
<td>%:?</td>
<td>时区，+hh::mm:ss，例如东八区+08:00:00</td>
</tr>
<tr>
<td>%Z</td>
<td>时区的缩写，例如东八区CST</td>
</tr>
</tbody></table>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/805f48c5/">https://github.com/maxzhao-it/blog/post/805f48c5/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/a8a44639/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/a8a44639/" class="post-title-link" itemprop="url">分析JVM内存溢出的快照文件hprof</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><h3 id="手动导出内存快照"><a href="#手动导出内存快照" class="headerlink" title="手动导出内存快照"></a>手动导出内存快照</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=./java_pid6902.hprof 6902</span><br></pre></td></tr></table></figure>

<h3 id="自动导出"><a href="#自动导出" class="headerlink" title="自动导出"></a>自动导出</h3><p>添加脚本命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=./dump/</span><br></pre></td></tr></table></figure>



<h2 id="jhat-查看"><a href="#jhat-查看" class="headerlink" title="jhat 查看"></a><code>jhat</code> 查看</h2><h2 id="打开-hprof"><a href="#打开-hprof" class="headerlink" title="打开 hprof"></a>打开 <code>hprof</code></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口默认 7000 -J-Xmx512m</span></span><br><span class="line">jhat -port 7000 -J-Xmx512m java_pid14827.hprof</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>-J-Xmx512m</code>来设置最大堆大小为<code>512M</code>。</li>
</ul>
<h2 id="jvisualvm-查看"><a href="#jvisualvm-查看" class="headerlink" title="jvisualvm  查看"></a><code>jvisualvm</code>  查看</h2><p>直接载入文件</p>
<blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/zh/sdk-java-technology/7?topic=tools-using-hprof-profiler">IBM：使用 <code>HPROF</code> 概要文件分析器</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/zh/sdk-java-technology/7?topic=profiler-explanation-hprof-output-file">IBM：<code>HPROF</code> 输出文件的说明</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/technotes/samples/hprof.html"><code>HPROF: A Heap/CPU Profiling Tool</code></a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/276">深入浅出<code>JProfiler</code></a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/onmyway20xx/p/3963735.html">使用<code>JProfiler</code>进行内存分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ej-technologies.com/resources/jprofiler/help/doc/main/introduction.html#jprofiler.introduction"><code>Introduction To JProfiler</code></a></p>
</blockquote>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/a8a44639/">https://github.com/maxzhao-it/blog/post/a8a44639/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/63856b15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/63856b15/" class="post-title-link" itemprop="url">RestTemplate设置超时时间</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-20 17:32:10" itemprop="dateModified" datetime="2022-12-20T17:32:10+08:00">2022-12-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/SpringBoot/RestTemplate/" itemprop="url" rel="index"><span itemprop="name">RestTemplate</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>用于同步客户端HTTP访问的Spring scentral类。它简化了与httpserver的通信，并实施了RESTful原则。它处理HTTP连接，让应用程序代码提供url(带有可能的模板变量)并提取结果。（简化了发起HTTP请求以及处理响应的过程，并且支持REST。）</p>
<p>RestTemplate默认依赖JDK提供http连接的能力（HttpURLConnection），如果有需要的话也可以通过setRequestFactory方法替换为例如 Apache HttpComponents、Netty或OkHttp等其它HTTP library。</p>
<h2 id="静态属性配置超时时间"><a href="#静态属性配置超时时间" class="headerlink" title="静态属性配置超时时间"></a>静态属性配置超时时间</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.HttpComponentsClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 舆情请求工具</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RestTemplate REST_TEMPLATE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">/*设置请求工具*/</span></span><br><span class="line">        REST_TEMPLATE = <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        <span class="type">HttpComponentsClientHttpRequestFactory</span> <span class="variable">clientHttpRequestFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpComponentsClientHttpRequestFactory</span>();</span><br><span class="line">        clientHttpRequestFactory.setConnectionRequestTimeout(<span class="number">60000</span>);</span><br><span class="line">        clientHttpRequestFactory.setConnectTimeout(<span class="number">60000</span>);</span><br><span class="line">        clientHttpRequestFactory.setReadTimeout(<span class="number">60000</span>);</span><br><span class="line">        REST_TEMPLATE.setRequestFactory(clientHttpRequestFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Spring-Bean配置类"><a href="#Spring-Bean配置类" class="headerlink" title="Spring Bean配置类"></a><code>Spring Bean</code>配置类</h2><p>创建<code>HttpClientConfig</code>类，设置连接池大小、超时时间、重试机制等。配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * - Supports both HTTP and HTTPS</span></span><br><span class="line"><span class="comment"> * - Uses a connection pool to re-use connections and save overhead of creating connections.</span></span><br><span class="line"><span class="comment"> * - Has a custom connection keep-alive strategy (to apply a default keep-alive if one isn&#x27;t specified)</span></span><br><span class="line"><span class="comment"> * - Starts an idle connection monitor to continuously clean up stale connections.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpClientConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(HttpClientConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HttpClientProperties p;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PoolingHttpClientConnectionManager <span class="title function_">poolingConnectionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SSLContextBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLContextBuilder</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            builder.loadTrustMaterial(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">TrustStrategy</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTrusted</span><span class="params">(X509Certificate[] arg0, String arg1)</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException | KeyStoreException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;Pooling Connection Manager Initialisation failure because of &quot;</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">SSLConnectionSocketFactory</span> <span class="variable">sslsf</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sslsf = <span class="keyword">new</span> <span class="title class_">SSLConnectionSocketFactory</span>(builder.build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeyManagementException | NoSuchAlgorithmException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;Pooling Connection Manager Initialisation failure because of &quot;</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Registry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry = RegistryBuilder</span><br><span class="line">                .&lt;ConnectionSocketFactory&gt;create()</span><br><span class="line">                .register(<span class="string">&quot;https&quot;</span>, sslsf)</span><br><span class="line">                .register(<span class="string">&quot;http&quot;</span>, <span class="keyword">new</span> <span class="title class_">PlainConnectionSocketFactory</span>())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">PoolingHttpClientConnectionManager</span> <span class="variable">poolingConnectionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolingHttpClientConnectionManager</span>(socketFactoryRegistry);</span><br><span class="line">        poolingConnectionManager.setMaxTotal(p.getMaxTotalConnections());  <span class="comment">//最大连接数</span></span><br><span class="line">        poolingConnectionManager.setDefaultMaxPerRoute(p.getDefaultMaxPerRoute());  <span class="comment">//同路由并发数</span></span><br><span class="line">        <span class="keyword">return</span> poolingConnectionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConnectionKeepAliveStrategy <span class="title function_">connectionKeepAliveStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionKeepAliveStrategy</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getKeepAliveDuration</span><span class="params">(HttpResponse response, HttpContext httpContext)</span> &#123;</span><br><span class="line">                <span class="type">HeaderElementIterator</span> <span class="variable">it</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicHeaderElementIterator</span></span><br><span class="line">                        (response.headerIterator(HTTP.CONN_KEEP_ALIVE));</span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    <span class="type">HeaderElement</span> <span class="variable">he</span> <span class="operator">=</span> it.nextElement();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> he.getName();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> he.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; param.equalsIgnoreCase(<span class="string">&quot;timeout&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Long.parseLong(value) * <span class="number">1000</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> p.getDefaultKeepAliveTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CloseableHttpClient <span class="title function_">httpClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RequestConfig</span> <span class="variable">requestConfig</span> <span class="operator">=</span> RequestConfig.custom()</span><br><span class="line">                .setConnectionRequestTimeout(p.getRequestTimeout())</span><br><span class="line">                .setConnectTimeout(p.getConnectTimeout())</span><br><span class="line">                .setSocketTimeout(p.getSocketTimeout()).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpClients.custom()</span><br><span class="line">                .setDefaultRequestConfig(requestConfig)</span><br><span class="line">                .setConnectionManager(poolingConnectionManager())</span><br><span class="line">                .setKeepAliveStrategy(connectionKeepAliveStrategy())</span><br><span class="line">                .setRetryHandler(<span class="keyword">new</span> <span class="title class_">DefaultHttpRequestRetryHandler</span>(<span class="number">3</span>, <span class="literal">true</span>))  <span class="comment">// 重试次数</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Runnable <span class="title function_">idleConnectionMonitor</span><span class="params">(<span class="keyword">final</span> PoolingHttpClientConnectionManager connectionManager)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@Scheduled(fixedDelay = 10000)</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (connectionManager != <span class="literal">null</span>) &#123;</span><br><span class="line">                        LOGGER.trace(<span class="string">&quot;run IdleConnectionMonitor - Closing expired and idle connections...&quot;</span>);</span><br><span class="line">                        connectionManager.closeExpiredConnections();</span><br><span class="line">                        connectionManager.closeIdleConnections(p.getCloseIdleConnectionWaitTimeSecs(), TimeUnit.SECONDS);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LOGGER.trace(<span class="string">&quot;run IdleConnectionMonitor - Http Client Connection manager is not initialised&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">&quot;run IdleConnectionMonitor - Exception occurred. msg=&#123;&#125;, e=&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TaskScheduler <span class="title function_">taskScheduler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskScheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskScheduler</span>();</span><br><span class="line">        scheduler.setThreadNamePrefix(<span class="string">&quot; poolScheduler&quot;</span>);</span><br><span class="line">        scheduler.setPoolSize(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">return</span> scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后再配置RestTemplateConfig类，使用之前配置好的CloseableHttpClient类注入，同时配置一些默认的消息转换器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RestTemplate客户端连接池配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CloseableHttpClient httpClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">(MappingJackson2HttpMessageConverter jackson2HttpMessageConverter)</span> &#123;</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(clientHttpRequestFactory());</span><br><span class="line"></span><br><span class="line">        List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">StringHttpMessageConverter</span> <span class="variable">stringHttpMessageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringHttpMessageConverter</span>(Charset.forName(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">        messageConverters.add(stringHttpMessageConverter);</span><br><span class="line">        messageConverters.add(jackson2HttpMessageConverter);</span><br><span class="line">        restTemplate.setMessageConverters(messageConverters);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpComponentsClientHttpRequestFactory <span class="title function_">clientHttpRequestFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HttpComponentsClientHttpRequestFactory</span> <span class="variable">rf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpComponentsClientHttpRequestFactory</span>();</span><br><span class="line">        rf.setHttpClient(httpClient);</span><br><span class="line">        <span class="keyword">return</span> rf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><h2 id="自定义异常处理器"><a href="#自定义异常处理器" class="headerlink" title="自定义异常处理器"></a>自定义异常处理器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">REST_TEMPLATE.setErrorHandler(<span class="keyword">new</span> <span class="title class_">DefaultResponseErrorHandler</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleError</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/*错误请求不为 400 时，抛出异常*/</span></span><br><span class="line">        <span class="keyword">if</span> (!HttpStatus.BAD_REQUEST.equals(response.getStatusCode())) &#123;</span><br><span class="line">            <span class="built_in">super</span>.handleError(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/63856b15/">https://github.com/maxzhao-it/blog/post/63856b15/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/a9539589/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/a9539589/" class="post-title-link" itemprop="url">记录一次OOM排查过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-23 17:16:30" itemprop="dateModified" datetime="2022-12-23T17:16:30+08:00">2022-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="了解"><a href="#了解" class="headerlink" title="了解"></a>了解</h2><p>驻场研发人员反应生产系统宕机，在开发环境连接线上数据库不会复现。</p>
<p>重启系统后系统正常访问，但是在一周之内又会出现当宕机情况。</p>
<p>在读取项目日志文件之后，发现 <code>OOM：java head space</code></p>
<ul>
<li>生产环境项目使用：<code>Spring boot jar</code> 方式部署</li>
<li><code>Java</code>环境：<code>jdk1.8</code></li>
</ul>
<h1 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h1><h2 id="主要思路"><a href="#主要思路" class="headerlink" title="主要思路"></a>主要思路</h2><p>堆内存溢出，可能是由于某段时间处理内容过多导致的，所以增加堆内存空间解决。</p>
<ol>
<li>加大堆内存</li>
<li>复现<code>OOM</code></li>
<li>实时监控</li>
</ol>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><h3 id="加大堆内存到8G"><a href="#加大堆内存到8G" class="headerlink" title="加大堆内存到8G"></a>加大堆内存到<code>8G</code></h3><p>启动参数上添加</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xmx8G -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintHeapAtGC -Xloggc:gc.log</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里遇到了一个问题，在紧急响应系统重启后 <code>gc.log</code> 文件会被覆盖，在第二阶段会讲到解决覆盖问题。</p>
<p><code>Tomcat</code>官方推荐在 <code>setenv.bat/setenv.sh</code>配置，<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/RUNNING.txt"><code>Tomcat</code> 说明</a></p>
</blockquote>
<h3 id="模拟用户访问"><a href="#模拟用户访问" class="headerlink" title="模拟用户访问"></a>模拟用户访问</h3><p>使用前端脚本模拟用户操作</p>
<h3 id="实时监控"><a href="#实时监控" class="headerlink" title="实时监控"></a>实时监控</h3><p>服务器使用实时监控</p>
<p>方式一：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询程序的 pid</span></span><br><span class="line">jps -mVl</span><br><span class="line"><span class="comment"># 实时监控 JVM 堆</span></span><br><span class="line">jstat -gc -h10 -t pid 1000  8</span><br></pre></td></tr></table></figure>

<p>方式二：</p>
<p>添加程序 <code>jmx</code>启动参数，使用 <code>jconsole</code>实时监控</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.rmi.server.hostname=xx.xx.xx.xx</span><br><span class="line">-Dfile.encoding=utf-8</span><br><span class="line">-Dcom.sun.management.jmxremote</span><br><span class="line">-Dcom.sun.management.jmxremote.port=50001</span><br><span class="line">-Dcom.sun.management.jmxremote.rmi.port=50002</span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span></span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=maxzhao</span><br><span class="line">-jar  xxx.jar </span><br></pre></td></tr></table></figure>

<p>使用 <code>jconsole</code>连接</p>
<p><img src="/blog/uploads/images/JAVA/JVM/image-20220524105611920.png" alt="image-20220524105611920"></p>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>偶发性极强，无法主观复现。</p>
<p>对于线上系统，实时监控效率低下，意义不大。</p>
<h1 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h1><h2 id="主要思路-1"><a href="#主要思路-1" class="headerlink" title="主要思路"></a>主要思路</h2><p>由于实时分析<code>JVM</code>行不通，我们这里在<code>OOM</code>发生时自动导出 <code>dump</code>，然后分析。</p>
<ol>
<li>打印<code>GC</code>日志、输出<code>oom</code>时的<code>dump</code>文件</li>
<li>分析<code>OOM</code>时的内存<code>dump</code>文件</li>
</ol>
<h2 id="过程-1"><a href="#过程-1" class="headerlink" title="过程"></a>过程</h2><h3 id="配置启动参数"><a href="#配置启动参数" class="headerlink" title="配置启动参数"></a>配置启动参数</h3><p>打印<code>JVM GC</code> 信息和<code>oom</code>时的<code>dump</code>文件，启动参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">current=`date &#x27;+%s&#x27;`</span><br><span class="line">java \</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为了更好的复现，最大堆内存改为 4G</span></span><br><span class="line">-Xmx4G \</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印出GC详细信息</span></span><br><span class="line">-XX:+PrintGCDetails \</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印时间戳</span></span><br><span class="line">-XX:+PrintGCDateStamps \</span><br><span class="line">-XX:+PrintHeapAtGC \</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">记录到文件,添加文件名称时间戳，防止紧急重启后覆盖文件</span></span><br><span class="line">-Xloggc:gc.log-$&#123;current&#125; \</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">JVM 一个日志文件达到了20M以后，会生成新的，保留50个历史</span></span><br><span class="line">-XX:+UseGCLogFileRotation \</span><br><span class="line">-XX:GCLogFileSize=20M \</span><br><span class="line">-XX:NumberOfGCLogFiles=50 \</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内存溢出异常时Dump出当前的堆内存转储快照</span></span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError \</span><br><span class="line">-XX:HeapDumpPath=./dump/ \</span><br><span class="line">-jar xxx.jar </span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里使用时间戳的方式解决系统重启导致 <code>gc.log</code> 文件被覆盖的问题</p>
<p>这里堆内存设置<code>4G</code>，不能过小，否则可能无法获取真实的<code>OOM</code>产生原因。</p>
</blockquote>
<h3 id="查询系统-JVM-参数"><a href="#查询系统-JVM-参数" class="headerlink" title="查询系统 JVM 参数"></a>查询系统 <code>JVM</code> 参数</h3><p>查询 Java 进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps -mVl</span><br></pre></td></tr></table></figure>

<p>查询 <code>vm</code> 参数信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jinfo -flags pid</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Attaching to process ID 15724, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.291-b10</span><br><span class="line">Non-default VM flags:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令行指定的参数</span></span><br><span class="line">Command line: </span><br></pre></td></tr></table></figure>

<h3 id="实时监控-1"><a href="#实时监控-1" class="headerlink" title="实时监控"></a>实时监控</h3><p>实时监控分为三块</p>
<h4 id="1、TOP-监控整理进程"><a href="#1、TOP-监控整理进程" class="headerlink" title="1、TOP  监控整理进程"></a>1、<code>TOP</code>  监控整理进程</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top</span><br></pre></td></tr></table></figure>

<p>现象：内存一直在涨，最总涨到 <code>27%</code> （服务器内存 <code>16G</code>），没有 <code>oom</code></p>
<h4 id="2、监控-GC-日志"><a href="#2、监控-GC-日志" class="headerlink" title="2、监控 GC 日志"></a>2、监控 <code>GC</code> 日志</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f  gc.log-xxx</span><br></pre></td></tr></table></figure>

<p>现象：&#96;&#96;YGC<code> 正常，</code>Full GC&#96; 正常</p>
<h2 id="OOM分析"><a href="#OOM分析" class="headerlink" title="OOM分析"></a><code>OOM</code>分析</h2><h3 id="系统宕机，oom发生"><a href="#系统宕机，oom发生" class="headerlink" title="系统宕机，oom发生"></a>系统宕机，<code>oom</code>发生</h3><p>发生在 <code>2022-5-20:17:31</code></p>
<h3 id="gc-log-xxx日志分析"><a href="#gc-log-xxx日志分析" class="headerlink" title="gc.log.xxx日志分析"></a><code>gc.log.xxx</code>日志分析</h3><p><img src="/blog/uploads/images/JAVA/JVM/image-20220524110934865.png" alt="image-20220524110934865"></p>
<p>可以从日志中了解到：</p>
<ol>
<li>在 <code>oom</code> 前半小时，在 <code>16:54:32</code>开始内存处于不正常的增长， <code>YGC</code>与<code>FGC</code>异常。</li>
<li><code>FGC</code>频发占用资源。</li>
</ol>
<h3 id="oom-dump文件分析"><a href="#oom-dump文件分析" class="headerlink" title="oom dump文件分析"></a><code>oom dump</code>文件分析</h3><p><code>dump</code> 文件：<code>java_pid16600.hprof</code>，大小 <code>4.01G</code>(我们配置的最大堆内存4G)。</p>
<h4 id="用-jvisualvm打开-hprof"><a href="#用-jvisualvm打开-hprof" class="headerlink" title="用 jvisualvm打开 hprof"></a>用 <code>jvisualvm</code>打开 <code>hprof</code></h4><p>这里使用 <code>jdk1.8</code>的  <code>jvisualvm</code></p>
<p>配置 <code>jvisualvm</code>的初始内存配置，本机文件所在路径 <code>$&#123;JAVA_HOME&#125;\lib\visualvm\etc\visualvm.conf</code></p>
<p>找到 <code>visualvm_default_options</code> 配置 <code>-J-Xmx8G</code>就可以正常打开 <code>4G</code>的<code>hprof</code>。</p>
<p><img src="/blog/uploads/images/JAVA/JVM/image-20220524111550357.png" alt="image-20220524111550357"></p>
<p>命令行打开 <code>jvisualvm</code>，点击左上角的<strong>文件</strong>-<strong>载入</strong></p>
<img src="/uploads/images/JAVA/JVM/image-20220524111838333.png" alt="image-20220524111838333" style="zoom: 67%;" />

<h4 id="概要信息"><a href="#概要信息" class="headerlink" title="概要信息"></a>概要信息</h4><p><img src="/blog/uploads/images/JAVA/JVM/image-20220530114251459.png" alt="image-20220530114251459"></p>
<p>在概要信息里，我们可以点击 <strong>异常错误的线程</strong>来查看异常信息。</p>
<p>对于<code>OOM</code>来讲，一般情况下，堆栈被几百上千个对象占用，无法判断是否有问题，而且错误的堆栈不一定是产生<code>OOM</code>的原因，可能是压垮整个系统的最后一根稻草，所以具体我们还需要查看堆中的<strong>类</strong>和<strong>实例</strong></p>
<h4 id="查看类的内容"><a href="#查看类的内容" class="headerlink" title="查看类的内容"></a>查看类的内容</h4><p><img src="/blog/uploads/images/JAVA/JVM/image-20220524114048695.png" alt="image-20220524114048695"></p>
<p><img src="/blog/uploads/images/JAVA/JVM/image-20220524113951091.png" alt="image-20220524113951091"></p>
<p>这里我们可以看到</p>
<ol>
<li><code>char[]</code> 占用<code>2.2G</code></li>
<li><code>String</code> 占用 <code>1G</code></li>
<li><code>BigDecimal</code> 占用 <code>291MB</code></li>
<li><code>对象X</code> 占用 <code>412MB</code></li>
</ol>
<h4 id="查看实例"><a href="#查看实例" class="headerlink" title="查看实例"></a>查看实例</h4><p><code>char[]</code>是比较难看懂的，我们这里直接看 <code>String</code></p>
<p>双击 <code>String</code> 所在的行</p>
<p><img src="/blog/uploads/images/JAVA/JVM/image-20220524115014932.png" alt="image-20220524115014932"></p>
<p>随机看一看其它<code>String</code> 实例，发现绝大部分都是属于 <code>对象X</code>。</p>
<p>而<code>对象X</code>是一个百万级的集合，根据 <code>gc.log.xxx</code> 异常的时间，以及操作日志，找出所有请求的<code>URL</code>。</p>
<p>然后根据这些接口排查持久层返回 <code>对象X</code> 的方法。</p>
<h3 id="相关代码"><a href="#相关代码" class="headerlink" title="相关代码"></a>相关代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">判断条件A是否存在</span><br><span class="line">	存在加入where 条件</span><br><span class="line">判断条件B是否存在</span><br><span class="line">	存在加入where 条件</span><br><span class="line">判断条件C是否存在</span><br><span class="line">	存在加入where 条件</span><br><span class="line">条件D加入where 条件</span><br></pre></td></tr></table></figure>

<p>当前查询没有分页控制，如果主要的三个判断条件都不存在时，查询后会导致结果集过大，从而内存溢出。</p>
<h3 id="修改方式"><a href="#修改方式" class="headerlink" title="修改方式"></a>修改方式</h3><p>根据当前业务，这里添加了分页，取第一页 <code>10000</code>条数据，超过<code>10000</code>条则不获取。</p>
<h3 id="特别注意"><a href="#特别注意" class="headerlink" title="特别注意"></a>特别注意</h3><ol>
<li>程序中不应该出现没有分页的情况，如果出现，请考虑数据量。</li>
<li>后端程序不能依赖前端参数来控制代码逻辑，要使得程序可控，提高代码的健壮性。</li>
<li>程序一定要有完整的操作日志（包括但不限于接口、方法的参数、响应数据）</li>
<li><code>Spring Booot jar</code>内置 <code>Tomcat core</code>，可以不用<code>Tomcat</code>部署。</li>
<li><code>JVM</code>堆内存不建议设置过大，默认为服务器 <code>1/4</code></li>
</ol>
<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><h2 id="安装-VisualGC-插件"><a href="#安装-VisualGC-插件" class="headerlink" title="安装 VisualGC 插件"></a>安装 <code>VisualGC</code> 插件</h2><p>当前插件可以用于实时监控</p>
<p><img src="/blog/uploads/images/JAVA/JVM/image-20220524120157898.png" alt="image-20220524120157898"></p>
<p>填入地址：<code>https://visualvm.github.io/uc/8u131/updates.xml.gz</code></p>
<blockquote>
<p>插件官网：<a target="_blank" rel="noopener" href="https://visualvm.github.io/plugins.html"><code>https://visualvm.github.io/plugins.html</code></a></p>
</blockquote>
<p><img src="/blog/uploads/images/JAVA/JVM/image-20220524120304503.png" alt="image-20220524120304503"></p>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/a9539589/">https://github.com/maxzhao-it/blog/post/a9539589/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/3c725d5d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/3c725d5d/" class="post-title-link" itemprop="url">JConsole 开启远程连接</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-28 17:37:15" itemprop="dateModified" datetime="2022-07-28T17:37:15+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a><code>JConsole</code></h1><p>这是一个可视化的 <code>JVM</code> 监视工具 （<code>jvisualvm</code> 一样）。</p>
<h2 id="JMX"><a href="#JMX" class="headerlink" title="JMX"></a><code>JMX</code></h2><h2 id="开启"><a href="#开启" class="headerlink" title="开启"></a>开启</h2><p>添加启动参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-Xms1024m</span><br><span class="line">-Xmx8192m</span><br><span class="line">-XX:PermSize=256M</span><br><span class="line">-XX:MaxPermSize=1024m</span><br><span class="line">-Djava.rmi.server.hostname=192.168.2.1</span><br><span class="line">-Dfile.encoding=utf-8</span><br><span class="line">-Dcom.sun.management.jmxremote</span><br><span class="line">-Dcom.sun.management.jmxremote.port=50001</span><br><span class="line">-Dcom.sun.management.jmxremote.rmi.port=50002</span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=false</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=maxzhao</span><br></pre></td></tr></table></figure>

<h2 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h2><p><img src="/blog/uploads/images/JAVA/JVM/image-20220429114218667.png" alt="image-20220429114218667"></p>
<p>口令就是 <code>maxzhao</code></p>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/3c725d5d/">https://github.com/maxzhao-it/blog/post/3c725d5d/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/f9aa9996/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/f9aa9996/" class="post-title-link" itemprop="url">分析JVM内存溢出的hprof</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><h3 id="手动导出内存快照"><a href="#手动导出内存快照" class="headerlink" title="手动导出内存快照"></a>手动导出内存快照</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=./java_pid6902.hprof 6902</span><br></pre></td></tr></table></figure>

<h3 id="自动导出"><a href="#自动导出" class="headerlink" title="自动导出"></a>自动导出</h3><p>添加脚本命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">current=`date &#x27;+%s&#x27;`</span><br><span class="line">java -Xmx1G -XX:+PrintGCDetails  -XX:+PrintGCTimeStamps -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=./dump/  -Xloggc:gclog.log-$&#123;current&#125; -XX:+UseGCLogFileRotation  -XX:GCLogFileSize=20M  -XX:NumberOfGCLogFiles=50 -jar  app.jar</span><br></pre></td></tr></table></figure>

<blockquote>
<p>更多参考<a href="./3c725d5d">JVM参数</a></p>
</blockquote>
<h2 id="jhat-查看"><a href="#jhat-查看" class="headerlink" title="jhat 查看"></a><code>jhat</code> 查看</h2><h2 id="打开-hprof"><a href="#打开-hprof" class="headerlink" title="打开 hprof"></a>打开 <code>hprof</code></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口默认 7000 -J-Xmx512m</span></span><br><span class="line">jhat -port 7000 -J-Xmx512m java_pid14827.hprof</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>-J-Xmx512m</code>来设置最大堆大小为<code>512M</code>。</li>
</ul>
<h2 id="jvisualvm-查看"><a href="#jvisualvm-查看" class="headerlink" title="jvisualvm  查看"></a><code>jvisualvm</code>  查看</h2><p>直接载入文件,选择文件类型 <code>.hprof</code></p>
<p><img src="/blog/uploads/images/JAVA/JVM/image-20220524103324385.png" alt="image-20220524103324385"></p>
<blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/zh/sdk-java-technology/7?topic=tools-using-hprof-profiler">IBM：使用 <code>HPROF</code> 概要文件分析器</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/zh/sdk-java-technology/7?topic=profiler-explanation-hprof-output-file">IBM：<code>HPROF</code> 输出文件的说明</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/technotes/samples/hprof.html"><code>HPROF: A Heap/CPU Profiling Tool</code></a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/276">深入浅出<code>JProfiler</code></a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/onmyway20xx/p/3963735.html">使用<code>JProfiler</code>进行内存分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ej-technologies.com/resources/jprofiler/help/doc/main/introduction.html#jprofiler.introduction"><code>Introduction To JProfiler</code></a></p>
</blockquote>
<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/f9aa9996/">https://github.com/maxzhao-it/blog/post/f9aa9996/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/3c725d5d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/3c725d5d/" class="post-title-link" itemprop="url">JVM参数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-18 09:39:12" itemprop="dateModified" datetime="2022-12-18T09:39:12+08:00">2022-12-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="开启-JMX"><a href="#开启-JMX" class="headerlink" title="开启 JMX"></a>开启 <code>JMX</code></h2><p>添加启动参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-Xms1024m</span><br><span class="line">-Xmx8192m</span><br><span class="line">-XX:PermSize=256M</span><br><span class="line">-XX:MaxPermSize=1024m</span><br><span class="line">-Djava.rmi.server.hostname=192.168.2.1</span><br><span class="line">-Dfile.encoding=utf-8</span><br><span class="line">-Dcom.sun.management.jmxremote</span><br><span class="line">-Dcom.sun.management.jmxremote.port=50001</span><br><span class="line">-Dcom.sun.management.jmxremote.rmi.port=50002</span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=false</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=maxzhao</span><br></pre></td></tr></table></figure>

<h2 id="查询某进程-JVM-参数"><a href="#查询某进程-JVM-参数" class="headerlink" title="查询某进程 JVM 参数"></a>查询某进程 <code>JVM</code> 参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jinfo -flags pid</span><br></pre></td></tr></table></figure>

<h2 id="启动参数"><a href="#启动参数" class="headerlink" title="启动参数"></a>启动参数</h2><h3 id="常见配置"><a href="#常见配置" class="headerlink" title="常见配置"></a>常见配置</h3><h4 id="堆配置"><a href="#堆配置" class="headerlink" title="堆配置"></a>堆配置</h4><ul>
<li><code>-Xms1024m</code> 最小堆的大小，<code>JVM</code> 启动后默认分配的</li>
<li><code>-Xmx8196m</code> 是最大堆的大小</li>
<li><code>-XX:NewSize=170m</code>  设置年轻代大小</li>
<li><code>-XX:NewRatio=4</code>  设置年轻代（包括Eden和两个Survivor区）与年老代的比值（除去持久代）。设置为4，则年轻代与年老代所占比值为1：4，年轻代占整个堆栈的1&#x2F;5</li>
<li><code>-XX:SurvivorRatio=4</code>  设置年轻代中Eden区与Survivor区的大小比值。设置为4，则两个Survivor区与一个Eden区的比值为2:4，一个Survivor区占整个年轻代的1&#x2F;6</li>
<li><code>-XX:MaxPermSize=16m</code>  设置持久代大小为16m,必须以M为单位。</li>
<li><code>-Xmn2g</code> 是年轻代大小，推荐设置为堆的 <code>3/8</code>（<strong>整个<code>JVM</code>内存大小&#x3D;年轻代大小 + 年老代大小 + 持久代大小（固定<code>64m</code>）</strong>）</li>
<li><code>-Xss128k</code> 是每个线程的堆栈大小，默认<code>1M</code>（减少这个值就可以创建更多的线程）</li>
</ul>
<h4 id="收集器设置"><a href="#收集器设置" class="headerlink" title="收集器设置"></a>收集器设置</h4><ul>
<li><code>-XX:+UseSerialGC</code>:设置串行收集器</li>
<li><code>-XX:+UseParallelGC</code>:设置并行收集器 （<code>JDK8</code>默认）</li>
<li><code>-XX:+UseParallelOldGC</code>:设置并行年老代收集器</li>
<li><code>-XX:+UseConcMarkSweepGC</code>:设置并发收集器</li>
</ul>
<h5 id="并行收集器设置"><a href="#并行收集器设置" class="headerlink" title="并行收集器设置"></a>并行收集器设置</h5><ul>
<li><code>-XX:ParallelGCThreads=20</code>  设置并行收集器收集时使用的CPU数。并行收集线程数。</li>
<li><code>-XX:MaxGCPauseMillis=100</code>  设置并行收集最大暂停时间，如果无法满足此时间，<code>JVM</code> 会自动调整年轻代大小，以满足此值。</li>
<li><code>-XX:GCTimeRatio=n</code>  设置垃圾回收时间占程序运行时间的百分比。公式为1&#x2F;(1+n)</li>
</ul>
<h5 id="并发收集器设置"><a href="#并发收集器设置" class="headerlink" title="并发收集器设置"></a>并发收集器设置</h5><ul>
<li><code>-XX:+CMSIncrementalMode</code>  设置为增量模式。适用于单CPU情况。</li>
<li><code>-XX:ParallelGCThreads=20</code>  设置并发收集器年轻代收集方式为并行收集时，使用的CPU数。并行收集线程数。</li>
</ul>
<h6 id="串行垃圾回收器"><a href="#串行垃圾回收器" class="headerlink" title="串行垃圾回收器"></a>串行垃圾回收器</h6><ul>
<li><code>-XX:NewRatio=4 </code> 表示设置年轻代：老年代的大小比值为1：4，这意味着年轻代占整个堆的1&#x2F;5。</li>
<li><code>-XX:SurvivorRatio=8</code>  表示设置2个Survivor区：1个Eden区的大小比值为2:8，这意味着Survivor区占整个年轻代的1&#x2F;5，这个参数默认为8。</li>
<li><code>-XX:PretenureSizeThreshold=3145728 </code> 表示对象大于3145728（3M）时直接进入老年代分配，这里只能以字节作为单位</li>
<li><code>-XX:MaxTenuringThreshold=1 </code> 表示对象年龄大于1，自动进入老年代，如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代.对于年老代比较多的应用，可以提高效率。**<br>如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间**，增加在年轻代即被回收的概论。</li>
</ul>
<h4 id="垃圾回收统计信息"><a href="#垃圾回收统计信息" class="headerlink" title="垃圾回收统计信息"></a>垃圾回收统计信息</h4><p><code>GC</code>日志：</p>
<ul>
<li><code>-XX:+PrintGC</code>  表示在控制台上打印出GC信息 <code>[GC 118250K-&gt;113543K(130112K), 0.0094143 secs]</code></li>
<li><code>-XX:+PrintGCDetails </code><br>表示在控制台上打印出GC详细信息 <code>[GC [DefNew: 8614K-&gt;8614K(9088K), 0.0000665 secs][Tenured: 112761K-&gt;10414K(121024K), 0.0433488 secs] 121376K-&gt;10414K(130112K), 0.0436268 secs]</code></li>
<li><code>-XX:+PrintGCDateStamps </code> 表示在控制台上打印时间戳</li>
<li><code>-XX:+PrintGCTimeStamps </code> 打印GC停顿耗时 <code>11.851: [GC 98328K-&gt;93620K(130112K), 0.0082960 secs]</code></li>
<li><code>-XX:+PrintGCApplicationConcurrentTime</code>   打印每次垃圾回收前，程序未中断的执行时间。可与上面混合使用 <code>Application time: 0.5291524 seconds</code></li>
<li><code>-XX:+PrintGCApplicationStoppedTime</code><br>打印垃圾回收期间程序暂停的时间。可与上面混合使用 <code>Total time for which application threads were stopped: 0.0468229 seconds</code></li>
<li><code>-XX:+PrintHeapAtGC</code>:表示可以看到每次GC前后堆内存布局,打印GC前后的详细堆栈信息</li>
<li><code>-XX:+PrintTenuringDistribution</code>:打印存活实例年龄信息</li>
<li><code>-Xloggc:./gclog/gc.log</code>:与上面几个配合使用，把相关日志信息记录到文件以便分析。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">current=`date &#x27;+%s&#x27;`</span><br><span class="line">-Xloggc:./gclog/gc.log-$&#123;current&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>-XX:+UseGCLogFileRotation</code>  JVM 一个日志文件达到了20M以后，会生成新的，保留50个历史</li>
<li><code>-XX:GCLogFileSize=20M</code>  JVM 一个日志文件达到了20M以后，会生成新的，保留50个历史</li>
<li><code>-XX:NumberOfGCLogFiles=50 </code>  JVM 一个日志文件达到了20M以后，会生成新的，一共保存50个</li>
<li></li>
<li><code>-Xnoclassgc</code>  表示关闭JVM对类的垃圾回收</li>
<li><code>-XX:+DisableExplictGC </code> 禁用显示GC</li>
<li><code>-XX:+ExplictGCInvokesConcurrent</code>  使用并发方式处理显示GC</li>
<li><code>-verbose:gc</code> 输出虚拟机中GC的详细情况</li>
<li><code>-XX:+UseTLAB</code>  开启TLAB分配，优先在本地线程缓冲区TLAB中分配对象，避免分配内存时的锁定过程，Sever模式下默认开启。</li>
<li><code>-XX:TLABSize </code> 设置TLAB大小</li>
<li><code>-XX:+ResizeTLAB </code> 自动调整TLAB大小</li>
<li><code>-XX:+PrintTLAB</code>  表示可以看到TLAB的使用情况</li>
<li><code>-XX:+TraceClassLoading</code> 表示查看类的加载信息  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+TraceClassLoading FollowClass </span><br></pre></td></tr></table></figure></li>
<li><code>-XX:+TraceClassUnLoading</code>  表示查看类的卸载信息</li>
<li><code>-XX:CompileThreshold=1000</code>  表示一个方法被调用1000次之后，会被认为是热点代码，并触发即时编译</li>
<li><code>-XX:+UseSpining</code>  开启自旋锁</li>
<li><code>-XX:+PreBlockSpin</code>  更改自旋锁的自旋次数，使用这个参数必须先开启自旋锁。</li>
</ul>
<p>异常：</p>
<ul>
<li><code>-XX:+HeapDumpOnOutOfMemoryError</code>  表示可以让虚拟机在出现内存溢出异常时Dump出当前的堆内存转储快照</li>
<li><code>-XX:HeapDumpPath=./dump/</code></li>
</ul>
<h2 id="回收器选择"><a href="#回收器选择" class="headerlink" title="回收器选择"></a>回收器选择</h2><p><code>JVM</code>给了四种选择：</p>
<p>串行收集器、并行收集器、并发收集器、<code>G1</code></p>
<p>串行收集器只适用于小数据量的情况。默认情况下，<code>JDK5.0</code>以后，<code>JVM</code>会根据当前系统配置进行判断。</p>
<h3 id="吞吐量优先的并行收集器"><a href="#吞吐量优先的并行收集器" class="headerlink" title="吞吐量优先的并行收集器"></a>吞吐量优先的并行收集器</h3><p>并行收集器主要以到达一定的吞吐量为目标，适用于科学技术和后台处理等。<code>JDK1.8默认</code></p>
<p>典型配置：</p>
<ul>
<li><pre><code class="shell">java -Xmx8192m -Xms4096m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  此配置仅对年轻代有效。即上述配置下，年轻代使用并发收集，而年老代仍旧使用串行收集。</span><br><span class="line">  `-XX:ParallelGCThreads=20`  配置并行收集器的线程数，即：同时多少个线程一起进行垃圾回收。建议与处理器数目相等。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  java -Xmx8192m -Xms4096m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20 -XX:+UseParallelOldGC</span><br></pre></td></tr></table></figure>

`-XX:+UseParallelOldGC`  配置年老代垃圾收集方式为并行收集。JDK6.0支持对年老代并行收集。
</code></pre>
</li>
<li><p>&#96;&#96;&#96;shell<br>java -Xmx8192m -Xms4096m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:MaxGCPauseMillis&#x3D;100</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  `-XX:MaxGCPauseMillis=100`  设置每次年轻代垃圾回收的最长时间，如果无法满足此时间，`JVM` 会自动调整年轻代大小，以满足此值。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  java -Xmx8192m -Xms4096m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:MaxGCPauseMillis=100 -XX:+UseAdaptiveSizePolicy</span><br></pre></td></tr></table></figure>

<p><code>-XX:+UseAdaptiveSizePolicy</code>：设置此选项后，并行收集器会自动选择年轻代区大小和相应的Survivor区比例，以达到目标系统规定的最低相应时间或者收集频率等，此值建议使用并行收集器时，一直打开。</p>
</li>
</ul>
<h3 id="响应时间优先的并发收集器"><a href="#响应时间优先的并发收集器" class="headerlink" title="响应时间优先的并发收集器"></a>响应时间优先的并发收集器</h3><p>并发收集器主要是保证系统的响应时间，减少垃圾收集时的停顿时间。适用于应用服务器、电信领域等。</p>
<p>典型配置：</p>
<ul>
<li>&#96;&#96;&#96;shell<br>java -Xmx8192m -Xms4096m -Xmn2g -Xss128k -XX:ParallelGCThreads&#x3D;20 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ``-XX:+UseConcMarkSweepGC`：设置年老代为并发收集。测试中配置这个以后，-XX:NewRatio=4的配置失效了，原因不明。所以，此时年轻代大小最好用-Xmn设置。</span><br><span class="line">  `-XX:+UseParNewGC`:设置年轻代为并行收集。可与CMS收集同时使用。JDK5.0以上，JVM会根据系统配置自行设置，所以无需再设置此值。</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  java -Xmx8192m -Xms4096m -Xmn2g -Xss128k -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=5 -XX:+UseCMSCompactAtFullCollection</span><br></pre></td></tr></table></figure>

<code>-XX:CMSFullGCsBeforeCompaction</code>：由于并发收集器不对内存空间进行压缩、整理，所以运行一段时间以后会产生“碎片”，使得运行效率降低。此值设置运行多少次<code>GC</code>以后对内存空间进行压缩、整理。<br><code>-XX:+UseCMSCompactAtFullCollection</code>：打开对年老代的压缩。可能会影响性能，但是可以消除碎片</li>
</ul>
<h2 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h2><ol>
<li><p>年轻代大小选择</p>
<ul>
<li><code>响应时间优先的应用</code>：<code>尽可能设大，直到接近系统的最低响应时间限制</code>（根据实际情况选择）。在此种情况下，年轻代收集发生的频率也是最小的。同时，减少到达年老代的对象。</li>
<li><code>吞吐量优先的应用</code>：尽可能的设置大，可能到达Gbit的程度。因为对响应时间没有要求，垃圾收集可以并行进行，一般适合8CPU以上的应用。</li>
</ul>
</li>
<li><p>年老代大小选择</p>
<ul>
<li><p>响应时间优先的应用：年老代使用并发收集器，所以其大小需要小心设置，一般要考虑 并发会话率 和 会话持续时间</p>
<p>等一些参数。如果堆设置小了，可以会造成内存碎片、高回收频率以及应用暂停而使用传统的标记清除方式；如果堆大了，则需要较长的收集时间。最优化的方案，一般需要参考以下数据获得：</p>
<ul>
<li>并发垃圾收集信息</li>
<li>持久代并发收集次数</li>
<li>传统GC信息</li>
<li>花在年轻代和年老代回收上的时间比例</li>
</ul>
<p>减少年轻代和年老代花费的时间，一般会提高应用的效率</p>
</li>
<li><p><code>吞吐量优先的应用</code>：一般吞吐量优先的应用都有一个很大的年轻代和一个较小的年老代。原因是，这样可以尽可能回收掉大部分短期对象，减少中期的对象，而年老代尽存放长期存活对象。</p>
</li>
</ul>
</li>
<li><p>较小堆引起的碎片问题</p>
<p>因为年老代的并发收集器使用标 记、清除算法，所以不会对堆进行压缩。当收集器回收时，他会把相邻的空间进行合并，这样可以分配给较大的对象。但是，当堆空间较小时，运行一段时间以后，<br>就会出现“碎片”，如果并发收集器找不到足够的空间，那么并发收集器将会停止，然后使用传统的标记、清除方式进行回收。如果出现“碎片”，可能需要进行如 下配置：</p>
<ul>
<li><code>-XX:+UseCMSCompactAtFullCollection</code>：使用并发收集器时，开启对年老代的压缩。</li>
<li><code>-XX:CMSFullGCsBeforeCompaction=0</code>：上面配置开启的情况下，这里设置多少次Full GC后，对年老代进行压缩</li>
</ul>
</li>
</ol>
<h2 id="Java代码查询堆"><a href="#Java代码查询堆" class="headerlink" title="Java代码查询堆"></a>Java代码查询堆</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *在网上看到大部分的帖子都有介绍性能调优的案例，其中有一项就是告诉你 **`Xms`** 和 **`Xmx`** 参数一定要设置成相同的，这样就可以达到优化的目的，就像这样</span></span><br><span class="line"><span class="comment"> *-Xms1024m -Xmx1024m</span></span><br><span class="line"><span class="comment"> *但是却没说为什么要这么设置，那么这就是来告诉你这样设置的目的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XmxAndXms</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">XmxAndXms</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmxAndXms</span>();</span><br><span class="line">        <span class="comment">// 添加内存前先打印默认的堆内存情况</span></span><br><span class="line">        test.showHeapSpace();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始添加内存</span></span><br><span class="line">        test.addMemory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 展示堆空间大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showHeapSpace</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 每次增加对象时，totalMemory都会增大100倍</span></span><br><span class="line">        System.out.print(<span class="string">&quot;当前堆内存：&quot;</span> + Runtime.getRuntime().totalMemory() / <span class="number">1024</span> / <span class="number">1024</span> + <span class="string">&quot;M&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;，最大内存：&quot;</span> + Runtime.getRuntime().maxMemory() / <span class="number">1024</span> / <span class="number">1024</span> + <span class="string">&quot;M&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;，空闲内存：&quot;</span> + Runtime.getRuntime().freeMemory() / <span class="number">1024</span> / <span class="number">1024</span> + <span class="string">&quot;M&quot;</span>);</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每2秒钟往堆内存添加一个占用100m内存的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMemory</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">            System.out.print(<span class="string">&quot;第&quot;</span> + (j + <span class="number">1</span>) + <span class="string">&quot;次添加内存&quot;</span>);</span><br><span class="line">            <span class="comment">// 每2秒增加100M内存</span></span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>]);</span><br><span class="line">            <span class="comment">// 添加完后展示内存大小</span></span><br><span class="line">            <span class="built_in">this</span>.showHeapSpace();</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JVM-信息示例"><a href="#JVM-信息示例" class="headerlink" title="JVM 信息示例"></a><code>JVM</code> 信息示例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Non-default VM flags: </span><br><span class="line">-XX:-BytecodeVerificationLocal </span><br><span class="line">-XX:-BytecodeVerificationRemote </span><br><span class="line">-XX:CICompilerCount=4 </span><br><span class="line">-XX:InitialHeapSize=534773760 </span><br><span class="line">-XX:+ManagementServer </span><br><span class="line">-XX:MaxHeapSize=8589934592 </span><br><span class="line">-XX:MaxNewSize=2863136768 </span><br><span class="line">-XX:MinHeapDeltaBytes=524288 </span><br><span class="line">-XX:NewSize=178257920 </span><br><span class="line">-XX:OldSize=356515840 </span><br><span class="line">-XX:TieredStopAtLevel=1 </span><br><span class="line">-XX:+UseCompressedClassPointers </span><br><span class="line">-XX:+UseCompressedOops </span><br><span class="line">-XX:+UseFastUnorderedTimeStamps </span><br><span class="line">-XX:-UseLargePagesIndividualAllocation </span><br><span class="line">-XX:+UseParallelGC</span><br><span class="line">Command line:  -agentlib:jdwp=transport=dt_socket,address=127.0.0.1:57489,suspend=y,server=n </span><br><span class="line">-Dvisualvm.id=353982405207800 </span><br><span class="line">-Xmx8192m </span><br><span class="line">-Djava.rmi.server.hostname=192.168.2.1 </span><br><span class="line">-Dfile.encoding=utf-8 </span><br><span class="line">-Dcom.sun.management.jmxremote </span><br><span class="line">-Dcom.sun.management.jmxremote.port=50001 </span><br><span class="line">-Dcom.sun.management.jmxremote.rmi.port=50002 </span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=false </span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=maxzhao </span><br><span class="line">-XX:TieredStopAtLevel=1 </span><br><span class="line">-Xverify:none </span><br><span class="line">-Dspring.output.ansi.enabled=always </span><br><span class="line">-Dcom.sun.management.jmxremote </span><br><span class="line">-Dspring.jmx.enabled=true </span><br><span class="line">-Dspring.liveBeansView.mbeanDomain </span><br><span class="line">-Dspring.application.admin.enabled=true </span><br></pre></td></tr></table></figure>


<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/3c725d5d/">https://github.com/maxzhao-it/blog/post/3c725d5d/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/848e11b6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/848e11b6/" class="post-title-link" itemprop="url">Redis集群部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-28 17:42:25" itemprop="dateModified" datetime="2022-07-28T17:42:25+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/DevelopTools/" itemprop="url" rel="index"><span itemprop="name">DevelopTools</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/DevelopTools/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis集群模式"><a href="#Redis集群模式" class="headerlink" title="Redis集群模式"></a><code>Redis</code>集群模式</h1><p><code>Redis</code>有三种集群模式：</p>
<ol>
<li>主从模式：提高可用性，解决了单节点故障</li>
<li>哨兵（需要<code>Sentinel</code>）模式：在主从复制的基础上实现了主从切换和故障转移</li>
<li><code>Cluster</code>模式：是官方提供的集群模式，使用 <code>Sharding</code> 技术，实现了高可用、读写分离、分布式存储。</li>
</ol>
<blockquote>
<p>下载 <a target="_blank" rel="noopener" href="https://download.redis.io/redis-stable.tar.gz"><code>Redis source</code></a></p>
</blockquote>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="安装方式："><a href="#安装方式：" class="headerlink" title="安装方式："></a>安装方式：</h2><h3 id="1、完全离线安装"><a href="#1、完全离线安装" class="headerlink" title="1、完全离线安装"></a>1、完全离线安装</h3><h4 id="安装关键依赖-gcc、make"><a href="#安装关键依赖-gcc、make" class="headerlink" title="安装关键依赖 gcc、make"></a>安装关键依赖 <code>gcc</code>、<code>make</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接全部安装</span></span><br><span class="line">rpm -ivh *.rpm</span><br><span class="line"><span class="comment"># 全部安装报错时，使用下面的安装找出错误</span></span><br><span class="line">rpm -ivh kernel-headers-3.10.0-1160.el7.x86_64.rpm</span><br><span class="line">rpm -ivh glibc-common-2.17-324.el7_9.x86_64.rpm</span><br><span class="line">rpm -ivh glibc-headers-2.17-324.el7_9.x86_64.rpm</span><br><span class="line">rpm -ivh glibc-2.17-324.el7_9.x86_64.rpm</span><br><span class="line">rpm -ivh glibc-devel-2.17-324.el7_9.x86_64.rpm</span><br><span class="line">rpm -ivh make-3.82-24.el7.x86_64.rpm</span><br><span class="line">rpm -ivh binutils-2.27-44.base.el7.x86_64.rpm</span><br><span class="line">rpm -ivh libgcc-4.8.5-44.el7.x86_64.rpm</span><br><span class="line">rpm -ivh mpfr-3.1.1-4.el7.x86_64.rpm</span><br><span class="line">rpm -ivh libmpc-1.0.1-3.el7.x86_64.rpm</span><br><span class="line">rpm -ivh cpp-4.8.5-44.el7.x86_64.rpm</span><br><span class="line">rpm -ivh gcc-4.8.5-44.el7.x86_64.rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="编译-redis"><a href="#编译-redis" class="headerlink" title="编译 redis"></a>编译 <code>redis</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -zxvf redis-stable.tar.gz</span><br><span class="line">cd redis-stable</span><br><span class="line">make</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结束后</span></span><br><span class="line">make test</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装到 /usr/local/bin</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h4 id="下载依赖"><a href="#下载依赖" class="headerlink" title="下载依赖"></a>下载依赖</h4><p>下载依赖需要<strong>注意版本，依赖版本根据当前系统的版本号，特别是 <code>glibc</code></strong></p>
<blockquote>
<p>编译所需要的依赖  <a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/gcc-4.8.5-44.el7.x86_64.rpm"><code>gcc</code></a><br>、<a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/make-3.82-24.el7.x86_64.rpm"><code>make</code></a></p>
<p>下面是<code>gcc</code>依赖：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/cpp-4.8.5-44.el7.x86_64.rpm"><code>cpp</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/libgcc-4.8.5-44.el7.x86_64.rpm"><code>libgcc</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/updates/x86_64/Packages/glibc-2.17-324.el7_9.x86_64.rpm"><code>glibc</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/updates/x86_64/Packages/glibc-devel-2.17-324.el7_9.x86_64.rpm"><code>glibc-devel</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/updates/x86_64/Packages/glibc-headers-2.17-324.el7_9.x86_64.rpm"><code>glibc-headers</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/updates/x86_64/Packages/glibc-common-2.17-324.el7_9.x86_64.rpm"><code>glibc-common</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/kernel-headers-3.10.0-1160.el7.x86_64.rpm"><code>kernel-headers</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/mpfr-3.1.1-4.el7.x86_64.rpm"><code>libmpc</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/mpfr-3.1.1-4.el7.x86_64.rpm"><code>mpfr</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/binutils-2.27-44.base.el7.x86_64.rpm"><code>binutils</code></a></li>
<li><a target="_blank" rel="noopener" href="http://mirror.centos.org/centos/7/os/x86_64/Packages/make-3.82-24.el7.x86_64.rpm"><code>make</code></a></li>
</ul>
</blockquote>
<h3 id="2、联网设备安装"><a href="#2、联网设备安装" class="headerlink" title="2、联网设备安装"></a>2、联网设备安装</h3><ol>
<li><p><a href="#alibabaRepo">配置阿里云镜像</a></p>
</li>
<li><p>安装依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc make</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装 <code>Redis</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">wget https://download.redis.io/redis-stable.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -zxvf redis-stable.tar.gz</span><br><span class="line">cd redis-stable</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译</span></span><br><span class="line">make</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结束后</span></span><br><span class="line">make test</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3、rpm安装-不推荐"><a href="#3、rpm安装-不推荐" class="headerlink" title="3、rpm安装(不推荐)"></a>3、<code>rpm</code>安装(不推荐)</h3><p>联网安装可能会安装旧的版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置阿里云镜像</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="comment"># 配置阿里云 epel </span></span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"><span class="comment"># 安装redis</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line">yum install -y redis</span><br></pre></td></tr></table></figure>

<h3 id="4、-snap-安装"><a href="#4、-snap-安装" class="headerlink" title="4、 snap 安装"></a>4、 <code>snap</code> 安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum install snapd</span><br><span class="line">systemctl enable --now snapd.socket</span><br><span class="line">ln -s /var/lib/snapd/snap /snap</span><br><span class="line">snap install redis</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">bind * -::*                 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保护模式，不允许不认证连接</span></span><br><span class="line">protected-mode yes</span><br><span class="line"></span><br><span class="line">port 56379</span><br><span class="line">tcp-backlog 511</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">unixsocket /run/redis.sock</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">unixsocketperm 700</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Close the connection after a client is idle <span class="keyword">for</span> N seconds (0 to <span class="built_in">disable</span>)</span></span><br><span class="line">timeout 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ack 验证client 是否存活</span></span><br><span class="line">tcp-keepalive 300</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">守护进程运行</span></span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /opt/redis56379/redis_56379.pid</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志级别 debug verbose notice warning</span></span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/opt/redis56379/redis56379.log&quot;</span><br><span class="line"></span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line">always-show-logo no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用进程标题</span></span><br><span class="line">set-proc-title yes </span><br><span class="line">proc-title-template &quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&#123;port&#125;&quot;</span><br><span class="line"> </span><br><span class="line">dir /opt/redis56379/data/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码</span></span><br><span class="line">requirepass maxzhao </span><br></pre></td></tr></table></figure>

<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><h2 id="阿里云镜像"><a href="#阿里云镜像" class="headerlink" title="阿里云镜像"></a>阿里云镜像<span id="alibabaRepo"></span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置阿里云镜像</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置阿里云 epel</span> </span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>



<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/848e11b6/">https://github.com/maxzhao-it/blog/post/848e11b6/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://github.com/maxzhao-it/blog/post/ff3733f2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/images/avatar.jpg">
      <meta itemprop="name" content="赵联胜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="maxzhao">
      <meta itemprop="description" content="小码农赵联胜的博客,从遇到Java到爱上Java，工作之余学习Java生态圈中的各种技术。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | maxzhao">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/post/ff3733f2/" class="post-title-link" itemprop="url">SpringEvent事件机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-04 14:50:22" itemprop="dateModified" datetime="2022-07-04T14:50:22+08:00">2022-07-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Spring Event 机制使用起来比较简单。</p>
<ul>
<li>需要一个事件类</li>
<li>需要监听当前事件类</li>
<li>需要发布当前事件类的事件</li>
</ul>
<h3 id="简单了解一下"><a href="#简单了解一下" class="headerlink" title="简单了解一下"></a>简单了解一下</h3><p><code>ApplicationEventPublisher</code>用来发布事件，默认实现类 <code>AbstractApplicationContext</code>.</p>
<p><img src="/blog/(/uploads/images/image-20220401143619272.png" alt=" "></p>
<p>其中 <code>ApplicationEventPublisher</code>有两个 <code>publishEvent</code> 方法，在<code>Spring Context 4.2</code>之后就没有区别了。</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartSpringBootEventDemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(StartSpringBootEventDemoApplication.class);</span><br><span class="line">        application.run(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CommandLineRunner <span class="title function_">test</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            <span class="comment">/*发布事件*/</span></span><br><span class="line">            applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">CustomEvent</span>(<span class="number">11111</span>));</span><br><span class="line">            applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">CustomEvent2</span>(<span class="number">22222</span>));</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试自定义事件类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomEvent</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 标识</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CustomEvent</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;CustomEvent&#123;&quot;</span> + <span class="string">&quot;id=&quot;</span> + id + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试自定义事件类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomEvent2</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 标识</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CustomEvent2</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;CustomEvent2&#123;&quot;</span> + <span class="string">&quot;id=&quot;</span> + id + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@EventListener(value = CustomEvent.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener</span><span class="params">(CustomEvent customEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;listener=&gt;&quot;</span> + customEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener2</span><span class="params">(CustomEvent customEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;listener2=&gt;&quot;</span> + customEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener(value = CustomEvent2.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener3</span><span class="params">(CustomEvent2 customEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;listener3=&gt;&quot;</span> + customEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener4</span><span class="params">(CustomEvent2 customEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;listener4=&gt;&quot;</span> + customEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EventListener(value = &#123;CustomEvent.class, CustomEvent2.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener5</span><span class="params">(Object customEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;listener5=&gt;&quot;</span> + customEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面会输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listener=&gt;CustomEvent&#123;id=11111&#125;</span><br><span class="line">listener5=&gt;CustomEvent&#123;id=11111&#125;</span><br><span class="line">listener2=&gt;CustomEvent&#123;id=11111&#125;</span><br><span class="line">listener3=&gt;CustomEvent2&#123;id=22222&#125;</span><br><span class="line">listener5=&gt;CustomEvent2&#123;id=22222&#125;</span><br><span class="line">listener4=&gt;CustomEvent2&#123;id=22222&#125;</span><br></pre></td></tr></table></figure>

<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>本文地址： <a href="https://github.com/maxzhao-it/blog/post/ff3733f2/">https://github.com/maxzhao-it/blog/post/ff3733f2/</a> </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/8/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/blog/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/34/">34</a><a class="extend next" rel="next" href="/blog/page/10/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">赵联胜</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/blog/js/third-party/search/local-search.js"></script>




  <script src="/blog/js/third-party/pace.js"></script>

  





</body>
</html>
